{%- doc -%}
  @param {boolean} can_add_to_cart - Whether the product can be added to cart
  @param {object} product - The product object
  
  @example
  {% content_for 'block', type: 'notify-me-when-available', id: 'notify-me', can_add_to_cart: can_add_to_cart %}
{%- enddoc -%}

{% liquid
  assign product = closest.product
  if request.visual_preview_mode and product == blank
    assign product = collections.all.products.first
  endif
  
  assign variant = product.selected_or_first_available_variant
%}

<div
  class="notify-me-block"
  {{ block.shopify_attributes }}
  {% if can_add_to_cart %}
    hidden
  {% endif %}
>
  <dialog-component>
    <button
      on:click="/showDialog"
      class="button button--secondary notify-me-trigger"
      type="button"
    >
      {{ block.settings.button_text }}
    </button>

    <dialog
      ref="dialog"
      class="dialog-modal notify-me-modal color-{{ block.settings.color_scheme | default: settings.drawer_color_scheme }}"
      scroll-lock
      aria-labelledby="notify-me-heading-{{ block.id }}"
    >
      <button
        ref="closeButton"
        on:click="/closeDialog"
        class="button button-unstyled close-button notify-me-modal__close"
        aria-label="{{ 'actions.close_dialog' | t }}"
      >
        <span class="svg-wrapper">
          {{- 'icon-close.svg' | inline_asset_content -}}
        </span>
      </button>
      
      <div class="notify-me-modal__container">
        <div class="notify-me-modal__header">
          <div class="notify-me-modal__title-wrapper">
            <span class="notify-me-modal__icon">
              <span class="svg-wrapper">
                <svg width="38" height="38" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                  <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
              </span>
            </span>
            <h2 id="notify-me-heading-{{ block.id }}" class="notify-me-modal__title">
              {{ block.settings.modal_title }}
            </h2>
          </div>
          <p class="notify-me-modal__description">
            {{ block.settings.modal_description }}
          </p>
        </div>

        <div class="notify-me-modal__content">
          <p class="notify-me-modal__product-name">
            {{ product.title | upcase }}
            {% if variant.title != 'Default Title' %}
              - {{ variant.title }}
            {% endif %}
          </p>

          <notify-me-form class="notify-me-form">
            <form
              method="post"
              action="/contact#ContactFooter"
              accept-charset="UTF-8"
              class="notify-form"
            >
              <input type="hidden" name="form_type" value="customer">
              <input type="hidden" name="utf8" value="âœ“">
              <input type="hidden" name="contact[tags]" value="back-in-stock-notification">
              <input type="hidden" name="contact[product_id]" value="{{ product.id }}">
              <input type="hidden" name="contact[variant_id]" value="{{ variant.id }}">
              <input type="hidden" name="contact[product_title]" value="{{ product.title }}">
              <input type="hidden" name="contact[variant_title]" value="{{ variant.title }}">

              <div class="notify-form__field">
                <label for="notify-email-{{ block.id }}" class="visually-hidden">
                  {{ block.settings.email_label }}
                </label>
                <input
                  type="email"
                  id="notify-email-{{ block.id }}"
                  name="contact[email]"
                  placeholder="{{ block.settings.email_placeholder }}"
                  required
                  class="field__input"
                  aria-required="true"
                >
              </div>

              <button
                type="submit"
                class="button button--primary notify-form__submit"
              >
                {{ block.settings.submit_button_text }}
              </button>

              {% if block.settings.show_disclaimer %}
                <p class="notify-form__disclaimer">
                  {{ block.settings.disclaimer_text }}
                </p>
              {% endif %}

              <div class="notify-form__message" hidden>
                <p class="notify-form__success">
                  {{ block.settings.success_message }}
                </p>
              </div>
            </form>

            {% if block.settings.show_powered_by %}
              <p class="notify-form__powered-by">
                {{ block.settings.powered_by_text }}
              </p>
            {% endif %}
          </notify-me-form>
        </div>
      </div>
    </dialog>
  </dialog-component>
</div>

<script src="{{ 'dialog.js' | asset_url }}" type="module"></script>

{% stylesheet %}
  .notify-me-block {
    width: 100%;
  }

  .notify-me-trigger {
    width: 100%;
    background: var(--color-foreground);
    color: var(--color-background);
    border: 2px solid var(--color-foreground);
    padding: 14px 24px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .notify-me-trigger:hover {
    background: var(--color-background);
    color: var(--color-foreground);
  }

  .notify-me-modal {
    max-width: 460px;
    padding: 0;
    border: none;
    border-radius: 8px;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
    overflow: hidden;
  }

  .notify-me-modal[open] {
    display: block;
  }

  .notify-me-modal::backdrop {
    background: rgba(0, 0, 0, 0.6);
  }

  .notify-me-modal__container {
    padding: 32px 24px 24px;
    position: relative;
    text-align: left;
  }

  .notify-me-modal .notify-me-modal__close {
    position: absolute !important;
    top: 12px !important;
    right: 12px !important;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin: 0;
    cursor: pointer;
    background: transparent;
    border: none;
    color: var(--color-foreground);
    z-index: 10;
  }

  .notify-me-modal .notify-me-modal__close:hover {
    opacity: 0.7;
  }

  .notify-me-modal .notify-me-modal__close .svg-wrapper {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .notify-me-modal .notify-me-modal__close svg {
    width: 100%;
    height: 100%;
  }

  .notify-me-modal__header {
    margin-bottom: 24px;
    padding-right: 40px;
  }

  .notify-me-modal__title-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .notify-me-modal__icon {
    flex-shrink: 0;
  }

  .notify-me-modal__icon .svg-wrapper {
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .notify-me-modal__title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    line-height: 1.3;
    text-align: left;
  }

  .notify-me-modal__description {
    font-size: 0.9375rem;
    color: var(--color-foreground-secondary, rgba(0, 0, 0, 0.7));
    margin: 0;
    line-height: 1.5;
    text-align: left;
  }

  .notify-me-modal__product-name {
    font-weight: 600;
    margin: 0 0 20px;
    text-align: left;
    font-size: 0.9375rem;
  }

  .notify-form__field {
    margin-bottom: 12px;
  }

  .notify-form__field .field__input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
  }

  .notify-form__field .field__input:focus {
    outline: none;
    border-color: var(--color-foreground);
    box-shadow: 0 0 0 1px var(--color-foreground);
  }

  .notify-form__disclaimer {
    font-size: 0.75rem;
    color: var(--color-foreground-secondary, rgba(0, 0, 0, 0.6));
    margin: 12px 0 0;
    line-height: 1.4;
  }

  .notify-form__submit {
    width: 100%;
    padding: 14px 24px;
    background: var(--color-foreground);
    color: var(--color-background);
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .notify-form__submit:hover {
    opacity: 0.9;
  }

  .notify-form__message {
    margin-top: 16px;
    padding: 12px;
    background: #e8f5e9;
    border-radius: 4px;
  }

  .notify-form__success {
    margin: 0;
    color: #2e7d32;
    font-size: 0.9375rem;
  }

  .notify-form__powered-by {
    text-align: center;
    font-size: 0.75rem;
    color: var(--color-foreground-secondary, rgba(0, 0, 0, 0.5));
    margin: 12px 0 0;
  }

  /* Mobile responsiveness */
  @media (max-width: 749px) {
    .notify-me-modal {
      max-width: calc(100vw - 32px);
    }

    .notify-me-modal__container {
      padding: 24px 16px 20px;
    }

    .notify-me-modal__title {
      font-size: 1.25rem;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Notify When Available",
  "settings": [
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Notify me when available"
    },
    {
      "type": "header",
      "content": "Modal Settings"
    },
    {
      "type": "text",
      "id": "modal_title",
      "label": "Modal Title",
      "default": "Notify me"
    },
    {
      "type": "textarea",
      "id": "modal_description",
      "label": "Modal Description",
      "default": "Don't miss out! Register your email address below to receive an alert when this product is back in stock."
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Form Settings"
    },
    {
      "type": "text",
      "id": "email_label",
      "label": "Email Label",
      "default": "Email address"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Placeholder",
      "default": "Email address"
    },
    {
      "type": "text",
      "id": "submit_button_text",
      "label": "Submit Button Text",
      "default": "Notify me when available!"
    },
    {
      "type": "checkbox",
      "id": "show_disclaimer",
      "label": "Show Disclaimer",
      "default": true
    },
    {
      "type": "textarea",
      "id": "disclaimer_text",
      "label": "Disclaimer Text",
      "default": "Promise we won't spam. You'll only receive notifications for this product."
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "Thank you! We'll notify you when this product is back in stock."
    },
    {
      "type": "checkbox",
      "id": "show_powered_by",
      "label": "Show 'Powered By' Text",
      "default": true
    },
    {
      "type": "text",
      "id": "powered_by_text",
      "label": "Powered By Text",
      "default": "Powered by STOQ"
    }
  ],
  "presets": [
    {
      "name": "Notify When Available",
      "category": "Product"
    }
  ]
}
{% endschema %}
