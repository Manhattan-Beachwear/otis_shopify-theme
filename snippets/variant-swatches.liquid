{%- doc -%}
  Renders a swatches variant picker, used within the product-swatches block.

  @param {object} product_resource - The product object, which contains variants and options.
  @param {boolean} [has_option_selected] - Whether an option is already selected.

  @example
  {% render 'variant-swatches', product_resource: product %}
{%- enddoc -%}

<swatches-variant-picker-component
  data-product-id="{{ product_resource.id }}"
  data-product-url="{{ product_resource.url }}"
  ref="swatchesVariantPicker"
>
  <form>
    {%- for product_option in product_resource.options_with_values -%}
      {%- liquid
        assign swatch_count = product_option.values | map: 'swatch' | compact | size
        
        # Check if any option values have assets folder files (for backup swatch feature)
        assign assets_swatch_count = 0
        assign enable_backup_check = settings.enable_swatch_assets_backup
        if enable_backup_check == blank
          assign enable_backup_check = true
        endif
        
        if enable_backup_check
          for product_option_value in product_option.values
            if product_option_value.name != blank
              assign swatch_file_extension = settings.swatch_file_extension | default: 'png'
              assign color_file_name = product_option_value.name | handle | append: '.' | append: swatch_file_extension
              if images[color_file_name] != blank
                assign assets_swatch_count = assets_swatch_count | plus: 1
              endif
            endif
          endfor
        endif
        
        # Use swatches if we have metaobject swatches OR assets folder swatches
        assign total_swatch_count = swatch_count | plus: assets_swatch_count
      -%}

      {% if total_swatch_count == 0 %}
        {% continue %}
      {% endif %}

      {%- liquid
        assign product_has_combined_listing = closest.product.options_with_values | map: 'values' | map: 'product_url' | compact | size

        # Only apply our custom logic if nothing is selected (initial page load)
        if has_option_selected != true and product_has_combined_listing == 0
          # Logic to determine which swatch should be pre-selected
          assign first_image = product_resource.media.first
          assign variant_images = product_resource.images | where: 'attached_to_variant?', true
          assign swatch_to_preselect = null
          if swatch_count == 1
            # Single swatch: Always pre-select it
            assign swatch_to_preselect = product_option.values.first
          elsif swatch_count > 1
            if first_image and variant_images contains first_image
              # First image is a variant image - find which variant it belongs to
              for option_value in product_option.values
                if option_value.variant.featured_media.id == first_image.id
                  assign swatch_to_preselect = option_value
                  break
                endif
              endfor
            elsif variant_images.size == 0
              # No variants have images - pre-select first swatch
              assign swatch_to_preselect = product_option.values.first
            else
              assign none_checked = true
            endif
            # else: First image is NOT a variant image - don't pre-select any swatch
          endif
        endif

        for value in product_resource.selected_variant.options
          if value.swatch
            assign swatch_to_preselect = value
          endif
        endfor

        # Identify which option position this swatch option is
        # Use product_option.position which is the actual position among ALL options
        assign swatch_option_position = product_option.position
        assign swatch_option_key = 'option' | append: swatch_option_position
      -%}

      <fieldset class="variant-option variant-option--buttons variant-option--swatches">
        {% capture children %}
          {%- for product_option_value in product_option.values -%}
            {%- liquid
              # Skip option values that are blank, null, 0 (number), "0" (string), or "null" (string)
              assign option_value_str = product_option_value | append: ''
              assign should_skip = false
              if product_option_value == blank or product_option_value == 0 or option_value_str == '' or option_value_str == '0' or option_value_str == 'null'
                assign should_skip = true
              endif
            -%}
            {%- unless should_skip -%}
            {% liquid
              # We look for the right featured media to show when hovering/clicking on the swatch.
              # Most of the time there should be an image associated to the option-value.
              assign featured_media = product_option_value.variant.featured_media

              # If the option is available, the swatch should be shown as available.
              assign available_count = 0
              if product_option.available
                assign available_count = 1
              endif

              if featured_media == blank
                if product_option_value.variant == blank
                  # It could happen that the particular product_option_value.variant is nil
                  # (see https://shopify.dev/docs/api/liquid/objects/product_option_value#product_option_value-variant).
                  # We look for the first available variant in that option (e.g. Color) that has a featured media.
                  for variant in product_resource.variants
                    if variant.available and variant[swatch_option_key] == product_option_value.name and variant.featured_media
                      assign featured_media = variant.featured_media
                      assign first_available_variant = variant
                      break
                    endif
                  endfor
                elsif product_option_value.product_url
                  # If the variant has no featured media, and we have a combined listing product,
                  # then fall back to using the featured media of the child product that is linked
                  # to this option value.
                  assign featured_media = product_option_value.variant.product.featured_media
                endif
              endif

              if has_option_selected != true and product_has_combined_listing == 0
                # Determine if this swatch should be checked
                assign is_checked = false
                if swatch_to_preselect != nil and swatch_to_preselect.id == product_option_value.id
                  assign is_checked = true
                  assign none_checked = false
                endif
              endif
            %}

            <li class="variant-option__swatch">
              <label
                data-media-id="{{ featured_media.id }}"
                data-option-available="{{ product_option_value.available }}"
                {% if featured_media != blank and featured_media.preview_image != blank %}
                  data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                {% endif %}
                class="variant-option__button-label variant-option__button-label--has-swatch swatch-rounded"
                on:pointerenter="product-card/previewVariant/{{ featured_media.id }}"
                on:pointerleave="product-card/resetVariant"
              >
                <input
                  type="radio"
                  name="{{ product_option.name | escape }}-{{ product_resource.id }}-swatch"
                  value="{{ product_option_value | escape }}"
                  aria-label="{{ product_option_value.name }}"
                  data-input-id="{{ product_option.position }}-{{ forloop.index0 }}"
                  data-option-media-id="{{ featured_media.id }}"
                  data-option-value-id="{{ product_option_value.id }}"
                  data-option-available="{{ product_option_value.available }}"
                  data-connected-product-url="{{ product_option_value.product_url }}"
                  {% if featured_media != blank and featured_media.preview_image != blank %}
                    data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                  {% endif %}
                  {% if none_checked != true %}
                    {% if product_option_value.selected or is_checked == true %}
                      checked
                    {% endif %}
                  {% endif %}
                  data-available-count="{{ available_count }}"
                  data-variant-id="{{ first_available_variant.id | default: product_option_value.variant.id }}"
                  data-first-available-or-first-variant-id="{{ first_available_variant.id | default: product_option_value.variant.id }}"
                >
                {% render 'swatch',
                  swatch: product_option_value.swatch,
                  variant_image: featured_media,
                  option_value_name: product_option_value.name
                %}
                {% render 'strikethrough-variant', product_option: product_option_value %}
              </label>
            </li>
            {%- endunless -%}
          {%- endfor -%}
          <li
            slot="more"
          >
            <button
              class="hidden-swatches__count"
              aria-label="{{ 'actions.show_all_options' | t }}"
              on:click="/showAllSwatches"
            ></button>
          </li>
        {% endcapture %}

        {% render 'overflow-list', children: children, ref: 'overflowList', defer: true %}
      </fieldset>
    {%- endfor -%}
    <script type="application/json">
      {{ product_resource.selected_or_first_available_variant | json }}
    </script>
  </form>
</swatches-variant-picker-component>
