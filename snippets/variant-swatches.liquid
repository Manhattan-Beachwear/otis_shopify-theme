{%- doc -%}
  Renders a swatches variant picker, used within the product-swatches block.

  @param {object} product_resource - The product object, which contains variants and options.
  @param {object} [block] - The block object with settings (optional).
  @param {boolean} [has_option_selected] - Whether an option is already selected.

  @example
  {% render 'variant-swatches', product_resource: product %}
  {% render 'variant-swatches', product_resource: product, block: block %}
{%- enddoc -%}

{%- liquid
  # Resolve all product image swatch settings with priority: block → section → global
  assign show_product_image_swatches = false
  if block != blank and block.settings != blank and block.settings.show_product_image_swatches
    assign show_product_image_swatches = true
  elsif section != blank and section.settings != blank and section.settings.show_product_image_swatches
    assign show_product_image_swatches = true
  elsif settings.show_product_image_swatches
    assign show_product_image_swatches = true
  endif
  
  assign product_image_swatch_style = 'circle'
  if block != blank and block.settings != blank and block.settings.product_image_swatch_style != blank
    assign product_image_swatch_style = block.settings.product_image_swatch_style
  elsif section != blank and section.settings != blank and section.settings.product_image_swatch_style != blank
    assign product_image_swatch_style = section.settings.product_image_swatch_style
  elsif settings.product_image_swatch_style != blank
    assign product_image_swatch_style = settings.product_image_swatch_style
  endif
  
  assign product_image_swatch_size = blank
  if block != blank and block.settings != blank and block.settings.product_image_swatch_size != blank
    assign product_image_swatch_size = block.settings.product_image_swatch_size
  elsif section != blank and section.settings != blank and section.settings.product_image_swatch_size != blank
    assign product_image_swatch_size = section.settings.product_image_swatch_size
  elsif settings.product_image_swatch_size != blank
    assign product_image_swatch_size = settings.product_image_swatch_size
  endif
  
  assign show_horizontal_scroll = false
  if block != blank and block.settings != blank and block.settings.show_horizontal_scroll
    assign show_horizontal_scroll = true
  elsif section != blank and section.settings != blank and section.settings.show_horizontal_scroll
    assign show_horizontal_scroll = true
  elsif settings.show_horizontal_scroll
    assign show_horizontal_scroll = true
  endif
-%}

<swatches-variant-picker-component
  class="{% if show_product_image_swatches and show_horizontal_scroll %}variant-option--horizontal-scroll{% endif %}"
  data-product-id="{{ product_resource.id }}"
  data-product-url="{{ product_resource.url }}"
  data-horizontal-scroll="{{ show_horizontal_scroll }}"
  style="--product-image-swatch-size: {{ product_image_swatch_size | default: 60 }}px;"
  ref="swatchesVariantPicker"
>
  <form>
    {%- for product_option in product_resource.options_with_values -%}
      {%- liquid
        assign swatch_count = product_option.values | map: 'swatch' | compact | size
        
        # Check if any option values have assets folder files (for backup swatch feature)
        assign assets_swatch_count = 0
        assign enable_backup_check = settings.enable_swatch_assets_backup
        if enable_backup_check == blank
          assign enable_backup_check = true
        endif
        
        if enable_backup_check
          for product_option_value in product_option.values
            if product_option_value.name != blank
              assign swatch_file_extension = settings.swatch_file_extension | default: 'png'
              assign color_file_name = product_option_value.name | handle | append: '.' | append: swatch_file_extension
              if images[color_file_name] != blank
                assign assets_swatch_count = assets_swatch_count | plus: 1
              endif
            endif
          endfor
        endif
        
        # Use swatches if we have metaobject swatches OR assets folder swatches
        assign total_swatch_count = swatch_count | plus: assets_swatch_count
      -%}

      {%- comment -%} Skip only when no swatch data AND single value (nothing to choose). When multiple values but no swatch data, render using variant image fallback. {% endcomment -%}
      {% if total_swatch_count == 0 and product_option.values.size <= 1 %}
        {% continue %}
      {% endif %}

      {%- liquid
        assign product_has_combined_listing = closest.product.options_with_values | map: 'values' | map: 'product_url' | compact | size

        # Only apply our custom logic if nothing is selected (initial page load)
        if has_option_selected != true and product_has_combined_listing == 0
          # Logic to determine which swatch should be pre-selected
          assign first_image = product_resource.media.first
          assign variant_images = product_resource.images | where: 'attached_to_variant?', true
          assign swatch_to_preselect = null
          if swatch_count == 1
            # Single swatch: Always pre-select it
            assign swatch_to_preselect = product_option.values.first
          elsif swatch_count > 1
            if first_image and variant_images contains first_image
              # First image is a variant image - find which variant it belongs to
              for option_value in product_option.values
                if option_value.variant.featured_media.id == first_image.id
                  assign swatch_to_preselect = option_value
                  break
                endif
              endfor
            elsif variant_images.size == 0
              # No variants have images - pre-select first swatch
              assign swatch_to_preselect = product_option.values.first
            else
              assign none_checked = true
            endif
            # else: First image is NOT a variant image - don't pre-select any swatch
          endif
        endif

        for value in product_resource.selected_variant.options
          if value.swatch
            assign swatch_to_preselect = value
          endif
        endfor

        # Identify which option position this swatch option is
        # Use product_option.position which is the actual position among ALL options
        assign swatch_option_position = product_option.position
        assign swatch_option_key = 'option' | append: swatch_option_position
      -%}

      <fieldset class="variant-option variant-option--buttons variant-option--swatches">
        {% capture children %}
          {%- for product_option_value in product_option.values -%}
            {%- liquid
              # Skip option values that are blank, null, 0 (number), "0" (string), or "null" (string)
              assign option_value_str = product_option_value | append: ''
              assign should_skip = false
              if product_option_value == blank or product_option_value == 0 or option_value_str == '' or option_value_str == '0' or option_value_str == 'null'
                assign should_skip = true
              endif
            -%}
            {%- unless should_skip -%}
            {% liquid
              # We look for the right featured media to show when hovering/clicking on the swatch.
              # Most of the time there should be an image associated to the option-value.
              assign featured_media = product_option_value.variant.featured_media

              # If the option is available, the swatch should be shown as available.
              assign available_count = 0
              if product_option.available
                assign available_count = 1
              endif

              if featured_media == blank
                if product_option_value.variant == blank
                  # It could happen that the particular product_option_value.variant is nil
                  # (see https://shopify.dev/docs/api/liquid/objects/product_option_value#product_option_value-variant).
                  # We look for the first available variant in that option (e.g. Color) that has a featured media.
                  for variant in product_resource.variants
                    if variant.available and variant[swatch_option_key] == product_option_value.name and variant.featured_media
                      assign featured_media = variant.featured_media
                      assign first_available_variant = variant
                      break
                    endif
                  endfor
                elsif product_option_value.product_url
                  # If the variant has no featured media, and we have a combined listing product,
                  # then fall back to using the featured media of the child product that is linked
                  # to this option value.
                  assign featured_media = product_option_value.variant.product.featured_media
                endif
              endif

              if has_option_selected != true and product_has_combined_listing == 0
                # Determine if this swatch should be checked
                assign is_checked = false
                if swatch_to_preselect != nil and swatch_to_preselect.id == product_option_value.id
                  assign is_checked = true
                  assign none_checked = false
                endif
              endif
            %}
            {%- comment -%} When using product image as swatch, don't show the swatch if the variant has no image. {%- endcomment -%}
            {% if show_product_image_swatches or total_swatch_count == 0 %}
              {% if featured_media == blank %}
                {% continue %}
              {% endif %}
            {% endif %}
            <li class="variant-option__swatch">
              <label
                data-media-id="{{ featured_media.id }}"
                data-option-available="{{ product_option_value.available }}"
                {% if featured_media != blank and featured_media.preview_image != blank %}
                  data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                {% endif %}
                class="variant-option__button-label variant-option__button-label--has-swatch {% if show_product_image_swatches or total_swatch_count == 0 %}variant-option__button-label--product-image variant-option__button-label--product-image-{{ product_image_swatch_style }}{% else %}swatch-rounded{% endif %}"
                on:pointerenter="product-card/previewVariant/{{ featured_media.id }}"
                on:pointerleave="product-card/resetVariant"
              >
                <input
                  type="radio"
                  name="{{ product_option.name | escape }}-{{ product_resource.id }}-swatch"
                  value="{{ product_option_value | escape }}"
                  aria-label="{{ product_option_value.name }}"
                  data-input-id="{{ product_option.position }}-{{ forloop.index0 }}"
                  data-option-media-id="{{ featured_media.id }}"
                  data-option-value-id="{{ product_option_value.id }}"
                  data-option-available="{{ product_option_value.available }}"
                  data-connected-product-url="{{ product_option_value.product_url }}"
                  data-variant-name="{{ product_option_value.name | escape }}"
                  {% if featured_media != blank and featured_media.preview_image != blank %}
                    data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                  {% endif %}
                  {% if none_checked != true %}
                    {% if product_option_value.selected or is_checked == true %}
                      checked
                    {% endif %}
                  {% endif %}
                  data-available-count="{{ available_count }}"
                  data-variant-id="{{ first_available_variant.id | default: product_option_value.variant.id }}"
                  data-first-available-or-first-variant-id="{{ first_available_variant.id | default: product_option_value.variant.id }}"
                >
                {%- if show_product_image_swatches or total_swatch_count == 0 -%}
                  {%- comment -%} Force use variant image as swatch (product image swatches setting, or fallback when no swatch data but multiple values) {%- endcomment -%}
                  {% render 'swatch',
                    swatch: blank,
                    variant_image: featured_media,
                    option_value_name: product_option_value.name,
                    force_image_swatch: true
                  %}
                {%- else -%}
                  {% render 'swatch',
                    swatch: product_option_value.swatch,
                    variant_image: featured_media,
                    option_value_name: product_option_value.name
                  %}
                {%- endif -%}
                {% render 'strikethrough-variant', product_option: product_option_value %}
              </label>
            </li>
            {%- endunless -%}
          {%- endfor -%}
          <li
            slot="more"
          >
            <button
              class="hidden-swatches__count"
              aria-label="{{ 'actions.show_all_options' | t }}"
              on:click="/showAllSwatches"
            ></button>
          </li>
        {% endcapture %}

        {% if show_horizontal_scroll %}
          {% render 'overflow-list', children: children, ref: 'overflowList', defer: true, class: 'variant-option--horizontal-scroll' %}
        {% else %}
          {% render 'overflow-list', children: children, ref: 'overflowList', defer: true %}
        {% endif %}
      </fieldset>
    {%- endfor -%}
    <script type="application/json">
      {{ product_resource.selected_or_first_available_variant | json }}
    </script>
  </form>
</swatches-variant-picker-component>

{% stylesheet %}
  .variant-option__button-label--product-image {
    width: var(--product-image-swatch-size, 60px);
    height: var(--product-image-swatch-size, 60px);
    padding: 0;
    border: none;
    border-radius: 0;
    overflow: hidden;
    background: transparent;
  }

  .variant-option__button-label--product-image .swatch {
    width: 100%;
    height: 100%;
    border-radius: 0;
    background-color: transparent;
    background-size: contain !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
  }

  .variant-option__button-label--product-image .swatch__image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .variant-option__current-variant-name {
    display: block;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-align: center;
    color: rgb(var(--color-foreground));
    line-height: 1.2;
    min-height: 1.2em;
  }

  .variant-option__button-label--product-image-circle {
    border-radius: 0;
  }

  .variant-option__button-label--product-image-circle .swatch {
    border-radius: 0;
  }

  .variant-option__button-label--product-image-square {
    border-radius: 0;
  }

  .variant-option__button-label--product-image-square .swatch {
    border-radius: 0;
  }

  /* Selected state */
  .variant-option__button-label--product-image:has(:checked) {
    border: var(--variant-picker-border-width, var(--style-border-swatch-width, 1px)) var(--variant-picker-border-style, var(--style-border-swatch-style, solid)) var(--color-foreground);
    border-radius: 0;
    outline: none !important;
    box-shadow: none !important;
  }

  /* Remove all outlines on focus, hover, active */
  .variant-option__button-label--product-image:hover,
  .variant-option__button-label--product-image:focus,
  .variant-option__button-label--product-image:focus-visible,
  .variant-option__button-label--product-image:active {
    outline: none !important;
    box-shadow: none !important;
  }

  .variant-option__button-label--product-image input:focus,
  .variant-option__button-label--product-image input:focus-visible {
    outline: none !important;
    box-shadow: none !important;
  }

  .variant-option__button-label--product-image-circle:has(:checked) {
    border-radius: 0;
  }

  .variant-option__button-label--product-image-square:has(:checked) {
    border-radius: 0;
  }

  /* Reduce spacing */
  product-swatches:has(.variant-option__button-label--product-image) .variant-option--swatches {
    gap: 8px;
    overflow: visible !important;
  }

  /* Horizontal scroll enabled */
  .variant-option--horizontal-scroll overflow-list {
    width: 100%;
    max-width: 100%;
  }

  .variant-option--horizontal-scroll overflow-list::part(list) {
    display: flex !important;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    -webkit-overflow-scrolling: touch;
    gap: 8px;
    /* Bottom padding for scrollbar */
    padding-bottom: calc(2px + var(--variant-picker-border-width, 1px) + 4px);
    scrollbar-color: auto !important;
  }

  /* Ensure swatch labels account for top border space */
  .variant-option--horizontal-scroll .variant-option__button-label--product-image {
    margin-top: calc(var(--variant-picker-border-width, 1px) + 1px);
  }

  .variant-option--horizontal-scroll overflow-list::part(list)::-webkit-scrollbar {
    height: 2px !important;
  }

  .variant-option--horizontal-scroll overflow-list::part(list)::-webkit-scrollbar-button {
    display: none !important;
  }

  .variant-option--horizontal-scroll overflow-list::part(list)::-webkit-scrollbar-track {
    background-color: transparent !important;
  }

  .variant-option--horizontal-scroll overflow-list::part(list)::-webkit-scrollbar-thumb {
    background-color: rgb(var(--color-foreground-rgb) / var(--opacity-70)) !important;
    border-radius: 9999px !important;
  }

  .variant-option--horizontal-scroll overflow-list::part(list)::-webkit-scrollbar-thumb:hover {
    background-color: rgb(var(--color-foreground-rgb) / var(--opacity-90)) !important;
  }

  /* Hide +more button when horizontal scroll is enabled */
  .variant-option--horizontal-scroll .hidden-swatches__count {
    display: none !important;
  }
{% endstylesheet %}
