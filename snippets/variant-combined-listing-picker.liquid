{%- doc -%}
  This is a custom file that enables the combined listing variant picker that displays each related product as a single variant option.

  To use this file, you need to add the combined listings metafield to the product that contains the related products.

  Renders a combined listing variant picker that displays each related product as a single variant option.

  @param {object} product_resource - The product object.
  @param {object} [block] - The block object with settings (optional)
  
  Settings (from block.settings or global settings):
  - show_size_swatches {boolean} - Show size swatches when dual picker mode is enabled (default: false)
  - show_swatch_text_labels {boolean} - Show text labels for swatches (default: false)
  - enable_swatch_assets_backup {boolean} - Enable assets folder backup for swatches (passed to swatch component)
  - swatch_file_extension {string} - Swatch file extension (passed to swatch component)
  - show_variant_image {boolean} - Show variant image fallback (passed to swatch component)
  - variant_swatch_width {number} - Variant swatch width (passed to swatch component)
{%- enddoc -%}
{% liquid
  # Handle blank block (for sections that don't use blocks)
  if block != blank
    assign block_settings = block.settings
  else
    # block_settings will be blank, we'll handle defaults inline where needed
    assign block_settings = blank
  endif
  
  # Set default alignment if not provided
  assign alignment_default = 'left'
  if block_settings != blank and block_settings.alignment != blank
    assign alignment_value = block_settings.alignment
  else
    assign alignment_value = alignment_default
  endif
  
  # Get variant_style setting (priority: block settings > global settings)
  assign variant_style_setting = 'buttons'
  if block != blank and block_settings != blank and block_settings.variant_style != blank
    assign variant_style_setting = block_settings.variant_style
  elsif settings.variant_style != blank
    assign variant_style_setting = settings.variant_style
  endif
  
  # Get show_swatches setting (priority: block settings > global settings)
  # Use block_settings.show_swatches directly like variant-main-picker.liquid does
  # Checkbox: true when checked, false when unchecked
  # Default to true if not set (schema default is true)
  assign show_swatches_setting = true
  if block != blank and block_settings != blank and block_settings.show_swatches != blank
    assign show_swatches_setting = block_settings.show_swatches
  elsif settings.show_swatches != blank
    assign show_swatches_setting = settings.show_swatches
  endif
  
  # Get show_size_swatches setting (priority: block settings > global settings)
  assign show_size_swatches_setting = false
  if block != blank and block_settings != blank and block_settings.show_size_swatches
    assign show_size_swatches_setting = true
  elsif settings.show_size_swatches
    assign show_size_swatches_setting = true
  endif
  
  # Get show_swatch_text_labels setting (priority: block settings > global settings)
  assign show_swatch_text_labels_setting = false
  if block != blank and block_settings != blank and block_settings.show_swatch_text_labels
    assign show_swatch_text_labels_setting = true
  elsif settings.show_swatch_text_labels
    assign show_swatch_text_labels_setting = true
  endif
  
  assign show_product_image_swatches = false
  if block != blank and block_settings != blank and block_settings.show_product_image_swatches
    assign show_product_image_swatches = true
  elsif section != blank and section.settings != blank and section.settings.show_product_image_swatches
    assign show_product_image_swatches = true
  elsif settings.show_product_image_swatches
    assign show_product_image_swatches = true
  endif
  
  assign product_image_swatch_style = 'circle'
  if block != blank and block_settings != blank and block_settings.product_image_swatch_style != blank
    assign product_image_swatch_style = block_settings.product_image_swatch_style
  elsif section != blank and section.settings != blank and section.settings.product_image_swatch_style != blank
    assign product_image_swatch_style = section.settings.product_image_swatch_style
  elsif settings.product_image_swatch_style != blank
    assign product_image_swatch_style = settings.product_image_swatch_style
  endif
  
  assign show_horizontal_scroll = false
  if block != blank and block_settings != blank and block_settings.show_horizontal_scroll
    assign show_horizontal_scroll = true
  elsif section != blank and section.settings != blank and section.settings.show_horizontal_scroll
    assign show_horizontal_scroll = true
  elsif settings.show_horizontal_scroll
    assign show_horizontal_scroll = true
  endif
  
  if block != blank and block_settings != blank and block_settings.product_image_swatch_size != blank
    assign product_image_swatch_size = block_settings.product_image_swatch_size
  elsif section != blank and section.settings != blank and section.settings.product_image_swatch_size != blank
    assign product_image_swatch_size = section.settings.product_image_swatch_size
  elsif settings.product_image_swatch_size != blank
    assign product_image_swatch_size = settings.product_image_swatch_size
  endif
  
  # Get swatch-related settings to pass to swatch component (priority: block settings > global settings)
  assign swatch_enable_assets_backup = blank
  if block != blank and block_settings != blank and block_settings.enable_swatch_assets_backup != blank
    assign swatch_enable_assets_backup = block_settings.enable_swatch_assets_backup
  elsif settings.enable_swatch_assets_backup != blank
    assign swatch_enable_assets_backup = settings.enable_swatch_assets_backup
  endif
  
  assign swatch_file_extension_setting = blank
  if block != blank and block_settings != blank and block_settings.swatch_file_extension != blank
    assign swatch_file_extension_setting = block_settings.swatch_file_extension
  elsif settings.swatch_file_extension != blank
    assign swatch_file_extension_setting = settings.swatch_file_extension
  endif
  
  assign swatch_show_variant_image = blank
  if block != blank and block_settings != blank and block_settings.show_variant_image != blank
    assign swatch_show_variant_image = block_settings.show_variant_image
  elsif settings.show_variant_image != blank
    assign swatch_show_variant_image = settings.show_variant_image
  endif
  
  assign swatch_variant_width = blank
  if block != blank and block_settings != blank and block_settings.variant_swatch_width != blank
    assign swatch_variant_width = block_settings.variant_swatch_width
  elsif settings.variant_swatch_width != blank
    assign swatch_variant_width = settings.variant_swatch_width
  endif

  # Check for combined listings metafield on current product
  assign combined_listings_metafield = product_resource.metafields.custom.combined_listing
  assign found_products = ''
  assign source_metafield_product = product_resource
  
  # If current product has the metafield, use it
  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
    for linked_product in combined_listings_metafield.value
      # Add all linked products (including current product if it's in its own metafield)
      assign linked_product_id = linked_product.id
      assign current_product_id = product_resource.id
      assign linked_product_id_as_string = linked_product_id | append: ''
      assign current_product_id_as_string = current_product_id | append: ''
      
      # Check if this linked product is already in found_products to avoid duplicates
      assign already_added = false
      if found_products != ''
        assign found_products_check = found_products | split: ','
        for check_id in found_products_check
          assign check_id_as_number = check_id | plus: 0
          if linked_product_id == check_id or linked_product_id == check_id_as_number or linked_product_id_as_string == check_id
            assign already_added = true
            break
          endif
        endfor
      endif
      
      unless already_added
        if found_products == ''
          assign found_products = linked_product.id
        else
          assign found_products = found_products | append: ',' | append: linked_product.id
        endif
      endunless
    endfor
  else
    # If current product doesn't have the metafield, check if it's referenced in any other product's metafield
    for all_product in collections.all.products
      if all_product.id != product_resource.id
        assign check_metafield = all_product.metafields.custom.combined_listing
        if check_metafield != blank and check_metafield.value != blank
          # Check if current product is in this product's metafield
          assign current_product_found_in_metafield = false
          for linked_product in check_metafield.value
            assign linked_product_id = linked_product.id
            assign current_product_id = product_resource.id
            assign linked_product_id_as_string = linked_product_id | append: ''
            assign current_product_id_as_string = current_product_id | append: ''
            if linked_product_id == current_product_id or linked_product_id_as_string == current_product_id_as_string
              assign current_product_found_in_metafield = true
              break
            endif
          endfor
          
          if current_product_found_in_metafield
            # Current product is in this metafield, so use this metafield's products
            assign combined_listings_metafield = check_metafield
            assign source_metafield_product = all_product
            # Add all products from this metafield (includes current product)
            for metafield_product in check_metafield.value
              if found_products == ''
                assign found_products = metafield_product.id
              else
                assign found_products = found_products | append: ',' | append: metafield_product.id
              endif
            endfor
            # Also add the product that has the metafield (if not already in the list)
            assign metafield_owner_in_list = false
            assign found_products_array = found_products | split: ','
            for product_id_check in found_products_array
              assign product_id_check_as_number = product_id_check | plus: 0
              assign all_product_id_as_string = all_product.id | append: ''
              if all_product.id == product_id_check or all_product.id == product_id_check_as_number or all_product_id_as_string == product_id_check
                assign metafield_owner_in_list = true
                break
              endif
            endfor
            unless metafield_owner_in_list
              if found_products == ''
                assign found_products = all_product.id
              else
                assign found_products = found_products | append: ',' | append: all_product.id
              endif
            endunless
            break
          endif
        endif
      endif
    endfor
  endif

  # If no products found, set flag to fall back to default variant picker
  assign should_fallback = false
  if found_products == ''
    assign should_fallback = true
  endif
%}

{% if should_fallback %}
  {% comment %}
    Pass the block object to variant-main-picker.
    The block object includes all settings:
    - block.settings.variant_style (dropdowns/buttons)
    - block.settings.show_swatches (true/false)
    - block.settings.alignment (left/center/right)
    - block.settings.padding-* (all padding settings)
    
    variant-main-picker will access these via block.settings
  {% endcomment %}
  {% render 'variant-main-picker', product_resource: product_resource, block: block %}
{% else %}


{% liquid
  # Collect all products from metafield (current + related) with their data
  # Use the metafield product references directly instead of searching collections.all.products
  assign all_products_data = ''
  assign processed_product_ids = ''
  
  # Process products directly from the metafield
  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
    for linked_product in combined_listings_metafield.value
      assign linked_product_id = linked_product.id
      assign current_product_id = product_resource.id
      assign linked_product_id_as_string = linked_product_id | append: ''
      assign current_product_id_as_string = current_product_id | append: ''
      assign is_current_product = false
      
      if linked_product_id == current_product_id or linked_product_id_as_string == current_product_id_as_string
        assign is_current_product = true
      else
        # Check if already processed
        assign already_processed = false
        if processed_product_ids != ''
          assign processed_check = processed_product_ids | split: ','
          for processed_id in processed_check
            assign processed_id_as_number = processed_id | plus: 0
            if linked_product_id == processed_id or linked_product_id == processed_id_as_number or linked_product_id_as_string == processed_id
              assign already_processed = true
              break
            endif
          endfor
        endif
        
        unless already_processed
          if all_products_data == ''
            assign all_products_data = linked_product_id | append: '|similar'
          else
            assign all_products_data = all_products_data | append: ',' | append: linked_product_id | append: '|similar'
          endif
          if processed_product_ids == ''
            assign processed_product_ids = linked_product_id
          else
            assign processed_product_ids = processed_product_ids | append: ',' | append: linked_product_id
          endif
        endunless
      endif
    endfor
  endif
%}


{% liquid

  # Always add current product explicitly (ensures it's always included)
  # Ensure product_resource.id is not blank
  assign current_product_id_for_data = product_resource.id | append: ''
  if current_product_id_for_data != blank and current_product_id_for_data != ''
    if all_products_data == ''
      assign all_products_data = current_product_id_for_data | append: '|current'
    else
      assign all_products_data = all_products_data | append: ',' | append: current_product_id_for_data | append: '|current'
    endif
  endif
%}

{% liquid
  # Supports up to 3 options
  # Each option can be color-like (renders as swatches) or non-color
  assign option1_name = ''
  assign option2_name = ''
  assign option3_name = ''
  assign option1_position = 0
  assign option2_position = 0
  assign option3_position = 0
  assign option1_is_color_like = false
  assign option2_is_color_like = false
  assign option3_is_color_like = false
  
  # Collect all products to analyze (including current product)
  assign all_products_to_analyze = ''
  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
    for linked_product in combined_listings_metafield.value
      if all_products_to_analyze == ''
        assign all_products_to_analyze = linked_product.id
      else
        assign all_products_to_analyze = all_products_to_analyze | append: ',' | append: linked_product.id
      endif
    endfor
  endif
  
  # Always include current product in analysis
  if all_products_to_analyze == ''
    assign all_products_to_analyze = product_resource.id
  else
    assign all_products_to_analyze = all_products_to_analyze | append: ',' | append: product_resource.id
  endif
  
  # Analyze all products to find variant option names
  assign products_to_check = all_products_to_analyze | split: ','
  for product_id_str in products_to_check
    if product_id_str != blank and product_id_str != ''
      assign product_id_check = product_id_str | plus: 0
      assign product_id_check_str = product_id_str | append: ''
      assign current_product_id_str = product_resource.id | append: ''
      
      # Find the product object
      assign analyze_product = ''
      
      # Check if it's the current product
      if product_id_check == product_resource.id or product_id_check_str == current_product_id_str
        assign analyze_product = product_resource
      else
        # Try to find from metafield
        if combined_listings_metafield != blank and combined_listings_metafield.value != blank
          for linked_product in combined_listings_metafield.value
            assign linked_product_id = linked_product.id
            assign linked_product_id_str = linked_product_id | append: ''
            if linked_product_id == product_id_check or linked_product_id_str == product_id_check_str
              assign analyze_product = linked_product
              break
            endif
          endfor
        endif
        
        # Fallback to collections
        if analyze_product == ''
          for all_product in collections.all.products
            assign all_product_id_str = all_product.id | append: ''
            if all_product.id == product_id_check or all_product_id_str == product_id_check_str
              assign analyze_product = all_product
              break
            endif
          endfor
        endif
      endif
      
      # Analyze this product's options
      if analyze_product != '' and analyze_product.options_with_values.size >= 1
        assign option_index = 0
        for option in analyze_product.options_with_values
          if option_index == 0
            if option1_name == ''
              assign option1_name = option.name
              assign option1_position = option.position
              assign option1_name_lower = option1_name | downcase | strip
              if option1_name_lower == 'color' or option1_name_lower contains 'color'
                assign option1_is_color_like = true
              else
                assign option1_swatch_count = option.values | map: 'swatch' | compact | size
                if option1_swatch_count > 0
                  assign option1_is_color_like = true
                endif
              endif
            endif
          elsif option_index == 1
            if option2_name == ''
              assign option2_name = option.name
              assign option2_position = option.position
              
              assign option2_name_lower = option2_name | downcase | strip
              if option2_name_lower == 'color' or option2_name_lower contains 'color'
                assign option2_is_color_like = true
              else
                assign option2_swatch_count = option.values | map: 'swatch' | compact | size
                if option2_swatch_count > 0
                  assign option2_is_color_like = true
                endif
              endif
            endif
          elsif option_index == 2
            if option3_name == ''
              assign option3_name = option.name
              assign option3_position = option.position
              
              assign option3_name_lower = option3_name | downcase | strip
              if option3_name_lower == 'color' or option3_name_lower contains 'color'
                assign option3_is_color_like = true
              else
                assign option3_swatch_count = option.values | map: 'swatch' | compact | size
                if option3_swatch_count > 0
                  assign option3_is_color_like = true
                endif
              endif
            endif
            break
          endif
          assign option_index = option_index | plus: 1
        endfor
      endif
    endif
  endfor
  
  # Determine if we need multi picker mode (2-3 options)
  assign multi_picker_mode = false
  assign option_count = 0
  if option1_name != ''
    assign option_count = option_count | plus: 1
  endif
  if option2_name != ''
    assign option_count = option_count | plus: 1
  endif
  if option3_name != ''
    assign option_count = option_count | plus: 1
  endif
  
  if option_count >= 2
    assign multi_picker_mode = true
  endif
  
  assign dual_picker_mode = multi_picker_mode
  
  assign has_color_option = false
  assign has_size_option = false
  assign color_option_name = option1_name
  assign size_option_name = option2_name
  assign color_option_position = option1_position
  assign size_option_position = option2_position
  
  if multi_picker_mode
    assign has_color_option = true
    if option2_name != ''
      assign has_size_option = true
      assign color_option_name = option1_name
      assign size_option_name = option2_name
      assign color_option_position = option1_position
      assign size_option_position = option2_position
    endif
  endif
%}

{% liquid
  # PHASE 2: Build multi-option variant data structure if multi picker mode is enabled
  assign dual_variant_data = ''
  assign unique_colors = ''
  assign unique_products_with_colors = ''
  assign products_color_map = ''
  assign unique_sizes = ''
  assign unique_option3_values = ''
  assign current_color_value = ''
  assign current_size_value = ''
  assign current_option3_value = ''
  
  if dual_picker_mode
    # Process all products to build combination data
    assign products_array_for_dual = all_products_data | split: ','
    
    for product_data in products_array_for_dual
      if product_data != blank and product_data != ''
        assign product_parts = product_data | split: '|'
        assign product_id_index = 0
        assign product_type_index = 1
        if product_parts.size > 0 and product_parts[0] == blank or product_parts[0] == ''
          assign product_id_index = 1
          assign product_type_index = 2
        endif
        
        if product_parts.size > product_type_index
          assign product_id = product_parts[product_id_index] | strip
          assign product_type = product_parts[product_type_index] | strip
          assign product_type_normalized = product_type | downcase | strip
          
          if product_id == blank or product_id == ''
            if product_type_normalized == 'current'
              assign product_id = product_resource.id
            endif
          endif
          
          assign product_id_as_number = product_id | plus: 0
          
          # Find the product object
          assign current_product_obj = ''
          if product_type == 'current'
            assign current_product_obj = product_resource
            if product_id == blank or product_id == ''
              assign product_id = product_resource.id
              assign product_id_as_number = product_id | plus: 0
            endif
          else
            if combined_listings_metafield != blank and combined_listings_metafield.value != blank
              for linked_product in combined_listings_metafield.value
                assign linked_product_id = linked_product.id
                assign linked_product_id_as_string = linked_product_id | append: ''
                if linked_product_id == product_id or linked_product_id == product_id_as_number or linked_product_id_as_string == product_id
                  assign current_product_obj = linked_product
                  break
                endif
              endfor
            endif
            
            if current_product_obj == ''
              for all_product in collections.all.products
                assign all_product_id_as_string = all_product.id | append: ''
                if all_product.id == product_id or all_product.id == product_id_as_number or all_product_id_as_string == product_id
                  assign current_product_obj = all_product
                  break
                endif
              endfor
            endif
          endif
          
          if current_product_obj != ''
            # Get current product's selected variant for pre-selection
            assign current_variant = current_product_obj.selected_or_first_available_variant
            if product_type == 'current'
              assign current_variant = product_resource.selected_or_first_available_variant
              # Store current product's values for pre-selection
              assign current_variant_option1_value = ''
              assign current_variant_option2_value = ''
              assign current_variant_option3_value = ''
              if option1_position == 1
                assign current_variant_option1_value = current_variant.option1
              elsif option1_position == 2
                assign current_variant_option1_value = current_variant.option2
              elsif option1_position == 3
                assign current_variant_option1_value = current_variant.option3
              endif
              if option2_position == 1
                assign current_variant_option2_value = current_variant.option1
              elsif option2_position == 2
                assign current_variant_option2_value = current_variant.option2
              elsif option2_position == 3
                assign current_variant_option2_value = current_variant.option3
              endif
              if option3_position == 1
                assign current_variant_option3_value = current_variant.option1
              elsif option3_position == 2
                assign current_variant_option3_value = current_variant.option2
              elsif option3_position == 3
                assign current_variant_option3_value = current_variant.option3
              endif
              # Create combined current color value: frame + lens
              assign current_color_value = current_variant_option1_value
              if current_variant_option2_value != blank and current_variant_option2_value != ''
                assign current_color_value = current_variant_option1_value | append: ' / ' | append: current_variant_option2_value
              endif
              assign current_size_value = current_variant_option2_value
              assign current_option3_value = current_variant_option3_value
            endif
            
            # Loop through ALL variants of this product (not just the first one)
            assign product_variant_count = 0
            for variant_item in current_product_obj.variants
              assign product_variant_count = product_variant_count | plus: 1
              # Extract option1, option2, and option3 values from variant
              assign option1_value = ''
              assign option2_value = ''
              assign option3_value = ''
              
              if option1_position == 1
                assign option1_value = variant_item.option1
              elsif option1_position == 2
                assign option1_value = variant_item.option2
              elsif option1_position == 3
                assign option1_value = variant_item.option3
              endif
              
              if option2_position == 1
                assign option2_value = variant_item.option1
              elsif option2_position == 2
                assign option2_value = variant_item.option2
              elsif option2_position == 3
                assign option2_value = variant_item.option3
              endif
              
              if option3_position == 1
                assign option3_value = variant_item.option1
              elsif option3_position == 2
                assign option3_value = variant_item.option2
              elsif option3_position == 3
                assign option3_value = variant_item.option3
              endif
              
              assign color_value = option1_value
              assign size_value = option2_value
              
              # Create combined color value: frame color + lens color (or option1 + option2)
              # This ensures products with same frame but different lenses get unique swatches
              assign combined_color_value = color_value
              if size_value != blank and size_value != ''
                assign combined_color_value = color_value | append: ' / ' | append: size_value
              endif
              
              assign product_id_str = product_id | append: ''
              assign variant_id_str = variant_item.id | append: ''
              assign color_value_str = color_value | append: ''
              assign size_value_str = size_value | append: ''
              assign combined_color_value_str = combined_color_value | append: ''
              assign option3_value_str = option3_value | append: ''
              assign product_url_str = current_product_obj.url | append: ''
              assign variant_available_str = 'false'
              if variant_item.available
                assign variant_available_str = 'true'
              endif
              assign is_current_str = 'false'
              if product_type == 'current' and variant_item.id == current_variant.id
                assign is_current_str = 'true'
              endif
              
              assign combination_entry = product_id_str | append: '|' | append: variant_id_str | append: '|' | append: color_value_str | append: '|' | append: size_value_str | append: '|' | append: option3_value_str | append: '|' | append: product_url_str | append: '|' | append: variant_available_str | append: '|' | append: is_current_str
              
              if dual_variant_data == ''
                assign dual_variant_data = combination_entry
              else
                assign dual_variant_data = dual_variant_data | append: '|||' | append: combination_entry
              endif
              
              # Track unique colors using combined color value (frame + lens)
              # This ensures products with same frame but different lenses get separate swatches
              if combined_color_value != blank and combined_color_value != ''
                # Track unique combined colors
                assign combined_color_found = false
                if unique_colors != ''
                  assign colors_check = unique_colors | split: '|||'
                  for existing_color in colors_check
                    if existing_color == combined_color_value
                      assign combined_color_found = true
                      break
                    endif
                  endfor
                endif
                unless combined_color_found
                  if unique_colors == ''
                    assign unique_colors = combined_color_value
                  else
                    assign unique_colors = unique_colors | append: '|||' | append: combined_color_value
                  endif
                endunless
                
                # Track unique product-color combinations (product_id|combined_color_value)
                # This ensures each product gets its own swatch
                assign product_color_key = product_id_str | append: '|' | append: combined_color_value_str
                assign product_color_found = false
                if unique_products_with_colors != ''
                  assign product_colors_check = unique_products_with_colors | split: '|||'
                  for existing_product_color in product_colors_check
                    if existing_product_color == product_color_key
                      assign product_color_found = true
                      break
                    endif
                  endfor
                endif
                unless product_color_found
                  if unique_products_with_colors == ''
                    assign unique_products_with_colors = product_color_key
                  else
                    assign unique_products_with_colors = unique_products_with_colors | append: '|||' | append: product_color_key
                  endif
                  
                  # Also track product-color mapping for rendering (product_id:combined_color_value)
                  assign product_color_entry = product_id_str | append: ':' | append: combined_color_value_str
                  if products_color_map == ''
                    assign products_color_map = product_color_entry
                  else
                    assign products_color_map = products_color_map | append: '|||' | append: product_color_entry
                  endif
                endunless
              endif
              
              # Track unique sizes
              if size_value != blank and size_value != ''
                assign size_found = false
                if unique_sizes != ''
                  assign sizes_check = unique_sizes | split: '|||'
                  for existing_size in sizes_check
                    if existing_size == size_value
                      assign size_found = true
                      break
                    endif
                  endfor
                endif
                unless size_found
                  if unique_sizes == ''
                    assign unique_sizes = size_value
                  else
                    assign unique_sizes = unique_sizes | append: '|||' | append: size_value
                  endif
                endunless
              endif
              
              if option3_value != blank and option3_value != '' and option3_name != ''
                assign option3_found = false
                if unique_option3_values != ''
                  assign option3_check = unique_option3_values | split: '|||'
                  for existing_option3 in option3_check
                    if existing_option3 == option3_value
                      assign option3_found = true
                      break
                    endif
                  endfor
                endif
                unless option3_found
                  if unique_option3_values == ''
                    assign unique_option3_values = option3_value
                  else
                    assign unique_option3_values = unique_option3_values | append: '|||' | append: option3_value
                  endif
                endunless
              endif
            endfor
          endif
        endif
      endif
    endfor
    
    # Sort unique colors alphabetically
    if unique_colors != ''
      assign colors_array_unsorted = unique_colors | split: '|||'
      assign colors_array_sorted = colors_array_unsorted | sort
      assign unique_colors = colors_array_sorted | join: '|||'
    endif
    
    # Sort unique product-color combinations alphabetically by combined color value
    # This ensures swatches are always in the same order on every page
    if unique_products_with_colors != '' and unique_products_with_colors != blank
      assign product_colors_unsorted = unique_products_with_colors | split: '|||'
      assign product_colors_with_sort_keys = ''
      
      # Build sortable array: lowercase_combined_color|||SORT|||product_id|combined_color
      for product_color_key in product_colors_unsorted
        if product_color_key != blank and product_color_key != ''
          assign key_parts = product_color_key | split: '|'
          if key_parts.size >= 2
            assign combined_color_for_sort = key_parts[1] | strip
            assign combined_color_lower = combined_color_for_sort | downcase | strip
            assign sortable_key = combined_color_lower | append: '|||SORT|||' | append: product_color_key
            
            if product_colors_with_sort_keys == ''
              assign product_colors_with_sort_keys = sortable_key
            else
              assign product_colors_with_sort_keys = product_colors_with_sort_keys | append: '|||SEP|||' | append: sortable_key
            endif
          endif
        endif
      endfor
      
      # Sort by combined color (alphabetically, case-insensitive)
      if product_colors_with_sort_keys != '' and product_colors_with_sort_keys != blank
        assign sorted_with_keys = product_colors_with_sort_keys | split: '|||SEP|||' | sort
        assign unique_products_with_colors = ''
        
        # Extract product-color keys in sorted order
        for sorted_item in sorted_with_keys
          assign sort_parts = sorted_item | split: '|||SORT|||'
          if sort_parts.size > 1
            assign product_color_key_original = sort_parts[1]
            if unique_products_with_colors == ''
              assign unique_products_with_colors = product_color_key_original
            else
              assign unique_products_with_colors = unique_products_with_colors | append: '|||' | append: product_color_key_original
            endif
          endif
        endfor
      endif
    endif
    
    # Sort unique sizes with custom logic for numeric and standard sizes
    if unique_sizes != ''
      capture sorted_sizes_result
        render 'util-size-sort', sizes_string: unique_sizes
      endcapture
      assign unique_sizes = sorted_sizes_result | strip
    endif
    
    if unique_option3_values != ''
      assign option3_array_unsorted = unique_option3_values | split: '|||'
      assign option3_array_sorted = option3_array_unsorted | sort
      assign unique_option3_values = option3_array_sorted | join: '|||'
    endif
    
    assign dual_variant_data_for_js = ''
    if dual_variant_data != ''
      assign combinations_for_js = dual_variant_data | split: '|||'
      for combination_entry in combinations_for_js
        if combination_entry != blank and combination_entry != ''
          assign combo_parts = combination_entry | split: '|'
          if combo_parts.size >= 8
            assign js_entry = combo_parts[0] | append: '|' | append: combo_parts[1] | append: '|' | append: combo_parts[2] | append: '|' | append: combo_parts[3] | append: '|' | append: combo_parts[5] | append: '|' | append: combo_parts[6] | append: '|' | append: combo_parts[7]
          else
            assign js_entry = combination_entry
          endif
          
          if dual_variant_data_for_js == ''
            assign dual_variant_data_for_js = js_entry
          else
            assign dual_variant_data_for_js = dual_variant_data_for_js | append: '|||' | append: js_entry
          endif
        endif
      endfor
    else
      assign dual_variant_data_for_js = ''
    endif
  endif
%}

{% liquid
  # Build products array with full data
  assign products_array = all_products_data | split: ','
  assign products_with_data = ''

  # Build a map of product IDs to product objects from the metafield
  assign product_map = ''
  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
    for linked_product in combined_listings_metafield.value
      assign linked_product_id = linked_product.id
      if product_map == ''
        assign product_map = linked_product_id | append: ':' | append: linked_product.id
      else
        assign product_map = product_map | append: '|||' | append: linked_product_id | append: ':' | append: linked_product.id
      endif
    endfor
  endif

  for product_data in products_array
    # Skip empty items
    if product_data != blank and product_data != ''
      assign product_parts = product_data | split: '|'
      
      # Handle case where string starts with pipe (first element is empty)
      assign product_id_index = 0
      assign product_type_index = 1
      if product_parts.size > 0 and product_parts[0] == blank or product_parts[0] == ''
        # First element is empty, shift indices
        assign product_id_index = 1
        assign product_type_index = 2
      endif
      
      if product_parts.size > product_type_index
        assign product_id = product_parts[product_id_index] | strip
        assign product_type = product_parts[product_type_index] | strip
        
        # Normalize product_type for comparison
        assign product_type_normalized = product_type | downcase | strip
        
        # If product_id is blank and this is the current product, use product_resource.id
        if product_id == blank or product_id == ''
          if product_type_normalized == 'current'
            assign product_id = product_resource.id
            assign product_type = 'current'
          endif
        endif
        
        assign product_id_as_number = product_id | plus: 0

        # Find the product object
        assign current_product_obj = ''
        
        # Use product_resource directly if this is the current product
        if product_type == 'current'
          assign current_product_obj = product_resource
          # Ensure product_id is set for current product
          if product_id == blank or product_id == ''
            assign product_id = product_resource.id
            assign product_id_as_number = product_id | plus: 0
          endif
        else
          # Try to find product from metafield first (more reliable)
          if combined_listings_metafield != blank and combined_listings_metafield.value != blank
            for linked_product in combined_listings_metafield.value
              assign linked_product_id = linked_product.id
              assign linked_product_id_as_string = linked_product_id | append: ''
              if linked_product_id == product_id or linked_product_id == product_id_as_number or linked_product_id_as_string == product_id
                assign current_product_obj = linked_product
                break
              endif
            endfor
          endif
          
          # Fallback: Find product by iterating through all products (if not found in metafield)
          if current_product_obj == ''
            for all_product in collections.all.products
              assign all_product_id_as_string = all_product.id | append: ''
              if all_product.id == product_id or all_product.id == product_id_as_number or all_product_id_as_string == product_id
                assign current_product_obj = all_product
                break
              endif
            endfor
          endif
        endif

        if current_product_obj != ''
          # Get variant to display (selected for current product, first available for others)
          assign variant_to_display = current_product_obj.selected_or_first_available_variant
          if product_type == 'current'
            assign variant_to_display = product_resource.selected_or_first_available_variant
          endif

          # Find color option value with swatch if available
          # Priority: 1) "color" variant option, 2) first available option
          assign color_option_value = ''
          assign color_option_value_name = ''
          assign color_option_name = ''
          assign has_swatch = false
          assign color_metafield_value = ''

          # Step 1: Check for "color" variant option (case-insensitive)
          for option in current_product_obj.options_with_values
            assign option_name_lower = option.name | downcase
            if option_name_lower == 'color'
              assign color_option_name = option.name
              # Get the color value name from the variant's option value directly
              # Find which position the color option is in
              if option.position == 1
                assign variant_color_value = variant_to_display.option1
              elsif option.position == 2
                assign variant_color_value = variant_to_display.option2
              elsif option.position == 3
                assign variant_color_value = variant_to_display.option3
              else
                assign variant_color_value = ''
              endif
              
              # Use the variant's color value directly - this should always work
              assign color_option_value_name = variant_color_value
              
              # Check if this option has swatches and find the matching option value
              assign swatch_count = option.values | map: 'swatch' | compact | size
              if swatch_count > 0
                # Find the option value that matches this variant for swatch display
                for product_option_value in option.values
                  if product_option_value.variant.id == variant_to_display.id
                    assign color_option_value = product_option_value
                    assign has_swatch = true
                    break
                  endif
                endfor
              endif
              
              break
            endif
          endfor

          # Step 2: If no "color" option found, use first available option name
          if color_option_name == ''
            assign first_option = current_product_obj.options_with_values.first
            if first_option
              assign color_option_name = first_option.name
              # Get the value name from the variant's option value directly
              if first_option.position == 1
                assign color_option_value_name = variant_to_display.option1
              elsif first_option.position == 2
                assign color_option_value_name = variant_to_display.option2
              elsif first_option.position == 3
                assign color_option_value_name = variant_to_display.option3
              endif
              # Check if this option has swatches
              assign swatch_count = first_option.values | map: 'swatch' | compact | size
              if swatch_count > 0
                # Find the option value that matches this variant
                for product_option_value in first_option.values
                  if product_option_value.variant.id == variant_to_display.id
                    assign color_option_value = product_option_value
                    assign has_swatch = true
                    break
                  endif
                endfor
              endif
            endif
          endif
          
          # Ensure color_option_value_name is never blank - use fallback if needed
          if color_option_value_name == blank or color_option_value_name == ''
            # Fallback: use the variant title or product title
            if variant_to_display.title != blank
              assign color_option_value_name = variant_to_display.title
            else
              assign color_option_value_name = current_product_obj.title
            endif
          endif
          
          # Ensure color_option_name is never blank
          if color_option_name == blank or color_option_name == ''
            assign color_option_name = 'Option'
          endif

          # Build product data string: product_id|product_type|variant_id|product_url|product_title|has_swatch|color_option_value_name|color_option_name|is_current|available|color_metafield_value
          assign is_current = 'false'
          if product_type == 'current'
            assign is_current = 'true'
          endif

          # Get color metafield value if available
          assign color_metafield_value_for_data = ''
          if color_metafield_value != blank
            assign color_metafield_value_for_data = color_metafield_value
          elsif color_metafield != blank and color_metafield.value != blank
            assign color_metafield_value_for_data = color_metafield.value
          endif

          # Use product URL without variant parameter
          assign product_url_clean = current_product_obj.url
          # Convert boolean to string explicitly
          assign variant_available_string = 'false'
          if variant_to_display.available
            assign variant_available_string = 'true'
          endif
          # Ensure product_id is always set (critical for current product)
          # Use product object id directly to ensure it's never blank
          if product_type == 'current'
            assign product_id = product_resource.id
            assign product_id_as_number = product_id | plus: 0
          else
            if product_id == blank or product_id == ''
              assign product_id = current_product_obj.id
              assign product_id_as_number = product_id | plus: 0
            endif
          endif
          
          # Ensure all values are strings and never blank (use empty string if blank)
          # Always use product object id directly for string conversion to avoid any parsing issues
          if product_type == 'current'
            # For current product, always use product_resource.id directly
            assign product_id_str = product_resource.id | append: ''
            # Double-check it's not blank
            if product_id_str == blank or product_id_str == ''
              assign product_id_str = product_resource.id
            endif
          else
            assign product_id_str = product_id | append: ''
            if product_id_str == blank or product_id_str == ''
              assign product_id_str = current_product_obj.id | append: ''
            endif
            # Final fallback
            if product_id_str == blank or product_id_str == ''
              assign product_id_str = current_product_obj.id
            endif
          endif
          
          # Ensure product_id_str is never blank - if it is, something is very wrong
          if product_id_str == blank or product_id_str == ''
            if product_type == 'current'
              assign product_id_str = product_resource.id
            else
              assign product_id_str = current_product_obj.id
            endif
          endif
          
          assign product_type_str = product_type | append: ''
          assign variant_id_str = variant_to_display.id | append: ''
          assign product_url_str = product_url_clean | append: ''
          assign product_title_str = current_product_obj.title | append: ''
          assign has_swatch_str = has_swatch | append: ''
          assign color_value_str = color_option_value_name | append: ''
          assign color_option_str = color_option_name | append: ''
          assign is_current_str = is_current | append: ''
          assign available_str = variant_available_string | append: ''
          assign metafield_str = color_metafield_value_for_data | append: ''
          
          # Store the value name (string) for sorting, not the object
          # Format: product_id|product_type|variant_id|product_url|product_title|has_swatch|color_option_value_name|color_option_name|is_current|available|color_metafield_value
          # Build string carefully - ensure product_id is never blank
          # Normalize product_type for comparison
          assign product_type_check = product_type | downcase | strip
          
          # For current product, always use product_resource.id directly
          if product_type_check == 'current'
            # Use product_resource.id directly - it should always be available
            assign final_product_id = product_resource.id
            # Ensure product_id is also set for consistency
            if product_id == blank or product_id == ''
              assign product_id = product_resource.id
            endif
          else
            # Use the parsed product_id, or fall back to current_product_obj.id
            if product_id != blank and product_id != ''
              assign final_product_id = product_id
            else
              assign final_product_id = current_product_obj.id
            endif
          endif
          
          # Convert to string - use the most reliable method
          assign final_product_id_str = final_product_id | append: ''
          
          # Final safety check - if still blank, something is very wrong
          if final_product_id_str == blank or final_product_id_str == ''
            if product_type_check == 'current'
              assign final_product_id_str = product_resource.id
            else
              assign final_product_id_str = current_product_obj.id
            endif
            # Convert again
            assign final_product_id_str = final_product_id_str | append: ''
          endif
          
          # Now build the string - start with product_id (should never be blank at this point)
          assign product_data_string = final_product_id_str | append: '|' | append: product_type_str | append: '|' | append: variant_id_str | append: '|' | append: product_url_str | append: '|' | append: product_title_str | append: '|' | append: has_swatch_str | append: '|' | append: color_value_str | append: '|' | append: color_option_str | append: '|' | append: is_current_str | append: '|' | append: available_str | append: '|' | append: metafield_str

          if products_with_data == ''
            assign products_with_data = product_data_string
          else
            assign products_with_data = products_with_data | append: '|||' | append: product_data_string
          endif
        endif
      endif
    endif
  endfor

  # Sort products alphabetically by color option value (for consistent swatch ordering)
  assign sorted_products_array = products_with_data | split: '|||'
  assign sorted_products = ''

  # Create array of products with their sort keys (color value names, lowercase for case-insensitive sorting)
  assign products_with_sort_keys = ''
  for product_item in sorted_products_array
    if product_item != blank
      assign item_parts = product_item | split: '|'
      
      # Handle case where string starts with pipe (first element is empty) - same logic as rendering
      assign sort_base_index = 0
      if item_parts.size > 0
        assign sort_first_part = item_parts[0] | strip
        if sort_first_part == blank or sort_first_part == ''
          assign sort_base_index = 1
        endif
      endif
      
      # We need at least 10 elements (indices sort_base_index through sort_base_index+9)
      assign sort_min_size = sort_base_index | plus: 10
      if item_parts.size >= sort_min_size

        assign color_value_idx = sort_base_index | plus: 6
        assign color_value = item_parts[color_value_idx] | strip
        
        # If color_value is blank, fall back to product title for sorting (index sort_base_index + 4)
        if color_value == blank or color_value == ''
          assign product_title_idx = sort_base_index | plus: 4
          if item_parts.size > product_title_idx
            assign color_value = item_parts[product_title_idx] | strip
          endif
        endif
        
        # Ensure we have a value to sort by
        if color_value != blank and color_value != ''
          # Convert to lowercase for case-insensitive sorting
          assign color_value_lower = color_value | downcase | strip
          # Use a unique delimiter that won't appear in product data: |||SORT|||
          # Format: lowercase_color_value|||SORT|||product_item
          assign sortable_item = color_value_lower | append: '|||SORT|||' | append: product_item
          if products_with_sort_keys == ''
            assign products_with_sort_keys = sortable_item
          else
            assign products_with_sort_keys = products_with_sort_keys | append: '|||SEP|||' | append: sortable_item
          endif
        endif
      endif
    endif
  endfor

  # Sort by the lowercase color value (first part before |||SORT|||)
  assign sorted_with_keys = products_with_sort_keys | split: '|||SEP|||' | sort

  # Extract just the product items (everything after |||SORT|||)
  for sorted_item in sorted_with_keys
    assign sort_parts = sorted_item | split: '|||SORT|||'
    if sort_parts.size > 1
      assign product_item_original = sort_parts[1]
      
      if sorted_products == ''
        assign sorted_products = product_item_original
      else
        assign sorted_products = sorted_products | append: '|||' | append: product_item_original
      endif
    endif
  endfor
%}

{% liquid
  # Get variant option name for legend (from first product)
  # Priority: 1) "color" variant option, 2) first available option
  assign variant_option_name = 'Available Options'
  if sorted_products != '' and sorted_products_array != ''
    if sorted_products_array.size > 0
      assign first_product_parts = sorted_products_array[0] | split: '|'
      assign first_product_id = first_product_parts[0]
      assign first_product_id_as_number = first_product_id | plus: 0
      
      # Find the first product object - try metafield first, then collections
      assign first_product_obj = ''
      
      # Try to find from metafield first (more reliable)
      if combined_listings_metafield != blank and combined_listings_metafield.value != blank
        for linked_product in combined_listings_metafield.value
          assign linked_product_id = linked_product.id
          assign linked_product_id_as_string = linked_product_id | append: ''
          if linked_product_id == first_product_id or linked_product_id == first_product_id_as_number or linked_product_id_as_string == first_product_id
            assign first_product_obj = linked_product
            break
          endif
        endfor
      endif
      
      # Fallback: Find from collections.all.products
      if first_product_obj == ''
        for all_product in collections.all.products
          assign all_product_id_as_string = all_product.id | append: ''
          if all_product.id == first_product_id or all_product.id == first_product_id_as_number or all_product_id_as_string == first_product_id
            assign first_product_obj = all_product
            break
          endif
        endfor
      endif
      
      if first_product_obj != ''
        # Step 1: Check for "color" variant option (case-insensitive)
        for option in first_product_obj.options_with_values
          assign option_name_lower = option.name | downcase
          if option_name_lower == 'color'
            assign variant_option_name = option.name
            break
          endif
        endfor
        
        # Step 2: If no "color" option found, use first available option name
        if variant_option_name == 'Available Options'
          assign first_option = first_product_obj.options_with_values.first
          if first_option
            assign variant_option_name = first_option.name
          endif
        endif
      endif
    endif
  endif
  
  # Get the currently selected variant's color option value name for display
  assign selected_color_value = ''
  assign selected_variant = product_resource.selected_or_first_available_variant
  
  # Find the color option and get the selected value
  for option in product_resource.options_with_values
    assign option_name_lower = option.name | downcase
    if option_name_lower == 'color'
      # Get the selected value from the variant's option
      if option.position == 1
        assign selected_color_value = selected_variant.option1
      elsif option.position == 2
        assign selected_color_value = selected_variant.option2
      elsif option.position == 3
        assign selected_color_value = selected_variant.option3
      endif
      break
    endif
  endfor
  
  # If no color option found, use first available option's selected value
  if selected_color_value == blank or selected_color_value == ''
    assign first_option = product_resource.options_with_values.first
    if first_option
      if first_option.position == 1
        assign selected_color_value = selected_variant.option1
      elsif first_option.position == 2
        assign selected_color_value = selected_variant.option2
      elsif first_option.position == 3
        assign selected_color_value = selected_variant.option3
      endif
    endif
  endif
%}

{% if dual_picker_mode and dual_variant_data != '' %}
  {% comment %} DUAL PICKER MODE: Render Color + Size pickers {% endcomment %}
  {% liquid
    assign button_background_brightness = section.settings.color_scheme.settings.foreground | color_brightness
    if button_background_brightness < 105
      assign strikethrough_color_mix = 'var(--color-black)'
    else
      assign strikethrough_color_mix = 'var(--color-white)'
    endif
    
    # Get product image swatch size
    assign dual_swatch_size = product_image_swatch_size
  %}
  <variant-picker-cl-dual
    class="variant-picker-cl-dual spacing-style variant-picker-cl-dual--{{ alignment_value }}{% if show_product_image_swatches and show_horizontal_scroll %} variant-picker-cl-dual--horizontal-scroll{% endif %}\"\n    style="--color-strikethrough-mix: {{ strikethrough_color_mix }}; --product-image-swatch-size: {{ dual_swatch_size }}px; {% render 'spacing-style', settings: block_settings %}"\n    data-section-id="{{ section.id }}"\n    data-product-id="{{ product_resource.id }}"\n    data-product-url="{{ product_resource.url }}"\n    data-horizontal-scroll="{{ show_horizontal_scroll }}"\n    data-debug-picker="cl"\n    data-debug-spi="{{ show_product_image_swatches }}"\n    {% if product.id == product_resource.id %}\n      data-template-product-match="true"\n    {% endif %}\n    data-block-id="{{ block.id }}"\n    data-combinations="{{ dual_variant_data_for_js | escape }}"\n    data-current-color="{{ current_color_value | escape }}"\n    data-current-size="{{ current_size_value | escape }}"\n    {{ block.shopify_attributes }}\n  >
    <form class="variant-picker-cl-dual__form">
      {% comment %} Color Picker {% endcomment %}
      {%- liquid
        # Use swatch UI when show_swatches OR show_product_image_swatches (so "product images as swatches" shows image swatches)
        assign use_swatches = true
        if block != blank and block_settings != blank
          assign use_swatches = block_settings.show_swatches
        elsif settings.show_swatches != blank
          assign use_swatches = settings.show_swatches
        endif
        if show_product_image_swatches
          assign use_swatches = true
        endif
      -%}
      {%- if use_swatches -%}
        <fieldset class="variant-option variant-option--buttons variant-option--swatches{% if show_product_image_swatches and show_horizontal_scroll %} variant-option--swatches-horizontal-scroll{% endif %}">
        {%- liquid
          # Always show labels on product pages, otherwise respect the setting
          assign is_product_page = false
          if request.page_type == 'product'
            assign is_product_page = true
          endif
          
          # Show labels if on product page OR if setting is enabled
          assign show_text_labels = false
          if is_product_page
            assign show_text_labels = true
          elsif show_swatch_text_labels_setting
            assign show_text_labels = true
          endif
        -%}
        {%- if show_text_labels -%}
          <legend>
            {{ color_option_name | escape }}:
            {%- if current_color_value != blank and current_color_value != '' -%}
              <span class="variant-option__swatch-value">{{ current_color_value | escape }}</span>
            {%- endif %}
          </legend>
        {%- endif %}
        {% capture children %}
          {%- liquid
            # For combined listings, iterate through product-color combinations directly
            # This ensures each product gets a swatch even if multiple products share the same color
            assign products_with_colors_array = ''
            if unique_products_with_colors != '' and unique_products_with_colors != blank
              assign products_with_colors_array = unique_products_with_colors | split: '|||'
            endif
            
            # Fallback: if no product-color combinations, use unique colors
            assign use_fallback = false
            if products_with_colors_array == '' or products_with_colors_array == blank
              assign use_fallback = true
            endif
          -%}
          {% if use_fallback %}
            {% assign colors_array = unique_colors | split: '|||' %}
            {% for color_value_item in colors_array %}
              {% assign product_id_for_color = '' %}
            {%- liquid
              # Skip option values that are blank, null, 0 (number), "0" (string), or "null" (string)
              assign color_value_str = color_value_item | append: ''
              assign should_skip_color = false
              if color_value_item == blank or color_value_item == 0 or color_value_str == '' or color_value_str == '0' or color_value_str == 'null'
                assign should_skip_color = true
              endif
            -%}
            {%- unless should_skip_color -%}
            {% if color_value_item != blank and color_value_item != '' %}
              {% liquid
                assign is_current_color = false
                if color_value_item == current_color_value
                  assign is_current_color = true
                endif
                
                # Find swatch for this color - prioritize swatch color/image over variant image
                assign swatch_to_render = ''
                assign variant_image_for_swatch = ''
                assign matching_product_for_fallback = ''
                assign option_value_name_for_swatch = color_value_item
                
                # NEW: For product image swatch mode, find the product that has this color and use its featured image
                if show_product_image_swatches
                  # Use the specific product_id_for_color if we're iterating through product-color combinations
                  assign product_id_to_use = ''
                  if product_id_for_color != blank and product_id_for_color != ''
                    assign product_id_to_use = product_id_for_color
                  endif
                  
                  # Find the product that represents this color variant
                  if product_id_to_use != '' and product_id_to_use != blank
                    # Use the specific product ID we already know
                    assign product_id_to_use_as_number = product_id_to_use | plus: 0
                    if product_id_to_use_as_number == product_resource.id
                      assign matching_product_for_fallback = product_resource
                    elsif combined_listings_metafield != blank and combined_listings_metafield.value != blank
                      for linked_product in combined_listings_metafield.value
                        if linked_product.id == product_id_to_use_as_number
                          assign matching_product_for_fallback = linked_product
                          break
                        endif
                      endfor
                    endif
                  elsif dual_variant_data != ''
                    # Fallback: search through combinations if product_id_for_color not available
                    assign combinations_check = dual_variant_data | split: '|||'
                    for combination_entry in combinations_check
                      if combination_entry != blank and combination_entry != ''
                        assign combo_parts = combination_entry | split: '|'
                        if combo_parts.size >= 7
                          assign combo_color = combo_parts[2] | strip
                          assign combo_size = combo_parts[3] | strip
                          assign combo_product_id = combo_parts[0] | strip
                          
                          # Reconstruct combined color value from stored frame + lens
                          assign combo_combined_color = combo_color
                          if combo_size != blank and combo_size != ''
                            assign combo_combined_color = combo_color | append: ' / ' | append: combo_size
                          endif
                          
                          # Match against combined color value
                          if combo_combined_color == color_value_item
                            # Find this product to get its featured image
                            assign combo_product_id_as_number = combo_product_id | plus: 0
                            if combo_product_id_as_number == product_resource.id
                              assign matching_product_for_fallback = product_resource
                            elsif combined_listings_metafield != blank and combined_listings_metafield.value != blank
                              for linked_product in combined_listings_metafield.value
                                if linked_product.id == combo_product_id_as_number
                                  assign matching_product_for_fallback = linked_product
                                  break
                                endif
                              endfor
                            endif
                            
                            if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                              assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                              
                              # Build variant name from all available options for this product
                              assign variant_name_parts = ''
                              for option in matching_product_for_fallback.options_with_values
                                if option.values.size > 0
                                  assign first_value = option.values.first
                                  if first_value != blank
                                    if variant_name_parts == ''
                                      assign variant_name_parts = first_value.name
                                    else
                                      assign variant_name_parts = variant_name_parts | append: ' / ' | append: first_value.name
                                    endif
                                  endif
                                endif
                              endfor
                              
                              # Use variant name as option value name
                              if variant_name_parts != blank
                                assign option_value_name_for_swatch = variant_name_parts
                              else
                                assign option_value_name_for_swatch = matching_product_for_fallback.title
                              endif
                              
                              assign has_swatch_to_render = true
                              break
                            endif
                          endif
                        endif
                      endif
                    endfor
                  endif
                  
                  # Set featured media if we found the product
                  if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                    assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                  endif
                endif
                
                # Standard swatch logic (only if not using product image mode)
                unless show_product_image_swatches and has_swatch_to_render
                
                # Extract frame color from combined color value (part before " / ")
                assign frame_color_for_swatch = color_value_item
                if color_value_item contains ' / '
                  assign color_parts = color_value_item | split: ' / '
                  if color_parts.size > 0
                    assign frame_color_for_swatch = color_parts[0] | strip
                  endif
                endif
                
                # Check current product first
                for option in product_resource.options_with_values
                  assign option_name_lower = option.name | downcase | strip
                  if option_name_lower == 'color' or option_name_lower contains 'color'
                    for value in option.values
                      assign value_str = value | append: ''
                      # Match against frame color (extracted from combined value)
                      if value_str == frame_color_for_swatch
                        # Use the actual option value name for assets folder backup
                        assign option_value_name_for_swatch = value.name
                        
                        # Priority 1: Check for swatch (custom color or swatch image) - highest priority
                        if value.swatch != blank
                          if value.swatch.color != blank or value.swatch.image != blank
                            assign swatch_to_render = value.swatch
                          endif
                        endif
                        
                        # Priority 2: Check for variant's custom image (only if no swatch found)
                        if swatch_to_render == blank
                          if value.variant.featured_media != blank
                            assign variant_image_for_swatch = value.variant.featured_media
                          endif
                        endif
                        
                        # Store product for fallback if needed
                        if matching_product_for_fallback == ''
                          assign matching_product_for_fallback = product_resource
                        endif
                        
                        break
                      endif
                    endfor
                    if swatch_to_render != blank or variant_image_for_swatch != blank
                      break
                    endif
                  endif
                endfor
                
                # If not found in current product, check linked products
                if swatch_to_render == blank and variant_image_for_swatch == blank
                  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                    for linked_product in combined_listings_metafield.value
                      for option in linked_product.options_with_values
                        assign option_name_lower = option.name | downcase | strip
                        if option_name_lower == 'color' or option_name_lower contains 'color'
                          for value in option.values
                            assign value_str = value | append: ''
                            # Match against frame color (extracted from combined value)
                            if value_str == frame_color_for_swatch
                              # Use the actual option value name for assets folder backup
                              assign option_value_name_for_swatch = value.name
                              
                              # Priority 1: Check for swatch (custom color or swatch image) - highest priority
                              if value.swatch != blank
                                if value.swatch.color != blank or value.swatch.image != blank
                                  assign swatch_to_render = value.swatch
                                endif
                              endif
                              
                              # Priority 2: Check for variant's custom image (only if no swatch found)
                              if swatch_to_render == blank
                                if value.variant.featured_media != blank
                                  assign variant_image_for_swatch = value.variant.featured_media
                                endif
                              endif
                              
                              # Store product for fallback if needed
                              if matching_product_for_fallback == ''
                                assign matching_product_for_fallback = linked_product
                              endif
                              
                              break
                            endif
                          endfor
                          if swatch_to_render != blank or variant_image_for_swatch != blank
                            break
                          endif
                        endif
                      endfor
                      if swatch_to_render != blank or variant_image_for_swatch != blank
                        break
                      endif
                    endfor
                  endif
                endif
                
                # Priority 3: If no swatch or variant image found, fall back to product's first image
                if swatch_to_render == blank and variant_image_for_swatch == blank
                  if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                    assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                  endif
                endif
                
                # Check assets folder for backup swatch file (Priority 1 in swatch.liquid)
                assign assets_file_exists = false
                if option_value_name_for_swatch != blank
                  assign enable_backup = settings.enable_swatch_assets_backup
                  if enable_backup == blank
                    assign enable_backup = true
                  endif
                  
                  if enable_backup
                    assign swatch_file_extension = settings.swatch_file_extension | default: 'png'
                    assign color_file_name = option_value_name_for_swatch | handle | append: '.' | append: swatch_file_extension
                    if images[color_file_name] != blank
                      assign assets_file_exists = true
                    endif
                  endif
                endif
                
                # Set has_swatch_to_render - include assets folder check
                assign has_swatch_to_render = false
                if swatch_to_render != blank
                  # We have a swatch with color or image
                  assign has_swatch_to_render = true
                elsif variant_image_for_swatch != blank
                  # We have a variant image or product fallback image
                  assign has_swatch_to_render = true
                elsif assets_file_exists
                  # Assets folder file exists - swatch.liquid will handle rendering it
                  assign has_swatch_to_render = true
                endif
                endunless
                
                # Check if this color has the currently selected size available
                # If a size is selected, check if this color has that size
                assign color_is_available = true
                assign is_product_page = false
                if request.page_type == 'product'
                  assign is_product_page = true
                endif
                
                # Note: Since color_value_item is now a combined value (frame + lens),
                # we don't need to check size separately - the combined color already includes it
                # This check is kept for backward compatibility but may not be needed
                if current_size_value != blank and current_size_value != '' and is_product_page == false
                  assign color_has_size = false
                  if dual_variant_data != ''
                    assign combinations_check = dual_variant_data | split: '|||'
                    for combination_entry in combinations_check
                      if combination_entry != blank and combination_entry != ''
                        assign combo_parts = combination_entry | split: '|'
                        if combo_parts.size >= 7
                          assign combo_color = combo_parts[2] | strip
                          assign combo_size = combo_parts[3] | strip
                          
                          # Reconstruct combined color from stored values
                          assign combo_combined_color = combo_color
                          if combo_size != blank and combo_size != ''
                            assign combo_combined_color = combo_color | append: ' / ' | append: combo_size
                          endif
                          
                          assign color_value_normalized = color_value_item | strip
                          
                          # Check if combined colors match
                          if combo_combined_color == color_value_normalized
                            assign color_has_size = true
                            break
                          endif
                        endif
                      endif
                    endfor
                  endif
                  if color_has_size == false
                    assign color_is_available = false
                  endif
                endif
                
                # Find the first available variant for this color to get variant ID and URL
                # Also find the first variant (available or not) for navigation purposes
                assign first_available_variant_id = ''
                assign first_available_variant_url = ''
                assign first_variant_id = ''
                assign first_variant_url = ''
                assign variant_for_hover = ''
                if dual_variant_data != ''
                  assign combinations_check = dual_variant_data | split: '|||'
                  for combination_entry in combinations_check
                    if combination_entry != blank and combination_entry != ''
                      assign combo_parts = combination_entry | split: '|'
                      if combo_parts.size >= 7
                        assign combo_color = combo_parts[2] | strip
                        assign combo_size = combo_parts[3] | strip
                        assign combo_variant_id = combo_parts[1] | strip
                        assign combo_url = combo_parts[5] | strip
                        assign combo_available = combo_parts[6] | strip
                        
                        # Reconstruct combined color value from stored frame + lens
                        assign combo_combined_color = combo_color
                        if combo_size != blank and combo_size != ''
                          assign combo_combined_color = combo_color | append: ' / ' | append: combo_size
                        endif
                        
                        assign color_value_normalized = color_value_item | strip
                        
                        # Set first variant (for navigation) if not set yet - match against combined color
                        if combo_combined_color == color_value_normalized and first_variant_id == blank
                          assign first_variant_id = combo_variant_id
                          assign first_variant_url = combo_url
                        endif
                        
                        if combo_combined_color == color_value_normalized and combo_available == 'true'
                          assign first_available_variant_id = combo_variant_id
                          assign first_available_variant_url = combo_url
                          
                          # Try to find the actual variant object for hover preview
                          if matching_product_for_fallback != ''
                            assign variant_id_as_number = combo_variant_id | plus: 0
                            assign variant_id_as_string = combo_variant_id | append: ''
                            for variant in matching_product_for_fallback.variants
                              if variant.id == variant_id_as_number or variant.id == variant_id_as_string or variant.id == combo_variant_id
                                assign variant_for_hover = variant
                                break
                              endif
                            endfor
                          endif
                          
                          # If not found in matching product, check all linked products
                          if variant_for_hover == blank
                            if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                              for linked_product in combined_listings_metafield.value
                                assign variant_id_as_number = combo_variant_id | plus: 0
                                assign variant_id_as_string = combo_variant_id | append: ''
                                for variant in linked_product.variants
                                  if variant.id == variant_id_as_number or variant.id == variant_id_as_string or variant.id == combo_variant_id
                                    assign variant_for_hover = variant
                                    break
                                  endif
                                endfor
                                if variant_for_hover != blank
                                  break
                                endif
                              endfor
                            endif
                          endif
                          
                          break
                        endif
                      endif
                    endif
                  endfor
                endif
                
                if is_product_page or current_size_value == blank or current_size_value == ''
                  if first_available_variant_id == blank or first_available_variant_id == ''
                    assign color_is_available = false
                  else
                    assign color_is_available = true
                  endif
                endif
                
                # Find the product that this color variant belongs to (for hover preview)
                # For combined listings, each color represents a different product, so we need the product's featured media
                assign hover_product = matching_product_for_fallback
                if variant_for_hover != blank
                  # Find which product this variant belongs to by checking the combo URL
                  if first_available_variant_url != blank
                    # Extract product ID from URL or find product by variant
                    if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                      for linked_product in combined_listings_metafield.value
                        # Check if this product's URL matches the variant URL
                        assign linked_product_url = linked_product.url | append: ''
                        assign variant_url_base = first_available_variant_url | split: '?' | first
                        if linked_product_url == variant_url_base or first_available_variant_url contains linked_product_url
                          assign hover_product = linked_product
                          break
                        endif
                        # Also check by variant ID
                        for variant in linked_product.variants
                          if variant.id == variant_for_hover.id
                            assign hover_product = linked_product
                            break
                          endif
                        endfor
                        if hover_product != matching_product_for_fallback
                          break
                        endif
                      endfor
                    endif
                  endif
                endif
                
                # Get featured media for hover preview - prioritize product's featured media (main product image)
                # This ensures we show the correct product image for each color on hover
                assign featured_media = ''
                if hover_product != '' and hover_product != matching_product_for_fallback and hover_product.featured_media != blank
                  # Use the product's featured media (this is the main product image for that color)
                  assign featured_media = hover_product.featured_media
                elsif variant_for_hover != blank and variant_for_hover.featured_media != blank
                  # Fallback to variant's featured media if product media not available
                  assign featured_media = variant_for_hover.featured_media
                elsif matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                  # Use matching product's featured media as fallback
                  assign featured_media = matching_product_for_fallback.featured_media
                elsif variant_image_for_swatch != blank
                  assign featured_media = variant_image_for_swatch
                endif
              %}
              
              <li class="variant-option__swatch">
                <label
                  {% if featured_media != blank %}
                    data-media-id="{{ featured_media.id }}"
                  {% endif %}
                  data-option-available="{{ color_is_available }}"
                  {% if featured_media != blank and featured_media.preview_image != blank %}
                    data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                  {% endif %}
                  class="variant-option__button-label variant-option__button-label--has-swatch {% if show_product_image_swatches %}variant-option__button-label--product-image variant-option__button-label--product-image-{{ product_image_swatch_style }}{% else %}swatch-rounded{% endif %}{% if is_current_color %} variant-option__button-label--current{% endif %}"
                  {% if featured_media != blank %}
                    on:pointerenter="product-card/previewVariant/{{ featured_media.id }}"
                    on:pointerleave="product-card/resetVariant"
                  {% endif %}
                >
                  <input
                    type="radio"
                    id="cl-dual-color-{{ section.id }}-{{ block.id }}-{{ color_value_item | handleize }}"
                    name="color_selection-{{ block.id }}"
                    value="{{ color_value_item | escape }}"
                    data-option-type="color"
                    data-fieldset-index="0"
                    data-input-index="{{ forloop.index0 }}"
                    data-previous-checked="false"
                    data-option-available="{{ color_is_available }}"
                    {% if featured_media != blank %}
                      data-option-media-id="{{ featured_media.id }}"
                    {% endif %}
                    {% if featured_media != blank and featured_media.preview_image != blank %}
                      data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                    {% endif %}
                    {%- liquid
                      # Use available variant if found, otherwise use first variant for navigation
                      assign variant_id_for_nav = first_available_variant_id
                      assign variant_url_for_nav = first_available_variant_url
                      if variant_id_for_nav == blank or variant_id_for_nav == ''
                        assign variant_id_for_nav = first_variant_id
                        assign variant_url_for_nav = first_variant_url
                      endif
                    -%}
                    {% if variant_url_for_nav != blank and variant_id_for_nav != blank %}
                      data-connected-product-url="{{ variant_url_for_nav }}?variant={{ variant_id_for_nav }}"
                    {% endif %}
                    {% if is_current_color %}
                      data-current-checked="true"
                      checked
                    {% else %}
                      data-current-checked="false"
                    {% endif %}
                    {% if color_is_available == false %}
                      aria-disabled="true"
                    {% endif %}
                    aria-label="{{ color_value_item | escape }}"
                    data-available-count="{% if color_is_available %}1{% else %}0{% endif %}"
                    data-variant-id="{{ variant_id_for_nav }}"
                    data-first-available-or-first-variant-id="{% if first_available_variant_id != blank %}{{ first_available_variant_id }}{% else %}{{ first_variant_id }}{% endif %}"
                  >
                  {% if has_swatch_to_render %}
                    {% if swatch_to_render != blank and show_product_image_swatches == false %}
                      {% render 'swatch',
                        swatch: swatch_to_render,
                        variant_image: featured_media,
                        option_value_name: option_value_name_for_swatch,
                        enable_swatch_assets_backup: swatch_enable_assets_backup,
                        swatch_file_extension: swatch_file_extension_setting,
                        show_variant_image: swatch_show_variant_image,
                        variant_swatch_width: swatch_variant_width
                      %}
                    {% else %}
                      {% render 'swatch',
                        swatch: blank,
                        variant_image: variant_image_for_swatch,
                        option_value_name: option_value_name_for_swatch,
                        enable_swatch_assets_backup: false,
                        swatch_file_extension: swatch_file_extension_setting,
                        show_variant_image: true,
                        variant_swatch_width: swatch_variant_width,
                        force_image_swatch: show_product_image_swatches
                      %}
                    {% endif %}
                    {% unless color_is_available %}
                      {% render 'variant-option-unavailable-line' %}
                    {% endunless %}
                  {% else %}
                    {% if color_is_available == true %}
                      <span class="variant-picker-cl-dual__pill"></span>
                    {% endif %}
                    <span class="variant-picker-cl-dual__text">{{ color_value_item | escape }}</span>
                  {% endif %}
                </label>
              </li>
            {% endif %}
            {%- endunless -%}
            {% endfor %}
          {% else %}
            {% for product_color_key in products_with_colors_array %}
              {% if product_color_key != blank and product_color_key != '' %}
                {% assign key_parts = product_color_key | split: '|' %}
                {% if key_parts.size >= 2 %}
                  {% assign product_id_for_color = key_parts[0] | strip %}
                  {% assign color_value_item = key_parts[1] | strip %}
                  {%- liquid
                    # Skip option values that are blank, null, 0 (number), "0" (string), or "null" (string)
                    assign color_value_str = color_value_item | append: ''
                    assign should_skip_color = false
                    if color_value_item == blank or color_value_item == 0 or color_value_str == '' or color_value_str == '0' or color_value_str == 'null'
                      assign should_skip_color = true
                    endif
                  -%}
                  {%- unless should_skip_color -%}
                  {% if color_value_item != blank and color_value_item != '' %}
                    {% liquid
                      assign is_current_color = false
                      if color_value_item == current_color_value
                        assign is_current_color = true
                      endif
                      
                      # Find swatch for this color - prioritize swatch color/image over variant image
                      assign swatch_to_render = ''
                      assign variant_image_for_swatch = ''
                      assign matching_product_for_fallback = ''
                      assign option_value_name_for_swatch = color_value_item
                      
                      # NEW: For product image swatch mode, find the product that has this color and use its featured image
                      if show_product_image_swatches
                        # Use the specific product_id_for_color if we're iterating through product-color combinations
                        assign product_id_to_use = ''
                        if product_id_for_color != blank and product_id_for_color != ''
                          assign product_id_to_use = product_id_for_color
                        endif
                        
                        # Find the product that represents this color variant
                        if product_id_to_use != '' and product_id_to_use != blank
                          # Use the specific product ID we already know
                          assign product_id_to_use_as_number = product_id_to_use | plus: 0
                          if product_id_to_use_as_number == product_resource.id
                            assign matching_product_for_fallback = product_resource
                          elsif combined_listings_metafield != blank and combined_listings_metafield.value != blank
                            for linked_product in combined_listings_metafield.value
                              if linked_product.id == product_id_to_use_as_number
                                assign matching_product_for_fallback = linked_product
                                break
                              endif
                            endfor
                          endif
                        elsif dual_variant_data != ''
                          # Fallback: search through combinations if product_id_for_color not available
                          assign combinations_check = dual_variant_data | split: '|||'
                          for combination_entry in combinations_check
                            if combination_entry != blank and combination_entry != ''
                              assign combo_parts = combination_entry | split: '|'
                              if combo_parts.size >= 7
                                assign combo_color = combo_parts[2] | strip
                                assign combo_size = combo_parts[3] | strip
                                assign combo_product_id = combo_parts[0] | strip
                                
                                # Reconstruct combined color value from stored frame + lens
                                assign combo_combined_color = combo_color
                                if combo_size != blank and combo_size != ''
                                  assign combo_combined_color = combo_color | append: ' / ' | append: combo_size
                                endif
                                
                                # Match against combined color value
                                if combo_combined_color == color_value_item
                                  # Find this product to get its featured image
                                  assign combo_product_id_as_number = combo_product_id | plus: 0
                                  if combo_product_id_as_number == product_resource.id
                                    assign matching_product_for_fallback = product_resource
                                  elsif combined_listings_metafield != blank and combined_listings_metafield.value != blank
                                    for linked_product in combined_listings_metafield.value
                                      if linked_product.id == combo_product_id_as_number
                                        assign matching_product_for_fallback = linked_product
                                        break
                                      endif
                                    endfor
                                  endif
                                  
                                  if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                                    assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                                    
                                    # Build variant name from all available options for this product
                                    assign variant_name_parts = ''
                                    for option in matching_product_for_fallback.options_with_values
                                      if option.values.size > 0
                                        assign first_value = option.values.first
                                        if first_value != blank
                                          if variant_name_parts == ''
                                            assign variant_name_parts = first_value.name
                                          else
                                            assign variant_name_parts = variant_name_parts | append: ' / ' | append: first_value.name
                                          endif
                                        endif
                                      endif
                                    endfor
                                    
                                    # Use variant name as option value name
                                    if variant_name_parts != blank
                                      assign option_value_name_for_swatch = variant_name_parts
                                    else
                                      assign option_value_name_for_swatch = matching_product_for_fallback.title
                                    endif
                                    
                                    assign has_swatch_to_render = true
                                    break
                                  endif
                                endif
                              endif
                            endif
                          endfor
                        endif
                        
                        # Set featured media if we found the product
                        if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                          assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                        endif
                      endif
                      
                      # Standard swatch logic (only if not using product image mode)
                      unless show_product_image_swatches and has_swatch_to_render
                      
                      # Check current product first
                      for option in product_resource.options_with_values
                        assign option_name_lower = option.name | downcase | strip
                        if option_name_lower == 'color' or option_name_lower contains 'color'
                          for value in option.values
                            assign value_str = value | append: ''
                            if value_str == color_value_item
                              # Use the actual option value name for assets folder backup
                              assign option_value_name_for_swatch = value.name
                              
                              # Priority 1: Check for swatch (custom color or swatch image) - highest priority
                              if value.swatch != blank
                                if value.swatch.color != blank or value.swatch.image != blank
                                  assign swatch_to_render = value.swatch
                                endif
                              endif
                              
                              # Priority 2: Check for variant's custom image (only if no swatch found)
                              if swatch_to_render == blank
                                if value.variant.featured_media != blank
                                  assign variant_image_for_swatch = value.variant.featured_media
                                endif
                              endif
                              
                              # Store product for fallback if needed
                              if matching_product_for_fallback == ''
                                assign matching_product_for_fallback = product_resource
                              endif
                              
                              break
                            endif
                          endfor
                          if swatch_to_render != blank or variant_image_for_swatch != blank
                            break
                          endif
                        endif
                      endfor
                      
                      # If not found in current product, check linked products
                      if swatch_to_render == blank and variant_image_for_swatch == blank
                        if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                          for linked_product in combined_listings_metafield.value
                            for option in linked_product.options_with_values
                              assign option_name_lower = option.name | downcase | strip
                              if option_name_lower == 'color' or option_name_lower contains 'color'
                                for value in option.values
                                  assign value_str = value | append: ''
                                  if value_str == color_value_item
                                    # Use the actual option value name for assets folder backup
                                    assign option_value_name_for_swatch = value.name
                                    
                                    # Priority 1: Check for swatch (custom color or swatch image) - highest priority
                                    if value.swatch != blank
                                      if value.swatch.color != blank or value.swatch.image != blank
                                        assign swatch_to_render = value.swatch
                                      endif
                                    endif
                                    
                                    # Priority 2: Check for variant's custom image (only if no swatch found)
                                    if swatch_to_render == blank
                                      if value.variant.featured_media != blank
                                        assign variant_image_for_swatch = value.variant.featured_media
                                      endif
                                    endif
                                    
                                    # Store product for fallback if needed
                                    if matching_product_for_fallback == ''
                                      assign matching_product_for_fallback = linked_product
                                    endif
                                    
                                    break
                                  endif
                                endfor
                                if swatch_to_render != blank or variant_image_for_swatch != blank
                                  break
                                endif
                              endif
                            endfor
                            if swatch_to_render != blank or variant_image_for_swatch != blank
                              break
                            endif
                          endfor
                        endif
                      endif
                      
                      # Priority 3: If no swatch or variant image found, fall back to product's first image
                      if swatch_to_render == blank and variant_image_for_swatch == blank
                        if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                          assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                        endif
                      endif
                      
                      # Check assets folder for backup swatch file (Priority 1 in swatch.liquid)
                      assign assets_file_exists = false
                      if option_value_name_for_swatch != blank
                        assign enable_backup = settings.enable_swatch_assets_backup
                        if enable_backup == blank
                          assign enable_backup = true
                        endif
                        
                        if enable_backup
                          assign swatch_file_extension = settings.swatch_file_extension | default: 'png'
                          assign color_file_name = option_value_name_for_swatch | handle | append: '.' | append: swatch_file_extension
                          if images[color_file_name] != blank
                            assign assets_file_exists = true
                          endif
                        endif
                      endif
                      
                      # Set has_swatch_to_render - include assets folder check
                      assign has_swatch_to_render = false
                      if swatch_to_render != blank
                        # We have a swatch with color or image
                        assign has_swatch_to_render = true
                      elsif variant_image_for_swatch != blank
                        # We have a variant image or product fallback image
                        assign has_swatch_to_render = true
                      elsif assets_file_exists
                        # Assets folder file exists - swatch.liquid will handle rendering it
                        assign has_swatch_to_render = true
                      endif
                      endunless
                      
                      # Check if this color has the currently selected size available
                      # If a size is selected, check if this color has that size
                      assign color_is_available = true
                      assign is_product_page = false
                      if request.page_type == 'product'
                        assign is_product_page = true
                      endif
                      
                      if current_size_value != blank and current_size_value != '' and is_product_page == false
                        assign color_has_size = false
                        if dual_variant_data != ''
                          assign combinations_check = dual_variant_data | split: '|||'
                          for combination_entry in combinations_check
                            if combination_entry != blank and combination_entry != ''
                              assign combo_parts = combination_entry | split: '|'
                              if combo_parts.size >= 7
                                assign combo_color = combo_parts[2] | strip
                                assign combo_size = combo_parts[3] | strip
                                
                                # Reconstruct combined color from stored values
                                assign combo_combined_color = combo_color
                                if combo_size != blank and combo_size != ''
                                  assign combo_combined_color = combo_color | append: ' / ' | append: combo_size
                                endif
                                
                                assign color_value_normalized = color_value_item | strip
                                
                                # Check if combined colors match
                                if combo_combined_color == color_value_normalized
                                  assign color_has_size = true
                                  break
                                endif
                              endif
                            endif
                          endfor
                        endif
                        if color_has_size == false
                          assign color_is_available = false
                        endif
                      endif
                      
                      # Find the first available variant for this color to get variant ID and URL
                      # Also find the first variant (available or not) for navigation purposes
                      assign first_available_variant_id = ''
                      assign first_available_variant_url = ''
                      assign first_variant_id = ''
                      assign first_variant_url = ''
                      assign variant_for_hover = ''
                      if dual_variant_data != ''
                        assign combinations_check = dual_variant_data | split: '|||'
                        for combination_entry in combinations_check
                          if combination_entry != blank and combination_entry != ''
                            assign combo_parts = combination_entry | split: '|'
                            if combo_parts.size >= 7
                              assign combo_color = combo_parts[2] | strip
                              assign combo_size = combo_parts[3] | strip
                              assign combo_variant_id = combo_parts[1] | strip
                              assign combo_url = combo_parts[5] | strip
                              assign combo_available = combo_parts[6] | strip
                              
                              # Reconstruct combined color value from stored frame + lens
                              assign combo_combined_color = combo_color
                              if combo_size != blank and combo_size != ''
                                assign combo_combined_color = combo_color | append: ' / ' | append: combo_size
                              endif
                              
                              assign color_value_normalized = color_value_item | strip
                              
                              # Set first variant (for navigation) if not set yet - match against combined color
                              if combo_combined_color == color_value_normalized and first_variant_id == blank
                                assign first_variant_id = combo_variant_id
                                assign first_variant_url = combo_url
                              endif
                              
                              if combo_combined_color == color_value_normalized and combo_available == 'true'
                                assign first_available_variant_id = combo_variant_id
                                assign first_available_variant_url = combo_url
                                
                                # Try to find the actual variant object for hover preview
                                if matching_product_for_fallback != ''
                                  assign variant_id_as_number = combo_variant_id | plus: 0
                                  assign variant_id_as_string = combo_variant_id | append: ''
                                  for variant in matching_product_for_fallback.variants
                                    if variant.id == variant_id_as_number or variant.id == variant_id_as_string or variant.id == combo_variant_id
                                      assign variant_for_hover = variant
                                      break
                                    endif
                                  endfor
                                endif
                                
                                # If not found in matching product, check all linked products
                                if variant_for_hover == blank
                                  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                                    for linked_product in combined_listings_metafield.value
                                      assign variant_id_as_number = combo_variant_id | plus: 0
                                      assign variant_id_as_string = combo_variant_id | append: ''
                                      for variant in linked_product.variants
                                        if variant.id == variant_id_as_number or variant.id == variant_id_as_string or variant.id == combo_variant_id
                                          assign variant_for_hover = variant
                                          break
                                        endif
                                      endfor
                                      if variant_for_hover != blank
                                        break
                                      endif
                                    endfor
                                  endif
                                endif
                                
                                break
                              endif
                            endif
                          endif
                        endfor
                      endif
                      
                      if is_product_page or current_size_value == blank or current_size_value == ''
                        if first_available_variant_id == blank or first_available_variant_id == ''
                          assign color_is_available = false
                        else
                          assign color_is_available = true
                        endif
                      endif
                      
                      # Find the product that this color variant belongs to (for hover preview)
                      # For combined listings, each color represents a different product, so we need the product's featured media
                      assign hover_product = matching_product_for_fallback
                      if variant_for_hover != blank
                        # Find which product this variant belongs to by checking the combo URL
                        if first_available_variant_url != blank
                          # Extract product ID from URL or find product by variant
                          if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                            for linked_product in combined_listings_metafield.value
                              # Check if this product's URL matches the variant URL
                              assign linked_product_url = linked_product.url | append: ''
                              assign variant_url_base = first_available_variant_url | split: '?' | first
                              if linked_product_url == variant_url_base or first_available_variant_url contains linked_product_url
                                assign hover_product = linked_product
                                break
                              endif
                              # Also check by variant ID
                              for variant in linked_product.variants
                                if variant.id == variant_for_hover.id
                                  assign hover_product = linked_product
                                  break
                                endif
                              endfor
                              if hover_product != matching_product_for_fallback
                                break
                              endif
                            endfor
                          endif
                        endif
                      endif
                      
                      # Get featured media for hover preview - prioritize product's featured media (main product image)
                      # This ensures we show the correct product image for each color on hover
                      assign featured_media = ''
                      if hover_product != '' and hover_product != matching_product_for_fallback and hover_product.featured_media != blank
                        # Use the product's featured media (this is the main product image for that color)
                        assign featured_media = hover_product.featured_media
                      elsif variant_for_hover != blank and variant_for_hover.featured_media != blank
                        # Fallback to variant's featured media if product media not available
                        assign featured_media = variant_for_hover.featured_media
                      elsif matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                        # Use matching product's featured media as fallback
                        assign featured_media = matching_product_for_fallback.featured_media
                      elsif variant_image_for_swatch != blank
                        assign featured_media = variant_image_for_swatch
                      endif
                    %}
                    
                    <li class="variant-option__swatch">
                      <label
                        {% if featured_media != blank %}
                          data-media-id="{{ featured_media.id }}"
                        {% endif %}
                        data-option-available="{{ color_is_available }}"
                        {% if featured_media != blank and featured_media.preview_image != blank %}
                          data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                        {% endif %}
                        class="variant-option__button-label variant-option__button-label--has-swatch {% if show_product_image_swatches %}variant-option__button-label--product-image variant-option__button-label--product-image-{{ product_image_swatch_style }}{% else %}swatch-rounded{% endif %}{% if is_current_color %} variant-option__button-label--current{% endif %}"
                        {% if featured_media != blank %}
                          on:pointerenter="product-card/previewVariant/{{ featured_media.id }}"
                          on:pointerleave="product-card/resetVariant"
                        {% endif %}
                      >
                        <input
                          type="radio"
                          id="cl-dual-color-{{ section.id }}-{{ block.id }}-{{ color_value_item | handleize }}-{{ product_id_for_color }}"
                          name="color_selection-{{ block.id }}"
                          value="{{ color_value_item | escape }}"
                          data-option-type="color"
                          data-fieldset-index="0"
                          data-input-index="{{ forloop.index0 }}"
                          data-previous-checked="false"
                          data-option-available="{{ color_is_available }}"
                          {% if featured_media != blank %}
                            data-option-media-id="{{ featured_media.id }}"
                          {% endif %}
                          {% if featured_media != blank and featured_media.preview_image != blank %}
                            data-featured-image-url="{{ featured_media.preview_image | image_url: width: 1200 }}"
                          {% endif %}
                          {%- liquid
                            # Use available variant if found, otherwise use first variant for navigation
                            assign variant_id_for_nav = first_available_variant_id
                            assign variant_url_for_nav = first_available_variant_url
                            if variant_id_for_nav == blank or variant_id_for_nav == ''
                              assign variant_id_for_nav = first_variant_id
                              assign variant_url_for_nav = first_variant_url
                            endif
                          -%}
                          {% if variant_url_for_nav != blank and variant_id_for_nav != blank %}
                            data-connected-product-url="{{ variant_url_for_nav }}?variant={{ variant_id_for_nav }}"
                          {% endif %}
                          {% if is_current_color %}
                            data-current-checked="true"
                            checked
                          {% else %}
                            data-current-checked="false"
                          {% endif %}
                          {% if color_is_available == false %}
                            aria-disabled="true"
                          {% endif %}
                          aria-label="{{ color_value_item | escape }}"
                          data-available-count="{% if color_is_available %}1{% else %}0{% endif %}"
                          data-variant-id="{{ variant_id_for_nav }}"
                          data-first-available-or-first-variant-id="{% if first_available_variant_id != blank %}{{ first_available_variant_id }}{% else %}{{ first_variant_id }}{% endif %}"
                        >
                        {% if has_swatch_to_render %}
                          {% if swatch_to_render != blank and show_product_image_swatches == false %}
                            {% render 'swatch',
                              swatch: swatch_to_render,
                              variant_image: featured_media,
                              option_value_name: option_value_name_for_swatch,
                              enable_swatch_assets_backup: swatch_enable_assets_backup,
                              swatch_file_extension: swatch_file_extension_setting,
                              show_variant_image: swatch_show_variant_image,
                              variant_swatch_width: swatch_variant_width
                            %}
                          {% else %}
                            {% render 'swatch',
                              swatch: blank,
                              variant_image: variant_image_for_swatch,
                              option_value_name: option_value_name_for_swatch,
                              enable_swatch_assets_backup: false,
                              swatch_file_extension: swatch_file_extension_setting,
                              show_variant_image: true,
                              variant_swatch_width: swatch_variant_width,
                              force_image_swatch: show_product_image_swatches
                            %}
                          {% endif %}
                          {% unless color_is_available %}
                            {% render 'variant-option-unavailable-line' %}
                          {% endunless %}
                        {% else %}
                          {% if color_is_available == true %}
                            <span class="variant-picker-cl-dual__pill"></span>
                          {% endif %}
                          <span class="variant-picker-cl-dual__text">{{ color_value_item | escape }}</span>
                        {% endif %}
                      </label>
                    </li>
                  {% endif %}
                  {%- endunless -%}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endcapture %}
        
       
        
        {% if show_product_image_swatches and show_horizontal_scroll %}
          <div class="swatches-scroll-wrapper swatches-scroll-wrapper--horizontal">
            <ul class="variant-option__swatches-list variant-option__swatches-list--horizontal-scroll" role="list">
              {{ children }}
            </ul>
          </div>
        {% else %}
          <ul class="variant-option__swatches-list" role="list">
            {{ children }}
          </ul>
        {% endif %}
      </fieldset>
      {%- else -%}
        {%- comment -%} Render colors as dropdowns or buttons based on variant_style {%- endcomment -%}
        {%- if variant_style_setting == 'dropdowns' -%}
          <div class="variant-option variant-option--dropdowns">
            {%- liquid
              # Determine if text labels should be shown for colors
              assign show_color_text_labels = false
              if request.page_type == 'product' or show_swatch_text_labels_setting
                assign show_color_text_labels = true
              endif
            -%}
            {%- if show_color_text_labels -%}
              <label for="Color-{{ product_resource.id }}-{{ block.id }}">{{ color_option_name | escape }}</label>
            {%- endif %}
            <div class="variant-option__select-wrapper">
              <select
                id="Color-{{ product_resource.id }}-{{ block.id }}"
                name="options[{{ color_option_name | escape }}]"
                class="variant-option__select"
              >
                {% assign colors_array = unique_colors | split: '|||' %}
                {% for color_value_item in colors_array %}
                  {%- liquid
                    assign color_value_str = color_value_item | append: ''
                    assign should_skip_color = false
                    if color_value_item == blank or color_value_item == 0 or color_value_str == '' or color_value_str == '0' or color_value_str == 'null'
                      assign should_skip_color = true
                    endif
                  -%}
                  {%- unless should_skip_color -%}
                    {% capture combined_color_availability_result %}{% render 'util-combined-availability', dual_variant_data: dual_variant_data, option_value: color_value_item, match_type: 'combined_color' %}{% endcapture %}
                    {% assign combined_color_parts = combined_color_availability_result | strip | split: '|' %}
                    {% assign first_available_variant_id = combined_color_parts[0] %}
                    {% assign first_available_variant_url = combined_color_parts[1] %}
                    {% assign color_is_available = false %}
                    {% if combined_color_parts[2] == 'true' %}
                      {% assign color_is_available = true %}
                    {% endif %}
                    <option
                      value="{{ color_value_item | escape }}"
                      data-input-id="1-{{ forloop.index0 }}"
                      data-variant-id="{{ first_available_variant_id }}"
                      {% if first_available_variant_url != blank %}
                        data-connected-product-url="{{ first_available_variant_url }}"
                      {% endif %}
                      {% if color_value_item == current_color_value %}
                        selected="selected"
                      {% endif %}
                      {% unless color_is_available %}
                        disabled
                      {% endunless %}
                    >
                      {% if color_is_available == false %}
                        {{ color_value_item | escape }} - {{ 'content.unavailable' | t }}
                      {% else %}
                        {{ color_value_item | escape }}
                      {% endif %}
                    </option>
                  {%- endunless -%}
                {% endfor %}
              </select>
              <svg
                aria-hidden="true"
                focusable="false"
                class="icon icon-caret"
                viewBox="0 0 10 6"
              >
                {%- render 'icon', icon: 'caret' -%}
              </svg>
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Render colors as buttons {%- endcomment -%}
          <fieldset class="variant-option variant-option--buttons">
            {%- liquid
              # Determine if text labels should be shown for colors
              assign show_color_text_labels = false
              if request.page_type == 'product' or show_swatch_text_labels_setting
                assign show_color_text_labels = true
              endif
            -%}
            {%- if show_color_text_labels -%}
              <legend>
                {{ color_option_name | escape }}:
                {%- if current_color_value != blank and current_color_value != '' -%}
                  <span class="variant-option__swatch-value">{{ current_color_value | escape }}</span>
                {%- endif %}
              </legend>
            {%- endif %}
            {% assign colors_array = unique_colors | split: '|||' %}
            {% for color_value_item in colors_array %}
              {%- liquid
                assign color_value_str = color_value_item | append: ''
                assign should_skip_color = false
                if color_value_item == blank or color_value_item == 0 or color_value_str == '' or color_value_str == '0' or color_value_str == 'null'
                  assign should_skip_color = true
                endif
              -%}
              {%- unless should_skip_color -%}
                {%- liquid
                  assign is_current_color = false
                  if color_value_item == current_color_value
                    assign is_current_color = true
                  endif
                -%}
                {% capture color_availability_result %}{% render 'util-combined-availability', dual_variant_data: dual_variant_data, option_value: color_value_item, match_type: 'color' %}{% endcapture %}
                {% assign color_availability_parts = color_availability_result | strip | split: '|' %}
                {% assign first_available_variant_id = color_availability_parts[0] %}
                {% assign first_available_variant_url = color_availability_parts[1] %}
                {% assign color_is_available = false %}
                {% if color_availability_parts[2] == 'true' %}
                  {% assign color_is_available = true %}
                {% endif %}
                <label
                  data-option-available="{{ color_is_available }}"
                  class="variant-option__button-label"
                  {% if first_available_variant_url != blank %}
                    on:pointerenter="product-card/previewVariant/{{ first_available_variant_id }}"
                    on:pointerleave="product-card/resetVariant"
                  {% endif %}
                >
                  <input
                    type="radio"
                    name="{{ color_option_name | escape }}-{{ product_resource.id }}-button"
                    value="{{ color_value_item | escape }}"
                    aria-label="{{ color_value_item | escape }}"
                    data-input-id="1-{{ forloop.index0 }}"
                    data-option-available="{{ color_is_available }}"
                    {% if first_available_variant_url != blank and first_available_variant_id != blank %}
                      data-connected-product-url="{{ first_available_variant_url }}?variant={{ first_available_variant_id }}"
                    {% endif %}
                    {% if is_current_color %}
                      checked
                    {% endif %}
                    data-available-count="{% if color_is_available %}1{% else %}0{% endif %}"
                    data-variant-id="{{ first_available_variant_id }}"
                    data-first-available-or-first-variant-id="{{ first_available_variant_id }}"
                  >
                  <span class="variant-option__button-label__text">{{ color_value_item | escape }}</span>
                </label>
              {%- endunless -%}
            {% endfor %}
          </fieldset>
        {%- endif -%}
      {%- endif -%}
      
      {%- liquid
        # Only show sizes on product pages
        # On collection/category pages (product cards), always hide sizes
        assign is_product_page = false
        if request.page_type == 'product'
          assign is_product_page = true
        endif
        
        # Show sizes only if: on product page AND show_size_swatches is enabled
        # BUT if product image swatches mode is enabled, hide secondary options (they're shown on target product)
        assign should_show_sizes = false
        if is_product_page and show_size_swatches_setting and show_product_image_swatches == false
          assign should_show_sizes = true
        endif
      -%}
      
      {% comment %} Size Picker {% endcomment %}
      {% liquid
        # Calculate longest size value for button width distribution
        assign longest_size_value = 0
        assign size_fieldset_id = ''
        assign size_option_id_attribute = ''
        if settings.variant_button_width == 'equal-width-buttons'
          assign size_fieldset_id = section.id | append: '-' | append: product_resource.id | append: '-' | append: size_option_name | handleize
          assign size_option_id_attribute = 'data-option-id="' | append: size_fieldset_id | append: '"'
          assign sizes_array_for_length = unique_sizes | split: '|||'
          for size_value_check in sizes_array_for_length
            if size_value_check != blank and size_value_check != ''
              assign size_length = size_value_check.size
              if size_length > longest_size_value
                assign longest_size_value = size_length
              endif
            endif
          endfor
        endif
      %}
      {%- liquid
        # Only show sizes on product pages
        # On collection/category pages (product cards), always hide sizes
        # BUT if product image swatches mode is enabled, hide secondary options (they're shown on target product)
        assign is_product_page = false
        if request.page_type == 'product'
          assign is_product_page = true
        endif
        
        # Show sizes only if: on product page AND not in product image swatch mode
        assign should_show_sizes = false
        if is_product_page and show_product_image_swatches == false
          assign should_show_sizes = true
        endif
      -%}
      {%- if unique_sizes != '' and size_option_name != '' and should_show_sizes -%}
        {%- if option2_is_color_like and use_swatches -%}
          <fieldset class="variant-option variant-option--buttons variant-option--swatches">
          {%- liquid
            assign is_product_page = false
            if request.page_type == 'product'
              assign is_product_page = true
            endif
            
            assign show_text_labels = false
            if is_product_page
              assign show_text_labels = true
            elsif show_swatch_text_labels_setting
              assign show_text_labels = true
            endif
          -%}
          {%- if show_text_labels -%}
            <legend>
              {{ size_option_name | escape }}:
              {%- if current_size_value != blank and current_size_value != '' -%}
                <span class="variant-option__swatch-value">{{ current_size_value | escape }}</span>
              {%- endif %}
            </legend>
          {%- endif %}
          {% capture children %}
            {% assign sizes_array = unique_sizes | split: '|||' %}
            {% for size_value_item in sizes_array %}
              {%- liquid
                assign size_value_str = size_value_item | append: ''
                assign should_skip_size = false
                if size_value_item == blank or size_value_item == 0 or size_value_str == '' or size_value_str == '0' or size_value_str == 'null'
                  assign should_skip_size = true
                endif
              -%}
              {%- unless should_skip_size -%}
              {% if size_value_item != blank and size_value_item != '' %}
                {% liquid
                  assign is_current_size = false
                  if size_value_item == current_size_value
                    assign is_current_size = true
                  endif
                  
                  assign swatch_to_render = ''
                  assign variant_image_for_swatch = ''
                  assign matching_product_for_fallback = ''
                  assign option_value_name_for_swatch = size_value_item
                  
                  for option in product_resource.options_with_values
                    if option.name == size_option_name
                      for value in option.values
                        assign value_str = value | append: ''
                        if value_str == size_value_item
                          assign option_value_name_for_swatch = value.name
                          
                          if value.swatch != blank
                            if value.swatch.color != blank or value.swatch.image != blank
                              assign swatch_to_render = value.swatch
                            endif
                          endif
                          
                          if swatch_to_render == blank
                            if value.variant.featured_media != blank
                              assign variant_image_for_swatch = value.variant.featured_media
                            endif
                          endif
                          
                          if matching_product_for_fallback == ''
                            assign matching_product_for_fallback = product_resource
                          endif
                          
                          break
                        endif
                      endfor
                      if swatch_to_render != blank or variant_image_for_swatch != blank
                        break
                      endif
                    endif
                  endfor
                  
                  if swatch_to_render == blank and variant_image_for_swatch == blank
                    if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                      for linked_product in combined_listings_metafield.value
                        for option in linked_product.options_with_values
                          if option.name == size_option_name
                            for value in option.values
                              assign value_str = value | append: ''
                              if value_str == size_value_item
                                assign option_value_name_for_swatch = value.name
                                
                                if value.swatch != blank
                                  if value.swatch.color != blank or value.swatch.image != blank
                                    assign swatch_to_render = value.swatch
                                  endif
                                endif
                                
                                if swatch_to_render == blank
                                  if value.variant.featured_media != blank
                                    assign variant_image_for_swatch = value.variant.featured_media
                                  endif
                                endif
                                
                                if matching_product_for_fallback == ''
                                  assign matching_product_for_fallback = linked_product
                                endif
                                
                                break
                              endif
                            endfor
                            if swatch_to_render != blank or variant_image_for_swatch != blank
                              break
                            endif
                          endif
                        endfor
                        if swatch_to_render != blank or variant_image_for_swatch != blank
                          break
                        endif
                      endfor
                    endif
                  endif
                  
                  if swatch_to_render == blank and variant_image_for_swatch == blank
                    if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                      assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                    endif
                  endif
                  
                  assign assets_file_exists = false
                  if option_value_name_for_swatch != blank
                    assign enable_backup = settings.enable_swatch_assets_backup
                    if enable_backup == blank
                      assign enable_backup = true
                    endif
                    
                    if enable_backup
                      assign swatch_file_extension = settings.swatch_file_extension | default: 'png'
                      assign color_file_name = option_value_name_for_swatch | handle | append: '.' | append: swatch_file_extension
                      if images[color_file_name] != blank
                        assign assets_file_exists = true
                      endif
                    endif
                  endif
                  
                  assign has_swatch_to_render = false
                  if swatch_to_render != blank
                    assign has_swatch_to_render = true
                  elsif variant_image_for_swatch != blank
                    assign has_swatch_to_render = true
                  elsif assets_file_exists
                    assign has_swatch_to_render = true
                  endif
                  
                  assign size_is_available = true
                  if current_color_value != blank and current_color_value != ''
                    assign size_has_color = false
                    if dual_variant_data != ''
                      assign combinations_check = dual_variant_data | split: '|||'
                      for combination_entry in combinations_check
                        if combination_entry != blank and combination_entry != ''
                          assign combo_parts = combination_entry | split: '|'
                          if combo_parts.size >= 7
                            assign combo_size = combo_parts[3] | strip
                            assign combo_color = combo_parts[2] | strip
                            assign size_value_normalized = size_value_item | strip
                            assign current_color_normalized = current_color_value | strip
                            
                            if combo_size == size_value_normalized and combo_color == current_color_normalized
                              assign size_has_color = true
                              break
                            endif
                          endif
                        endif
                      endfor
                    endif
                    if size_has_color == false
                      assign size_is_available = false
                    endif
                  endif
                %}
                  {% capture size_availability_result %}{% render 'util-combined-availability', dual_variant_data: dual_variant_data, option_value: size_value_item, match_type: 'size' %}{% endcapture %}
                  {% assign size_availability_parts = size_availability_result | strip | split: '|' %}
                  {% assign first_available_variant_id = size_availability_parts[0] %}
                  {% assign first_available_variant_url = size_availability_parts[1] %}
                {% liquid
                  # OVERRIDE: If no specific color is selected, determine size availability based on whether
                  # we found ANY available variant for this size (first_available_variant_id)
                  if current_color_value == blank or current_color_value == ''
                    if first_available_variant_id == blank or first_available_variant_id == ''
                      assign size_is_available = false
                    else
                      assign size_is_available = true
                    endif
                  endif
                  
                  assign featured_media = variant_image_for_swatch
                  if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank and featured_media == blank
                    assign featured_media = matching_product_for_fallback.featured_media
                  endif
                %}
                
                <li class="variant-option__swatch">
                  <label
                    {% if featured_media != blank %}
                      data-media-id="{{ featured_media.id }}"
                    {% endif %}
                    data-option-available="{{ size_is_available }}"
                    class="variant-option__button-label variant-option__button-label--has-swatch swatch-rounded{% if is_current_size %} variant-option__button-label--current{% endif %}"
                    {% if featured_media != blank %}
                      on:pointerenter="product-card/previewVariant/{{ featured_media.id }}"
                      on:pointerleave="product-card/resetVariant"
                    {% endif %}
                  >
                    <input
                      type="radio"
                      id="cl-dual-size-{{ section.id }}-{{ block.id }}-{{ size_value_item | handleize }}"
                      name="size_selection-{{ block.id }}"
                      value="{{ size_value_item | escape }}"
                      data-option-type="size"
                      data-fieldset-index="1"
                      data-input-index="{{ forloop.index0 }}"
                      data-previous-checked="false"
                      data-option-available="{{ size_is_available }}"
                      {% if featured_media != blank %}
                        data-option-media-id="{{ featured_media.id }}"
                      {% endif %}
                      {% if first_available_variant_url != blank and first_available_variant_id != blank %}
                        data-connected-product-url="{{ first_available_variant_url }}?variant={{ first_available_variant_id }}"
                      {% endif %}
                      {% if is_current_size %}
                        data-current-checked="true"
                        checked
                      {% else %}
                        data-current-checked="false"
                      {% endif %}
                      {% if size_is_available == false %}
                        aria-disabled="true"
                      {% endif %}
                      aria-label="{{ size_value_item | escape }}"
                      data-available-count="{% if size_is_available %}1{% else %}0{% endif %}"
                      data-variant-id="{{ first_available_variant_id }}"
                      data-first-available-or-first-variant-id="{{ first_available_variant_id }}"
                    >
                    {% if has_swatch_to_render %}
                      {% if swatch_to_render != blank %}
                        {% render 'swatch',
                          swatch: swatch_to_render,
                          variant_image: featured_media,
                          option_value_name: option_value_name_for_swatch,
                          enable_swatch_assets_backup: swatch_enable_assets_backup,
                          swatch_file_extension: swatch_file_extension_setting,
                          show_variant_image: swatch_show_variant_image,
                          variant_swatch_width: swatch_variant_width
                        %}
                      {% else %}
                        {% render 'swatch',
                          swatch: blank,
                          variant_image: featured_media,
                          option_value_name: option_value_name_for_swatch,
                          enable_swatch_assets_backup: swatch_enable_assets_backup,
                          swatch_file_extension: swatch_file_extension_setting,
                          show_variant_image: swatch_show_variant_image,
                          variant_swatch_width: swatch_variant_width
                        %}
                      {% endif %}
                      {% unless size_is_available %}
                        {% render 'variant-option-unavailable-line' %}
                      {% endunless %}
                    {% else %}
                      {% if size_is_available == true %}
                        <span class="variant-picker-cl-dual__pill"></span>
                      {% endif %}
                      <span class="variant-picker-cl-dual__text">{{ size_value_item | escape }}</span>
                    {% endif %}
                  </label>
                </li>
              {% endif %}
              {%- endunless -%}
            {% endfor %}
            <li
              slot="more"
            >
              <button
                class="hidden-swatches__count"
                aria-label="{{ 'actions.show_all_options' | t }}"
                on:click="/showAllSwatches"
              ></button>
            </li>
          {% endcapture %}
          {% render 'overflow-list', children: children, ref: 'overflowList', defer: true %}
          </fieldset>
        {%- elsif variant_style_setting == 'dropdowns' -%}
          {%- comment -%} Render sizes as dropdown {%- endcomment -%}
          <div class="variant-option variant-option--dropdowns">
            <label for="Size-{{ product_resource.id }}-{{ block.id }}">{{ size_option_name | escape }}</label>
            <div class="variant-option__select-wrapper">
              <select
                id="Size-{{ product_resource.id }}-{{ block.id }}"
                name="options[{{ size_option_name | escape }}]"
                class="variant-option__select"
              >
                {% assign sizes_array = unique_sizes | split: '|||' %}
                {% for size_value_item in sizes_array %}
                  {%- liquid
                    assign size_value_str = size_value_item | append: ''
                    assign should_skip_size = false
                    if size_value_item == blank or size_value_item == 0 or size_value_str == '' or size_value_str == '0' or size_value_str == 'null'
                      assign should_skip_size = true
                    endif
                  -%}
                  {%- unless should_skip_size -%}
                    {%- liquid
                      assign size_is_available = false
                      assign first_available_size_variant_id = ''
                      assign first_available_size_variant_url = ''
                      if dual_variant_data != ''
                        assign combinations_check = dual_variant_data | split: '|||'
                        for combination_entry in combinations_check
                          if combination_entry != blank and combination_entry != ''
                            assign combo_parts = combination_entry | split: '|'
                            if combo_parts.size >= 7
                              assign combo_size = combo_parts[3] | strip
                              assign combo_color = combo_parts[2] | strip
                              assign combo_available = combo_parts[6] | strip

                              if combo_size == size_value_item
                                if current_color_value != blank and current_color_value != ''
                                  if combo_color == current_color_value and combo_available == 'true'
                                    assign size_is_available = true
                                    assign first_available_size_variant_id = combo_parts[1] | strip
                                    assign first_available_size_variant_url = combo_parts[5] | strip
                                    break
                                  endif
                                else
                                  if combo_available == 'true'
                                    assign size_is_available = true
                                    assign first_available_size_variant_id = combo_parts[1] | strip
                                    assign first_available_size_variant_url = combo_parts[5] | strip
                                    break
                                  endif
                                endif
                              endif
                            endif
                          endif
                        endfor
                      endif
                    -%}
                    <option
                      value="{{ size_value_item | escape }}"
                      data-input-id="2-{{ forloop.index0 }}"
                      data-option-value-id="{{ first_available_size_variant_id }}"
                      data-variant-id="{{ first_available_size_variant_id }}"
                      {% if first_available_size_variant_url != blank %}
                        data-connected-product-url="{{ first_available_size_variant_url }}"
                      {% endif %}
                      {% if size_value_item == current_size_value %}
                        selected="selected"
                      {% endif %}
                      {% if size_is_available == false %}
                        disabled
                      {% endif %}
                    >
                      {% if size_is_available == false %}
                        {{ size_value_item | escape }} - {{ 'content.unavailable' | t }}
                      {% else %}
                        {{ size_value_item | escape }}
                      {% endif %}
                    </option>
                  {%- endunless -%}
                {% endfor %}
              </select>
              <svg
                aria-hidden="true"
                focusable="false"
                class="icon icon-caret"
                viewBox="0 0 10 6"
              >
                {%- render 'icon', icon: 'caret' -%}
              </svg>
            </div>
          </div>
        {%- else -%}
          {%- comment -%} Render sizes as buttons {%- endcomment -%}
          <fieldset 
            class="variant-picker-cl-dual__fieldset variant-picker-cl-dual__fieldset--size{% if settings.variant_button_width == 'equal-width-buttons' %} variant-picker-cl-dual__fieldset--equal-width-buttons{% endif %}"
            {{ size_option_id_attribute }}
          >
            <legend>
              {{ size_option_name | escape }}
              {%- if current_size_value != blank and current_size_value != '' -%}
                <span class="variant-picker-cl-dual__swatch-value">{{ current_size_value | escape }}</span>
              {%- endif %}
            </legend>
            {% if size_option_id_attribute and longest_size_value > 0 %}
              {% style %}
                [data-option-id="{{ size_fieldset_id }}"] {
                  --variant-ch: {{ longest_size_value }}ch;
                }
              {% endstyle %}
            {% endif %}
            <div 
              class="variant-picker-cl-dual__options" 
              data-option-type="size" 
              data-fieldset-index="1"
            >
              {% assign sizes_array = unique_sizes | split: '|||' %}
              {% for size_value_item in sizes_array %}
            {%- liquid
              # Skip option values that are blank, null, 0 (number), "0" (string), or "null" (string)
              assign size_value_str = size_value_item | append: ''
              assign should_skip_size = false
              if size_value_item == blank or size_value_item == 0 or size_value_str == '' or size_value_str == '0' or size_value_str == 'null'
                assign should_skip_size = true
              endif
            -%}
            {%- unless should_skip_size -%}
            {% if size_value_item != blank and size_value_item != '' %}
              {% liquid
                assign is_current_size = false
                if size_value_item == current_size_value
                  assign is_current_size = true
                endif
                
                # Check if this size has any available combinations
                # If a color is selected, check combinations with that color
                # Otherwise, check all combinations for this size
                assign size_is_available = false
                if dual_variant_data != ''
                  assign combinations_check = dual_variant_data | split: '|||'
                  for combination_entry in combinations_check
                    if combination_entry != blank and combination_entry != ''
                      assign combo_parts = combination_entry | split: '|'
                      if combo_parts.size >= 7
                        assign combo_size = combo_parts[3]
                        assign combo_color = combo_parts[2]
                        assign combo_available = combo_parts[6]
                        
                        # Check if this size matches
                        if combo_size == size_value_item
                          # If color is selected, only check combinations with that color
                          if current_color_value != blank and current_color_value != ''
                            if combo_color == current_color_value and combo_available == 'true'
                              assign size_is_available = true
                              break
                            endif
                          else
                            # No color selected, check if any combination with this size is available
                            if combo_available == 'true'
                              assign size_is_available = true
                              break
                            endif
                          endif
                        endif
                      endif
                    endif
                  endfor
                endif
              %}
              
              <label
                class="variant-picker-cl-dual__label{% if is_current_size %} variant-picker-cl-dual__label--current{% endif %}"
                {% if size_is_available == false %}
                  data-option-available="false"
                {% else %}
                  data-option-available="true"
                {% endif %}
              >
                <input
                  type="radio"
                  id="cl-dual-size-{{ section.id }}-{{ block.id }}-{{ size_value_item | handleize }}"
                  name="size_selection-{{ block.id }}"
                  value="{{ size_value_item | escape }}"
                  data-option-type="size"
                  data-fieldset-index="1"
                  data-input-index="{{ forloop.index0 }}"
                  data-previous-checked="false"
                  data-option-available="{{ size_is_available }}"
                  {% if first_available_variant_url != blank and first_available_variant_id != blank %}
                    data-connected-product-url="{{ first_available_variant_url }}?variant={{ first_available_variant_id }}"
                  {% endif %}
                  {% if is_current_size %}
                    data-current-checked="true"
                    checked
                  {% else %}
                    data-current-checked="false"
                  {% endif %}
                  {% if size_is_available == false %}
                    aria-disabled="true"
                  {% endif %}
                  aria-label="{{ size_value_item | escape }}"
                >
                {% if size_is_available == true %}
                  <span class="variant-picker-cl-dual__pill"></span>
                {% endif %}
                <span class="variant-picker-cl-dual__text">{{ size_value_item | escape }}</span>
                {% unless size_is_available %}
                  {% render 'variant-option-unavailable-line' %}
                {% endunless %}
              </label>
            {% endif %}
            {%- endunless -%}
          {% endfor %}
            </div>
          </fieldset>
        {%- endif -%}
      {%- endif -%}
      
      {%- if unique_option3_values != '' and option3_name != '' and should_show_sizes -%}
        {%- if option3_is_color_like and use_swatches -%}
          <fieldset class="variant-option variant-option--buttons variant-option--swatches">
          {%- liquid
            assign is_product_page = false
            if request.page_type == 'product'
              assign is_product_page = true
            endif
            
            assign show_text_labels = false
            if is_product_page
              assign show_text_labels = true
            elsif show_swatch_text_labels_setting
              assign show_text_labels = true
            endif
          -%}
          {%- if show_text_labels -%}
            <legend>
              {{ option3_name | escape }}:
              {%- if current_option3_value != blank and current_option3_value != '' -%}
                <span class="variant-option__swatch-value">{{ current_option3_value | escape }}</span>
              {%- endif %}
            </legend>
          {%- endif %}
          {% capture children %}
            {% assign option3_array = unique_option3_values | split: '|||' %}
            {% for option3_value_item in option3_array %}
              {%- liquid
                assign option3_value_str = option3_value_item | append: ''
                assign should_skip_option3 = false
                if option3_value_item == blank or option3_value_item == 0 or option3_value_str == '' or option3_value_str == '0' or option3_value_str == 'null'
                  assign should_skip_option3 = true
                endif
              -%}
              {%- unless should_skip_option3 -%}
              {% if option3_value_item != blank and option3_value_item != '' %}
                {% liquid
                  assign is_current_option3 = false
                  if option3_value_item == current_option3_value
                    assign is_current_option3 = true
                  endif
                  
                  assign swatch_to_render = ''
                  assign variant_image_for_swatch = ''
                  assign matching_product_for_fallback = ''
                  assign option_value_name_for_swatch = option3_value_item
                  
                  for option in product_resource.options_with_values
                    if option.name == option3_name
                      for value in option.values
                        assign value_str = value | append: ''
                        if value_str == option3_value_item
                          assign option_value_name_for_swatch = value.name
                          
                          if value.swatch != blank
                            if value.swatch.color != blank or value.swatch.image != blank
                              assign swatch_to_render = value.swatch
                            endif
                          endif
                          
                          if swatch_to_render == blank
                            if value.variant.featured_media != blank
                              assign variant_image_for_swatch = value.variant.featured_media
                            endif
                          endif
                          
                          if matching_product_for_fallback == ''
                            assign matching_product_for_fallback = product_resource
                          endif
                          
                          break
                        endif
                      endfor
                      if swatch_to_render != blank or variant_image_for_swatch != blank
                        break
                      endif
                    endif
                  endfor
                  
                  if swatch_to_render == blank and variant_image_for_swatch == blank
                    if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                      for linked_product in combined_listings_metafield.value
                        for option in linked_product.options_with_values
                          if option.name == option3_name
                            for value in option.values
                              assign value_str = value | append: ''
                              if value_str == option3_value_item
                                assign option_value_name_for_swatch = value.name
                                
                                if value.swatch != blank
                                  if value.swatch.color != blank or value.swatch.image != blank
                                    assign swatch_to_render = value.swatch
                                  endif
                                endif
                                
                                if swatch_to_render == blank
                                  if value.variant.featured_media != blank
                                    assign variant_image_for_swatch = value.variant.featured_media
                                  endif
                                endif
                                
                                if matching_product_for_fallback == ''
                                  assign matching_product_for_fallback = linked_product
                                endif
                                
                                break
                              endif
                            endfor
                            if swatch_to_render != blank or variant_image_for_swatch != blank
                              break
                            endif
                          endif
                        endfor
                        if swatch_to_render != blank or variant_image_for_swatch != blank
                          break
                        endif
                      endfor
                    endif
                  endif
                  
                  if swatch_to_render == blank and variant_image_for_swatch == blank
                    if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank
                      assign variant_image_for_swatch = matching_product_for_fallback.featured_media
                    endif
                  endif
                  
                  assign assets_file_exists = false
                  if option_value_name_for_swatch != blank
                    assign enable_backup = settings.enable_swatch_assets_backup
                    if enable_backup == blank
                      assign enable_backup = true
                    endif
                    
                    if enable_backup
                      assign swatch_file_extension = settings.swatch_file_extension | default: 'png'
                      assign color_file_name = option_value_name_for_swatch | handle | append: '.' | append: swatch_file_extension
                      if images[color_file_name] != blank
                        assign assets_file_exists = true
                      endif
                    endif
                  endif
                  
                  assign has_swatch_to_render = false
                  if swatch_to_render != blank
                    assign has_swatch_to_render = true
                  elsif variant_image_for_swatch != blank
                    assign has_swatch_to_render = true
                  elsif assets_file_exists
                    assign has_swatch_to_render = true
                  endif
                  
                  assign option3_is_available = true
                  if current_color_value != blank and current_color_value != '' and current_size_value != blank and current_size_value != ''
                    assign option3_has_combination = false
                    if dual_variant_data != ''
                      assign combinations_check = dual_variant_data | split: '|||'
                      for combination_entry in combinations_check
                        if combination_entry != blank and combination_entry != ''
                          assign combo_parts = combination_entry | split: '|'
                          if combo_parts.size >= 7
                            assign combo_option3 = combo_parts[4] | strip
                            assign combo_size = combo_parts[3] | strip
                            assign combo_color = combo_parts[2] | strip
                            assign option3_value_normalized = option3_value_item | strip
                            assign current_size_normalized = current_size_value | strip
                            assign current_color_normalized = current_color_value | strip
                            
                            if combo_option3 == option3_value_normalized and combo_size == current_size_normalized and combo_color == current_color_normalized
                              assign option3_has_combination = true
                              break
                            endif
                          endif
                        endif
                      endfor
                    endif
                    if option3_has_combination == false
                      assign option3_is_available = false
                    endif
                  endif
                  
                  assign first_available_variant_id = ''
                  assign first_available_variant_url = ''
                  if dual_variant_data != ''
                    assign combinations_check = dual_variant_data | split: '|||'
                    for combination_entry in combinations_check
                      if combination_entry != blank and combination_entry != ''
                        assign combo_parts = combination_entry | split: '|'
                        if combo_parts.size >= 7
                          assign combo_option3 = combo_parts[4] | strip
                          assign combo_variant_id = combo_parts[1] | strip
                          assign combo_url = combo_parts[5] | strip
                          assign combo_available = combo_parts[6] | strip
                          assign option3_value_normalized = option3_value_item | strip
                          
                          if combo_option3 == option3_value_normalized and combo_available == 'true'
                            assign first_available_variant_id = combo_variant_id
                            assign first_available_variant_url = combo_url
                            break
                          endif
                        endif
                      endif
                    endfor
                  endif
                  
                  assign featured_media = variant_image_for_swatch
                  if matching_product_for_fallback != '' and matching_product_for_fallback.featured_media != blank and featured_media == blank
                    assign featured_media = matching_product_for_fallback.featured_media
                  endif
                %}
                
                <li class="variant-option__swatch">
                  <label
                    {% if featured_media != blank %}
                      data-media-id="{{ featured_media.id }}"
                    {% endif %}
                    data-option-available="{{ option3_is_available }}"
                    class="variant-option__button-label variant-option__button-label--has-swatch swatch-rounded{% if is_current_option3 %} variant-option__button-label--current{% endif %}"
                    {% if featured_media != blank %}
                      on:pointerenter="product-card/previewVariant/{{ featured_media.id }}"
                      on:pointerleave="product-card/resetVariant"
                    {% endif %}
                  >
                    <input
                      type="radio"
                      id="cl-dual-option3-{{ section.id }}-{{ block.id }}-{{ option3_value_item | handleize }}"
                      name="option3_selection-{{ block.id }}"
                      value="{{ option3_value_item | escape }}"
                      data-option-type="option3"
                      data-fieldset-index="2"
                      data-input-index="{{ forloop.index0 }}"
                      data-previous-checked="false"
                      data-option-available="{{ option3_is_available }}"
                      {% if featured_media != blank %}
                        data-option-media-id="{{ featured_media.id }}"
                      {% endif %}
                      {% if first_available_variant_url != blank and first_available_variant_id != blank %}
                        data-connected-product-url="{{ first_available_variant_url }}?variant={{ first_available_variant_id }}"
                      {% endif %}
                      {% if is_current_option3 %}
                        data-current-checked="true"
                        checked
                      {% else %}
                        data-current-checked="false"
                      {% endif %}
                      {% if option3_is_available == false %}
                        aria-disabled="true"
                      {% endif %}
                      aria-label="{{ option3_value_item | escape }}"
                      data-available-count="{% if option3_is_available %}1{% else %}0{% endif %}"
                      data-variant-id="{{ first_available_variant_id }}"
                      data-first-available-or-first-variant-id="{{ first_available_variant_id }}"
                    >
                    {% if has_swatch_to_render %}
                      {% if swatch_to_render != blank %}
                        {% render 'swatch',
                          swatch: swatch_to_render,
                          variant_image: featured_media,
                          option_value_name: option_value_name_for_swatch,
                          enable_swatch_assets_backup: swatch_enable_assets_backup,
                          swatch_file_extension: swatch_file_extension_setting,
                          show_variant_image: swatch_show_variant_image,
                          variant_swatch_width: swatch_variant_width
                        %}
                      {% else %}
                        {% render 'swatch',
                          swatch: blank,
                          variant_image: featured_media,
                          option_value_name: option_value_name_for_swatch,
                          enable_swatch_assets_backup: swatch_enable_assets_backup,
                          swatch_file_extension: swatch_file_extension_setting,
                          show_variant_image: swatch_show_variant_image,
                          variant_swatch_width: swatch_variant_width
                        %}
                      {% endif %}
                      {% unless option3_is_available %}
                        {% render 'variant-option-unavailable-line' %}
                      {% endunless %}
                    {% else %}
                      {% if option3_is_available == true %}
                        <span class="variant-picker-cl-dual__pill"></span>
                      {% endif %}
                      <span class="variant-picker-cl-dual__text">{{ option3_value_item | escape }}</span>
                    {% endif %}
                  </label>
                </li>
              {% endif %}
              {%- endunless -%}
            {% endfor %}
            <li
              slot="more"
            >
              <button
                class="hidden-swatches__count"
                aria-label="{{ 'actions.show_all_options' | t }}"
                on:click="/showAllSwatches"
              ></button>
            </li>
          {% endcapture %}
          {% render 'overflow-list', children: children, ref: 'overflowList', defer: true %}
          </fieldset>
        {%- elsif variant_style_setting == 'dropdowns' -%}
          {%- comment -%} Render option3 as dropdown {%- endcomment -%}
          <div class="variant-option variant-option--dropdowns">
            <label for="Option3-{{ product_resource.id }}-{{ block.id }}">{{ option3_name | escape }}</label>
            <div class="variant-option__select-wrapper">
              <select
                id="Option3-{{ product_resource.id }}-{{ block.id }}"
                name="options[{{ option3_name | escape }}]"
                class="variant-option__select"
              >
                {% assign option3_array = unique_option3_values | split: '|||' %}
                {% for option3_value_item in option3_array %}
                  {%- liquid
                    assign option3_value_str = option3_value_item | append: ''
                    assign should_skip_option3 = false
                    if option3_value_item == blank or option3_value_item == 0 or option3_value_str == '' or option3_value_str == '0' or option3_value_str == 'null'
                      assign should_skip_option3 = true
                    endif
                  -%}
                  {%- unless should_skip_option3 -%}
                    {%- liquid
                      assign option3_is_available = false
                      assign first_available_option3_variant_id = ''
                      assign first_available_option3_variant_url = ''
                      if dual_variant_data != ''
                        assign combinations_check = dual_variant_data | split: '|||'
                        for combination_entry in combinations_check
                          if combination_entry != blank and combination_entry != ''
                            assign combo_parts = combination_entry | split: '|'
                            if combo_parts.size >= 7
                              assign combo_option3 = combo_parts[4] | strip
                              assign combo_size = combo_parts[3] | strip
                              assign combo_color = combo_parts[2] | strip
                              assign combo_available = combo_parts[6] | strip

                              if combo_option3 == option3_value_item
                                if current_color_value != blank and current_color_value != '' and current_size_value != blank and current_size_value != ''
                                  if combo_color == current_color_value and combo_size == current_size_value and combo_available == 'true'
                                    assign option3_is_available = true
                                    assign first_available_option3_variant_id = combo_parts[1] | strip
                                    assign first_available_option3_variant_url = combo_parts[5] | strip
                                    break
                                  endif
                                else
                                  if combo_available == 'true'
                                    assign option3_is_available = true
                                    assign first_available_option3_variant_id = combo_parts[1] | strip
                                    assign first_available_option3_variant_url = combo_parts[5] | strip
                                    break
                                  endif
                                endif
                              endif
                            endif
                          endif
                        endfor
                      endif
                    -%}
                    <option
                      value="{{ option3_value_item | escape }}"
                      data-input-id="3-{{ forloop.index0 }}"
                      data-option-value-id="{{ first_available_option3_variant_id }}"
                      data-variant-id="{{ first_available_option3_variant_id }}"
                      {% if first_available_option3_variant_url != blank %}
                        data-connected-product-url="{{ first_available_option3_variant_url }}"
                      {% endif %}
                      {% if option3_value_item == current_option3_value %}
                        selected="selected"
                      {% endif %}
                      {% if option3_is_available == false %}
                        disabled
                      {% endif %}
                    >
                      {% if option3_is_available == false %}
                        {{ option3_value_item | escape }} - {{ 'content.unavailable' | t }}
                      {% else %}
                        {{ option3_value_item | escape }}
                      {% endif %}
                    </option>
                  {%- endunless -%}
                {% endfor %}
              </select>
              <svg
                aria-hidden="true"
                focusable="false"
                class="icon icon-caret"
                viewBox="0 0 10 6"
              >
                {%- render 'icon', icon: 'caret' -%}
              </svg>
            </div>
          </div>
        {%- else -%}
          <fieldset class="variant-picker-cl-dual__fieldset variant-picker-cl-dual__fieldset--option3">
            <legend>
              {{ option3_name | escape }}
              {%- if current_option3_value != blank and current_option3_value != '' -%}
                <span class="variant-picker-cl-dual__swatch-value">{{ current_option3_value | escape }}</span>
              {%- endif %}
            </legend>
            <div 
              class="variant-picker-cl-dual__options" 
              data-option-type="option3" 
              data-fieldset-index="2"
            >
              {% assign option3_array = unique_option3_values | split: '|||' %}
              {% for option3_value_item in option3_array %}
                {%- liquid
                  assign option3_value_str = option3_value_item | append: ''
                  assign should_skip_option3 = false
                  if option3_value_item == blank or option3_value_item == 0 or option3_value_str == '' or option3_value_str == '0' or option3_value_str == 'null'
                    assign should_skip_option3 = true
                  endif
                -%}
                {%- unless should_skip_option3 -%}
                {% if option3_value_item != blank and option3_value_item != '' %}
                  {% liquid
                    assign is_current_option3 = false
                    if option3_value_item == current_option3_value
                      assign is_current_option3 = true
                    endif
                    
                    assign option3_is_available = false
                    assign first_available_variant_id = ''
                    assign first_available_variant_url = ''
                    if dual_variant_data != ''
                      assign combinations_check = dual_variant_data | split: '|||'
                      for combination_entry in combinations_check
                        if combination_entry != blank and combination_entry != ''
                          assign combo_parts = combination_entry | split: '|'
                          if combo_parts.size >= 7
                            assign combo_option3 = combo_parts[4] | strip
                            assign combo_size = combo_parts[3] | strip
                            assign combo_color = combo_parts[2] | strip
                            assign combo_available = combo_parts[6] | strip
                            assign combo_variant_id = combo_parts[1] | strip
                            assign combo_url = combo_parts[5] | strip
                            
                            if combo_option3 == option3_value_item
                              if current_color_value != blank and current_color_value != '' and current_size_value != blank and current_size_value != ''
                                if combo_color == current_color_value and combo_size == current_size_value and combo_available == 'true'
                                  assign option3_is_available = true
                                  if first_available_variant_id == blank or first_available_variant_id == ''
                                    assign first_available_variant_id = combo_variant_id
                                    assign first_available_variant_url = combo_url
                                  endif
                                  break
                                endif
                              elsif current_color_value != blank and current_color_value != ''
                                if combo_color == current_color_value and combo_available == 'true'
                                  assign option3_is_available = true
                                  if first_available_variant_id == blank or first_available_variant_id == ''
                                    assign first_available_variant_id = combo_variant_id
                                    assign first_available_variant_url = combo_url
                                  endif
                                  break
                                endif
                              elsif current_size_value != blank and current_size_value != ''
                                if combo_size == current_size_value and combo_available == 'true'
                                  assign option3_is_available = true
                                  if first_available_variant_id == blank or first_available_variant_id == ''
                                    assign first_available_variant_id = combo_variant_id
                                    assign first_available_variant_url = combo_url
                                  endif
                                  break
                                endif
                              else
                                if combo_available == 'true'
                                  assign option3_is_available = true
                                  if first_available_variant_id == blank or first_available_variant_id == ''
                                    assign first_available_variant_id = combo_variant_id
                                    assign first_available_variant_url = combo_url
                                  endif
                                  break
                                endif
                              endif
                            endif
                          endif
                        endif
                      endfor
                    endif
                  %}
                  
                  <label
                    class="variant-picker-cl-dual__label{% if is_current_option3 %} variant-picker-cl-dual__label--current{% endif %}"
                    {% if option3_is_available == false %}
                      data-option-available="false"
                    {% else %}
                      data-option-available="true"
                    {% endif %}
                  >
                    <input
                      type="radio"
                      id="cl-dual-option3-{{ section.id }}-{{ block.id }}-{{ option3_value_item | handleize }}"
                      name="option3_selection-{{ block.id }}"
                      value="{{ option3_value_item | escape }}"
                      data-option-type="option3"
                      data-fieldset-index="2"
                      data-input-index="{{ forloop.index0 }}"
                      data-previous-checked="false"
                      data-option-available="{{ option3_is_available }}"
                      {% if first_available_variant_url != blank and first_available_variant_id != blank %}
                        data-connected-product-url="{{ first_available_variant_url }}?variant={{ first_available_variant_id }}"
                      {% endif %}
                      {% if is_current_option3 %}
                        data-current-checked="true"
                        checked
                      {% else %}
                        data-current-checked="false"
                      {% endif %}
                      {% if option3_is_available == false %}
                        aria-disabled="true"
                      {% endif %}
                      aria-label="{{ option3_value_item | escape }}"
                    >
                    {% if option3_is_available == true %}
                      <span class="variant-picker-cl-dual__pill"></span>
                    {% endif %}
                    <span class="variant-picker-cl-dual__text">{{ option3_value_item | escape }}</span>
                    {% unless option3_is_available %}
                      {% render 'variant-option-unavailable-line' %}
                    {% endunless %}
                  </label>
                {% endif %}
                {%- endunless -%}
              {% endfor %}
            </div>
          </fieldset>
        {%- endif -%}
      {%- endif -%}
    </form>
  </variant-picker-cl-dual>
{% elsif sorted_products != '' %}
  {% comment %} SINGLE PICKER MODE: Render color swatches or buttons/dropdowns {% endcomment %}
  {%- liquid
    # Use swatch UI when show_swatches OR show_product_image_swatches (so "product images as swatches" shows image swatches)
    assign use_swatches = true
    if block != blank and block_settings != blank
      assign use_swatches = block_settings.show_swatches
    elsif settings.show_swatches != blank
      assign use_swatches = settings.show_swatches
    endif
    if show_product_image_swatches
      assign use_swatches = true
    endif
  -%}
  {%- if use_swatches -%}
    {%- liquid
      # Get product image swatch size for CSS variable
      assign single_swatch_size = product_image_swatch_size
      if single_swatch_size == blank
        assign single_swatch_size = 60
      endif
    -%}
    <swatches-variant-picker-component
      data-product-id="{{ product_resource.id }}"
      data-product-url="{{ product_resource.url }}"
      data-debug-picker="cl"
      data-debug-spi="{{ show_product_image_swatches }}"
      {% if product.id == product_resource.id %}
        data-template-product-match="true"
      {% endif %}
      style="--product-image-swatch-size: {{ single_swatch_size }}px;"
      ref="swatchesVariantPicker"
    >
      <form>
        <fieldset class="variant-option variant-option--buttons variant-option--swatches{% if show_product_image_swatches and show_horizontal_scroll %} variant-option--swatches-horizontal-scroll{% endif %}">
        {%- liquid
          # Always show labels on product pages, otherwise respect the setting
          assign is_product_page = false
          if request.page_type == 'product'
            assign is_product_page = true
          endif
          
          # Show labels if on product page OR if setting is enabled
          assign show_text_labels = false
          if is_product_page
            assign show_text_labels = true
          elsif show_swatch_text_labels_setting
            assign show_text_labels = true
          endif
        -%}
        {%- if show_text_labels -%}
          <legend>
            {{ variant_option_name | escape }}:
            {%- if selected_color_value != blank and selected_color_value != '' -%}
              <span class="variant-option__swatch-value">{{ selected_color_value | escape }}</span>
            {%- endif %}
          </legend>
        {%- endif %}
        {% capture children %}
          {% assign final_products = sorted_products | split: '|||' %}
          {% for product_item in final_products %}
            {% if product_item != blank and product_item != '' %}
              {% assign item_parts = product_item | split: '|' %}
              
              {% comment %} Handle case where string starts with pipe (first element is empty) {% endcomment %}
              {% assign base_index = 0 %}
              {% if item_parts.size > 0 %}
                {% assign first_part = item_parts[0] | strip %}
                {% if first_part == blank or first_part == '' %}
                  {% assign base_index = 1 %}
                {% endif %}
              {% endif %}
              
              {% comment %} We need at least 10 elements (indices base_index through base_index+9) for the core fields {% endcomment %}
              {% comment %} The last field (color_metafield_value) is optional, so we only need 10 fields minimum {% endcomment %}
              {% assign min_required_size = base_index | plus: 10 %}
              {% if item_parts.size >= min_required_size %}
                {% assign idx = base_index %}
                {% assign product_id = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 1 %}
                {% assign product_type = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 2 %}
                {% assign variant_id = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 3 %}
                {% assign product_url = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 4 %}
                {% assign product_title = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 5 %}
                {% assign has_swatch = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 6 %}
                {% assign color_option_value = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 7 %}
                {% assign color_option_name = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 8 %}
                {% assign is_current = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 9 %}
                {% assign variant_available = item_parts[idx] | strip %}
                {% assign idx = base_index | plus: 10 %}
                {% assign color_metafield_value = item_parts[idx] | strip %}
                
                {% comment %} Fallback: if product_title looks like a URL, get it from the product object {% endcomment %}
                {% if product_title contains '/' or product_title == blank %}
                  {% if product_type == 'current' %}
                    {% assign product_title = product_resource.title %}
                  {% else %}
                    {% assign product_id_as_number = product_id | plus: 0 %}
                    {% for all_product in collections.all.products %}
                      {% assign all_product_id_as_string = all_product.id | append: '' %}
                      {% if all_product.id == product_id or all_product.id == product_id_as_number or all_product_id_as_string == product_id %}
                        {% assign product_title = all_product.title %}
                        {% break %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endif %}

            {% liquid
              assign is_current_product = false
              if is_current == 'true'
                assign is_current_product = true
              endif

              # For combined listings, always allow navigation (even if variant is sold out)
              # We want users to be able to click to navigate to other products
              assign variant_available_bool = true
              
              # Normalize product_type for comparison
              assign product_type_normalized = product_type | downcase | strip
              
              # Find the product object to get swatch data and check actual variant availability
              assign display_product = ''
              if product_type_normalized == 'current'
                assign display_product = product_resource
              else
                # Ensure product_id is set - if blank, try to get it from the parsed data
                if product_id == blank or product_id == ''
                  # Try to get product_id from the item_parts if available
                  if item_parts.size > base_index
                    assign product_id = item_parts[base_index] | strip
                  endif
                endif
                
                if product_id != blank and product_id != ''
                  assign product_id_as_number = product_id | plus: 0
                  
                  # Try to find from metafield first (more reliable)
                  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
                    for linked_product in combined_listings_metafield.value
                      assign linked_product_id = linked_product.id
                      assign linked_product_id_as_string = linked_product_id | append: ''
                      if linked_product_id == product_id or linked_product_id == product_id_as_number or linked_product_id_as_string == product_id
                        assign display_product = linked_product
                        break
                      endif
                    endfor
                  endif
                  
                  # Fallback: Find from collections.all.products
                  if display_product == ''
                    for all_product in collections.all.products
                      assign all_product_id_as_string = all_product.id | append: ''
                      if all_product.id == product_id or all_product.id == product_id_as_number or all_product_id_as_string == product_id
                        assign display_product = all_product
                        break
                      endif
                    endfor
                  endif
                endif
              endif
              
              # Check actual variant availability from the product object (more reliable than stored string)
              assign variant_actually_available = false
              if display_product != '' and variant_id != blank
                assign variant_id_as_number = variant_id | plus: 0
                assign variant_id_as_string = variant_id | append: ''
                for variant in display_product.variants
                  if variant.id == variant_id or variant.id == variant_id_as_number or variant.id == variant_id_as_string
                    if variant.available
                      assign variant_actually_available = true
                    endif
                    break
                  endif
                endfor
              else
                # Fallback to stored string if we can't find the variant
                assign variant_available_clean = variant_available | strip | downcase
                if variant_available_clean == 'true' or variant_available == true
                  assign variant_actually_available = true
                endif
              endif

              # Get swatch if available from variant options - prioritize swatch color/image over variant image
              # Use the same approach as the original code: iterate through all options and values
              # and match by the option value name (like "Black", "Military Black")
              assign swatch_to_render = ''
              assign variant_image_for_swatch = ''
              assign option_value_name_for_swatch = color_option_value
              
              if display_product != '' and color_option_value != blank and color_option_value != ''
                # Iterate through all options (like the original code does)
                for option in display_product.options_with_values
                  # Iterate through all values in this option
                  for value in option.values
                    # Compare the value directly to our stored color_option_value
                    # In Liquid, value when compared directly is the value name
                    assign value_str = value | append: ''
                    if value_str == color_option_value
                      # Use the actual option value name for assets folder backup
                      assign option_value_name_for_swatch = value.name
                      
                      # Priority 1: Check for swatch (custom color or swatch image) - highest priority
                      if value.swatch != blank
                        if value.swatch.color != blank or value.swatch.image != blank
                          assign swatch_to_render = value.swatch
                        endif
                      endif
                      
                      # Priority 2: Check for variant's custom image (only if no swatch found)
                      if swatch_to_render == blank
                        if value.variant.featured_media != blank
                          assign variant_image_for_swatch = value.variant.featured_media
                        endif
                      endif
                      
                      break
                    endif
                  endfor
                  # If we found a swatch or variant image, break out of the outer loop
                  assign should_break = false
                  if swatch_to_render != blank
                    assign should_break = true
                  elsif variant_image_for_swatch != blank
                    assign should_break = true
                  endif
                  if should_break
                    break
                  endif
                endfor
              endif
              
              # Priority 3: If no swatch or variant image found, fall back to product's first image
              if swatch_to_render == blank and variant_image_for_swatch == blank
                if display_product != '' and display_product.featured_media != blank
                  assign variant_image_for_swatch = display_product.featured_media
                endif
              endif
              
              # Check assets folder for backup swatch file (Priority 1 in swatch.liquid)
              assign assets_file_exists_single = false
              if option_value_name_for_swatch != blank
                assign enable_backup_single = settings.enable_swatch_assets_backup
                if enable_backup_single == blank
                  assign enable_backup_single = true
                endif
                
                if enable_backup_single
                  assign swatch_file_extension_single = settings.swatch_file_extension | default: 'png'
                  assign color_file_name_single = option_value_name_for_swatch | handle | append: '.' | append: swatch_file_extension_single
                  if images[color_file_name_single] != blank
                    assign assets_file_exists_single = true
                  endif
                endif
              endif
              
              # Set flag for rendering - include assets folder check
              assign has_swatch_to_render = false
              if swatch_to_render != blank
                # We have a swatch with color or image
                assign has_swatch_to_render = true
              elsif variant_image_for_swatch != blank
                # We have a variant image or product fallback image
                assign has_swatch_to_render = true
              elsif assets_file_exists_single
                # Assets folder file exists - swatch.liquid will handle rendering it
                assign has_swatch_to_render = true
              endif
            %}

            {%- liquid
              # Get the actual variant's featured media for hover preview
              # Priority: variant's featured media > product's featured media > variant_image_for_swatch
              assign hover_media = ''
              if display_product != '' and variant_id != blank
                assign variant_id_as_number = variant_id | plus: 0
                assign variant_id_as_string = variant_id | append: ''
                for variant in display_product.variants
                  if variant.id == variant_id or variant.id == variant_id_as_number or variant.id == variant_id_as_string
                    # First try variant's featured media
                    if variant.featured_media != blank
                      assign hover_media = variant.featured_media
                    endif
                    break
                  endif
                endfor
              endif
              
              # If no variant media, use product's featured media (main product image for that color)
              if hover_media == blank and display_product != '' and display_product.featured_media != blank
                assign hover_media = display_product.featured_media
              endif
              
              # Final fallback to variant_image_for_swatch
              if hover_media == blank
                assign hover_media = variant_image_for_swatch
              endif
            -%}
            {%- comment -%} Don't show the swatch if the variant has no image. {%- endcomment -%}
            {% if hover_media == blank %}
              {% continue %}
            {% endif %}
            <li class="variant-option__swatch">
              <label
                {% if hover_media != blank %}
                  data-media-id="{{ hover_media.id }}"
                {% endif %}
                data-option-available="{{ variant_actually_available }}"
                class="variant-option__button-label variant-option__button-label--has-swatch {% if show_product_image_swatches %}variant-option__button-label--product-image variant-option__button-label--product-image-{{ product_image_swatch_style }}{% else %}swatch-rounded{% endif %}"
                {% if hover_media != blank %}
                  on:pointerenter="product-card/previewVariant/{{ hover_media.id }}"
                  on:pointerleave="product-card/resetVariant"
                {% endif %}
              >
                <input
                  type="radio"
                  name="{{ variant_option_name | escape }}-{{ product_resource.id }}-swatch"
                  value="{{ variant_id }}"
                  aria-label="{{ product_title | escape }}"
                  data-input-id="1-{{ forloop.index0 }}"
                  {% if hover_media != blank %}
                    data-option-media-id="{{ hover_media.id }}"
                  {% endif %}
                  data-option-available="{{ variant_actually_available }}"
                  {% if product_url != blank %}
                    data-connected-product-url="{{ product_url }}"
                  {% endif %}
                  {% if is_current_product %}
                    checked
                  {% endif %}
                  data-available-count="{% if variant_actually_available %}1{% else %}0{% endif %}"
                  data-variant-id="{{ variant_id }}"
                  data-first-available-or-first-variant-id="{{ variant_id }}"
                >
                {% if has_swatch_to_render %}
                  {% if swatch_to_render != blank and show_product_image_swatches == false %}
                    {% render 'swatch',
                      swatch: swatch_to_render,
                      variant_image: hover_media,
                      option_value_name: option_value_name_for_swatch,
                      enable_swatch_assets_backup: swatch_enable_assets_backup,
                      swatch_file_extension: swatch_file_extension_setting,
                      show_variant_image: swatch_show_variant_image,
                      variant_swatch_width: swatch_variant_width
                    %}
                  {% else %}
                    {% render 'swatch',
                      swatch: blank,
                      variant_image: hover_media,
                      option_value_name: option_value_name_for_swatch,
                      enable_swatch_assets_backup: swatch_enable_assets_backup,
                      swatch_file_extension: swatch_file_extension_setting,
                      show_variant_image: true,
                      variant_swatch_width: swatch_variant_width,
                      force_image_swatch: show_product_image_swatches
                    %}
                  {% endif %}
                {% endif %}
                {% unless variant_actually_available %}
                  {% render 'variant-option-unavailable-line' %}
                {% endunless %}
              </label>
            </li>
            {% endif %}
            {% endif %}
          {% endfor %}
          <li
            slot="more"
          >
            <button
              class="hidden-swatches__count"
              aria-label="{{ 'actions.show_all_options' | t }}"
              on:click="/showAllSwatches"
            ></button>
          </li>
        {% endcapture %}

        {% render 'overflow-list', children: children, ref: 'overflowList', defer: true %}
      </fieldset>
      <script type="application/json">
        {{ product_resource.selected_or_first_available_variant | json }}
      </script>
    </form>
  </swatches-variant-picker-component>
  {%- else -%}
    {%- comment -%} Render colors as dropdowns or buttons based on variant_style {%- endcomment -%}
    {%- if variant_style_setting == 'dropdowns' -%}
      <div class="variant-option variant-option--dropdowns">
        {%- liquid
          # Determine if text labels should be shown for colors
          assign show_color_text_labels = false
          if request.page_type == 'product' or show_swatch_text_labels_setting
            assign show_color_text_labels = true
          endif
        -%}
        {%- if show_color_text_labels -%}
          <label for="Color-{{ product_resource.id }}-{{ block.id }}">{{ variant_option_name | escape }}</label>
        {%- endif %}
        <div class="variant-option__select-wrapper">
          <select
            id="Color-{{ product_resource.id }}-{{ block.id }}"
            name="options[{{ variant_option_name | escape }}]"
            class="variant-option__select"
          >
            {% assign final_products = sorted_products | split: '|||' %}
            {% for product_item in final_products %}
              {% if product_item != blank and product_item != '' %}
                {% assign item_parts = product_item | split: '|' %}
                {% assign base_index = 0 %}
                {% if item_parts.size > 0 %}
                  {% assign first_part = item_parts[0] | strip %}
                  {% if first_part == blank or first_part == '' %}
                    {% assign base_index = 1 %}
                  {% endif %}
                {% endif %}
                {% assign min_required_size = base_index | plus: 10 %}
                {% if item_parts.size >= min_required_size %}
                  {% assign idx = base_index %}
                  {% assign product_id = item_parts[idx] | strip %}
                  {% assign idx = base_index | plus: 2 %}
                  {% assign variant_id = item_parts[idx] | strip %}
                  {% assign idx = base_index | plus: 6 %}
                  {% assign color_option_value = item_parts[idx] | strip %}
                  {% assign idx = base_index | plus: 8 %}
                  {% assign is_current = item_parts[idx] | strip %}
                  {% assign idx = base_index | plus: 9 %}
                  {% assign variant_available = item_parts[idx] | strip %}
                  
                  {%- liquid
                    assign variant_available_bool = true
                    assign variant_available_clean = variant_available | strip | downcase
                    if variant_available_clean == 'false' or variant_available == false
                      assign variant_available_bool = false
                    endif
                  -%}
                  <option
                    value="{{ variant_id }}"
                    data-input-id="1-{{ forloop.index0 }}"
                    data-variant-id="{{ variant_id }}"
                    {% if is_current == 'true' %}
                      selected="selected"
                    {% endif %}
                    {% unless variant_available_bool %}
                      disabled
                    {% endunless %}
                  >
                    {% if variant_available_bool == false %}
                      {{ color_option_value | escape }} - {{ 'content.unavailable' | t }}
                    {% else %}
                      {{ color_option_value | escape }}
                    {% endif %}
                  </option>
                {% endif %}
              {% endif %}
            {% endfor %}
          </select>
          <svg
            aria-hidden="true"
            focusable="false"
            class="icon icon-caret"
            viewBox="0 0 10 6"
          >
            {%- render 'icon', icon: 'caret' -%}
          </svg>
        </div>
      </div>
    {%- else -%}
      {%- comment -%} Render colors as buttons {%- endcomment -%}
      <fieldset class="variant-option variant-option--buttons">
        {%- liquid
          # Determine if text labels should be shown for colors
          assign show_color_text_labels = false
          if request.page_type == 'product' or show_swatch_text_labels_setting
            assign show_color_text_labels = true
          endif
        -%}
        {%- if show_color_text_labels -%}
          <legend>
            {{ variant_option_name | escape }}:
            {%- if selected_color_value != blank and selected_color_value != '' -%}
              <span class="variant-option__swatch-value">{{ selected_color_value | escape }}</span>
            {%- endif %}
          </legend>
        {%- endif %}
        {% assign final_products = sorted_products | split: '|||' %}
        {% for product_item in final_products %}
          {% if product_item != blank and product_item != '' %}
            {% assign item_parts = product_item | split: '|' %}
            {% assign base_index = 0 %}
            {% if item_parts.size > 0 %}
              {% assign first_part = item_parts[0] | strip %}
              {% if first_part == blank or first_part == '' %}
                {% assign base_index = 1 %}
              {% endif %}
            {% endif %}
            {% assign min_required_size = base_index | plus: 10 %}
            {% if item_parts.size >= min_required_size %}
              {% assign idx = base_index %}
              {% assign product_id = item_parts[idx] | strip %}
              {% assign idx = base_index | plus: 2 %}
              {% assign variant_id = item_parts[idx] | strip %}
              {% assign idx = base_index | plus: 4 %}
              {% assign product_title = item_parts[idx] | strip %}
              {% assign idx = base_index | plus: 6 %}
              {% assign color_option_value = item_parts[idx] | strip %}
              {% assign idx = base_index | plus: 8 %}
              {% assign is_current = item_parts[idx] | strip %}
              {% assign idx = base_index | plus: 9 %}
              {% assign variant_available = item_parts[idx] | strip %}
              
              {%- liquid
                assign is_current_product = false
                if is_current == 'true'
                  assign is_current_product = true
                endif
                
                assign variant_available_bool = true
                assign variant_available_clean = variant_available | strip | downcase
                if variant_available_clean == 'false' or variant_available == false
                  assign variant_available_bool = false
                endif
              -%}
              <label
                data-option-available="{{ variant_available_bool }}"
                class="variant-option__button-label"
              >
                <input
                  type="radio"
                  name="{{ variant_option_name | escape }}-{{ product_resource.id }}-button"
                  value="{{ variant_id }}"
                  aria-label="{{ product_title | escape }}"
                  data-input-id="1-{{ forloop.index0 }}"
                  data-option-available="{{ variant_available_bool }}"
                  {% if is_current_product %}
                    checked
                  {% endif %}
                  data-available-count="{% if variant_available_bool %}1{% else %}0{% endif %}"
                  data-variant-id="{{ variant_id }}"
                  data-first-available-or-first-variant-id="{{ variant_id }}"
                >
                <span class="variant-option__button-label__text">{{ color_option_value | escape }}</span>
              </label>
            {% endif %}
          {% endif %}
        {% endfor %}
      </fieldset>
    {%- endif -%}
  {%- endif -%}
{% endif %}
{% endif %}

{% comment %} #region agent log {% endcomment %}
<script>
(function(){
  var el = document.querySelector('variant-picker-cl-dual[data-debug-picker="cl"], swatches-variant-picker-component[data-debug-picker="cl"]');
  if (!el) return;
  fetch('http://127.0.0.1:7247/ingest/cd9e77b3-1faf-48a3-82be-694fad5c3e6d',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'variant-combined-listing-picker.liquid',message:'cl picker rendered',data:{show_product_image_swatches:el.dataset.debugSpi==='true'},timestamp:Date.now(),hypothesisId:'verify'})}).catch(function(){});
})();
</script>
{% comment %} #endregion agent log {% endcomment %}

{% stylesheet %}
  .variant-picker-cl {
    width: 100%;
  }

  .variant-picker-cl__form {
    display: flex;
    flex-direction: column;
    gap: var(--padding-lg);
    width: 100%;
  }

  .variant-picker-cl__fieldset {
    --options-border-radius: var(--variant-picker-button-radius);
    --options-border-width: var(--variant-picker-button-border-width);
    --variant-option-padding-inline: var(--padding-md);
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-sm);
    margin: 0;
    padding: 0;
    border: none;
  }

  .variant-picker-cl__fieldset legend {
    padding: 0;
    margin-block-end: var(--margin-xs);
  }

  .variant-picker-cl__swatch-value {
    padding-inline-start: var(--padding-xs);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
  }

  .variant-picker-cl__options {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-sm);
  }

  .variant-picker-cl__option {
    display: inline-block;
  }

  @media (prefers-reduced-motion: no-preference) {
    .variant-picker-cl__label,
    .variant-picker-cl__label::before,
    .variant-picker-cl__label::after {
      transition-duration: var(--animation-speed);
      transition-timing-function: var(--animation-easing);
    }
    .variant-picker-cl__label {
      transition-property: background-color, border-color, color;
    }
    .variant-picker-cl__label::after {
      transition-property: clip-path;
    }
    .variant-picker-cl__label::before {
      transition-property: border-color;
    }
  }

  .variant-picker-cl__label {
    --variant-picker-stroke-color: var(--color-variant-border);
    cursor: pointer;
    display: flex;
    flex: 0 0 calc(3ch + 1.3em);
    align-items: center;
    position: relative;
    padding-block: var(--padding-sm);
    padding-inline: var(--padding-lg);
    border: var(--options-border-width) solid var(--color-variant-border);
    border-radius: var(--options-border-radius);
    overflow: clip;
    justify-content: center;
    min-height: calc(3ch + 1.3em);
    min-width: fit-content;
    white-space: nowrap;
    background-color: var(--color-variant-background);
    color: var(--color-variant-text);

    &:hover {
      background-color: var(--color-variant-hover-background);
      border-color: var(--color-variant-hover-border);
      color: var(--color-variant-hover-text);
    }

    &:not(.variant-picker-cl__label--has-swatch)::before {
      content: '';
      position: absolute;
      /* stylelint-disable-next-line plugin/no-unsupported-browser-features */
      clip-path: inset(0 0 0 0);
      border-color: var(--color-variant-border);
      inset: calc(var(--options-border-width) * -1);
      border: var(--options-border-width) solid var(--color-variant-border);
      border-radius: inherit;
      pointer-events: none;
      z-index: 2;
    }
    &:has(:checked):not(.variant-picker-cl__label--has-swatch)::before {
      border-color: var(--color-selected-variant-border);
    }
  }

  .variant-picker-cl__label:has(:focus-visible) {
    --variant-picker-stroke-color: var(--color-foreground);

    border-color: var(--color-foreground);
    outline: var(--focus-outline-width) solid var(--color-foreground);
    outline-offset: var(--focus-outline-offset);
  }

  .variant-picker-cl__label--has-swatch {
    --focus-outline-radius: var(--variant-picker-swatch-radius);

    padding: 0;
    border: none;
    display: block;
    flex-basis: auto;
    min-height: auto;
  }

  .variant-picker-cl__label:has(:checked) {
    color: var(--color-selected-variant-text);
    border-color: var(--color-selected-variant-border);
  }

  .variant-picker-cl__label:has(:checked):hover {
    border-color: var(--color-selected-variant-hover-border);
    color: var(--color-selected-variant-hover-text);
  }

  .variant-picker-cl__label--has-swatch:hover {
    outline: var(--focus-outline-width) solid rgb(var(--color-foreground-rgb) / var(--opacity-35-55));
    outline-offset: var(--focus-outline-offset);
  }

  .variant-picker-cl__label--has-swatch:has(:checked) {
    --focus-outline: var(--focus-outline-width) solid var(--color-foreground);

    outline: var(--focus-outline);
    outline-offset: var(--focus-outline-offset);
  }

  /* This triggers iOS < 16.4. The outline bug is not recognized as a lack of @supports */
  @supports not (background-color: rgb(from red 150 g b / alpha)) {
    /** There is a bug in safari < 16.4 that causes the outline to not follow the elements border radius. This is a workaround. **/
    .variant-picker-cl__label--has-swatch:has(:checked),
    .variant-picker-cl__label:has(:focus-visible) .swatch {
      outline: none;
      position: relative;
      overflow: visible;
    }

    .variant-picker-cl__label--has-swatch:has(:checked)::after,
    .variant-picker-cl__label:has(:focus-visible) .swatch::after {
      content: '';
      position: absolute;
      inset: calc(-1 * var(--focus-outline-offset));
      border: var(--focus-outline);
      border-radius: var(--focus-outline-radius, 50%);
      background-color: transparent;
      display: inherit;
    }
  }

  .variant-picker-cl__label input,
  .variant-picker-cl__label input[type="radio"] {
    /* remove the checkbox from the page flow */
    position: absolute;

    /* set the dimensions to match those of the label */
    inset: 0;

    /* hide it */
    opacity: 0;
    margin: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .variant-picker-cl__text {
    pointer-events: none;
    text-align: start;
    text-wrap: auto;
    z-index: 2;
  }

  .variant-picker-cl__label--has-swatch .swatch {
    pointer-events: none;
    z-index: 0;
  }

  .variant-picker-cl--center,
  .variant-picker-cl--center .variant-picker-cl__fieldset {
    text-align: center;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  .variant-picker-cl--right,
  .variant-picker-cl--right .variant-picker-cl__fieldset {
    text-align: right;
    justify-content: right;
  }

  /* Dual Picker Styles - matching variant-main-picker exactly */
  .variant-picker-cl-dual {
    width: 100%;
  }

  .variant-picker-cl-dual__form {
    display: flex;
    flex-direction: column;
    gap: var(--padding-lg);
    width: 100%;
  }

  /* Ensure swatches in dual picker follow global swatch styling */
  .variant-picker-cl-dual .variant-option--swatches {
    overflow: visible;
    /* Match padding from blocks/swatches.liquid for consistency */
    padding-block: calc(
        var(--product-swatches-padding-block-start) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px)
      )
      calc(var(--product-swatches-padding-block-end) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px));
    padding-inline: calc(
        var(--product-swatches-padding-inline-start) + var(--focus-outline-offset) + (1.5 * var(--focus-outline-width)) + var(--style-border-swatch-width, 1px)
      )
      calc(var(--product-swatches-padding-inline-end) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px));
  }

  /* Override overflow and padding for horizontal scroll mode - using more specific selector */
  .variant-picker-cl-dual--horizontal-scroll .variant-option--swatches,
  .variant-option--swatches-horizontal-scroll {
    overflow: hidden;
    width: 100%;
    max-width: 100%;
    min-width: 0;
    padding-block: calc(
        var(--product-swatches-padding-block-start) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px)
      )
      calc(var(--product-swatches-padding-block-end) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px));
    padding-inline: 0;
    padding-inline-start: 0;
    padding-inline-end: 0;
    padding-left: 0;
    padding-right: 0;
    box-sizing: border-box;
  }

  /* Ensure parent containers don't allow overflow */
  .variant-picker-cl-dual--horizontal-scroll,
  .variant-picker-cl-dual--horizontal-scroll .variant-picker-cl-dual__form {
    width: 100%;
    max-width: 100%;
    overflow: visible;
    box-sizing: border-box;
  }

  .variant-picker-cl-dual .variant-option__swatch {
    display: inline-block;
  }

  .variant-picker-cl-dual .variant-option__button-label--has-swatch {
    --focus-outline-radius: var(--variant-picker-swatch-radius);
    padding: 0;
    border: none;
    display: block;
    flex-basis: auto;
    min-height: auto;
  }

  .variant-picker-cl-dual .variant-option__button-label--has-swatch:hover {
    outline: var(--focus-outline-width) solid rgb(var(--color-foreground-rgb) / var(--opacity-35-55));
    outline-offset: var(--focus-outline-offset);
  }

  .variant-picker-cl-dual .variant-option__button-label--has-swatch:has(:checked) {
    --focus-outline: var(--focus-outline-width) solid var(--color-foreground);
    outline: var(--focus-outline);
    outline-offset: var(--focus-outline-offset);
  }

  .variant-picker-cl-dual .variant-option__button-label--has-swatch .swatch {
    pointer-events: none;
    z-index: 0;
  }

  /* Match overflow-list styling from blocks/swatches.liquid */
  .variant-picker-cl-dual .variant-option--swatches {
    overflow-list::part(list) {
      gap: var(--gap-sm);
    }

    overflow-list[defer]::part(list) {
      flex-wrap: nowrap;
    }
  }

  .variant-picker-cl-dual__fieldset {
    --options-border-radius: var(--variant-picker-button-radius);
    --options-border-width: var(--variant-picker-button-border-width);
    --variant-option-padding-inline: var(--padding-md);
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-sm);
    margin: 0;
    padding: 0;
    border: none;
  }

  .variant-picker-cl-dual__fieldset--equal-width-buttons {
    --variant-min-width: clamp(44px, calc(var(--variant-option-padding-inline) * 2 + var(--variant-ch)), 100%);
    display: grid;
    grid-template-columns: 1fr;
  }

  .variant-picker-cl-dual__fieldset--equal-width-buttons .variant-picker-cl-dual__options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(var(--variant-min-width), 1fr));
    width: 100%;
    max-width: 250px;
  }

  .variant-picker-cl-dual__fieldset--equal-width-buttons .variant-picker-cl-dual__label {
    min-width: var(--variant-min-width);
  }

  .variant-picker-cl-dual__fieldset--equal-width-buttons .variant-picker-cl-dual__text {
    text-align: center;
    text-wrap: balance;
  }

  .variant-picker-cl-dual__fieldset legend {
    padding: 0;
    margin-block-end: var(--margin-xs);
  }

  .variant-picker-cl-dual__swatch-value {
    padding-inline-start: var(--padding-xs);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-70));
  }

  .variant-picker-cl-dual__options {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-sm);
    position: relative;
    width: 100%;
  }

  @media (prefers-reduced-motion: no-preference) {
    .variant-picker-cl-dual__label,
    .variant-picker-cl-dual__label::before,
    .variant-picker-cl-dual__label::after,
    .variant-picker-cl-dual__label:has([data-previous-checked='true'], [data-current-checked='true'])
      .variant-picker-cl-dual__pill {
      transition-duration: var(--animation-speed);
      transition-timing-function: var(--animation-easing);
    }
    .variant-picker-cl-dual__pill {
      transition-property: transform;
    }
    .variant-picker-cl-dual__label::after {
      transition-property: clip-path;
    }
    .variant-picker-cl-dual__label::before {
      transition-property: border-color;
    }
    .variant-picker-cl-dual__label {
      transition-property: background-color, border-color, color, opacity;
    }
  }

  .variant-picker-cl-dual__label {
    --variant-picker-stroke-color: var(--color-variant-border);
    cursor: pointer;
    display: flex;
    flex: 0 0 calc(3ch + 1.3em);
    align-items: center;
    position: relative;
    padding-block: var(--padding-sm);
    padding-inline: var(--padding-lg);
    border: var(--options-border-width) solid var(--color-variant-border);
    border-radius: var(--options-border-radius);
    overflow: clip;
    justify-content: center;
    min-height: calc(3ch + 1.3em);
    min-width: fit-content;
    white-space: nowrap;
    background-color: var(--color-variant-background);
    color: var(--color-variant-text);

    &:hover,
    &:hover:has([aria-disabled='true']):has([data-option-available='false']) {
      background-color: var(--color-variant-hover-background);
      border-color: var(--color-variant-hover-border);
      color: var(--color-variant-hover-text);
    }

    /* we need something like overflow-clip-margin to use the pseudoelement but it doesn't work in Safari */
    /* so instead use the layered background image trick */
    &:not(.variant-picker-cl-dual__label--has-swatch):has([data-option-available='false']) {
      border-width: 0;
    }
    /* ::after/::before act as a fake border for the button style variant */
    /* ::after is the unavailable variant border that clips in */
    &:not(.variant-picker-cl-dual__label--has-swatch)::before,
    &:has([data-option-available='false']):not(.variant-picker-cl-dual__label--has-swatch)::after {
      content: '';
      position: absolute;
      inset: 0;
      border: var(--options-border-width) solid var(--color-selected-variant-border);
      border-radius: inherit;
      pointer-events: none;
      z-index: 2;
      /* stylelint-disable-next-line plugin/no-unsupported-browser-features */
      clip-path: inset(var(--clip, 0 0 0 0));
    }
    &:has([data-option-available='false']):not(.variant-picker-cl-dual__label--has-swatch)::before {
      inset: 0;
    }
    &:not(.variant-picker-cl-dual__label--has-swatch)::before {
      /* stylelint-disable-next-line plugin/no-unsupported-browser-features */
      clip-path: inset(0 0 0 0);
      border-color: var(--color-variant-border);
      inset: calc(var(--options-border-width) * -1);
    }
    &:has(:checked):not(.variant-picker-cl-dual__label--has-swatch):not(:has([data-option-available='false']))::before {
      border-color: var(--color-selected-variant-border);
    }

    /* setting left/right accounts for variant buttons of different widths */
    &:not(:has(:checked)):has(~ label > :checked),
    &:has(:checked):has(~ label > [data-previous-checked='true']) {
      .variant-picker-cl-dual__pill {
        right: 0;
        left: unset;
      }
    }

    &:has([data-previous-checked='true']) ~ label:has([data-current-checked='true']),
    &:has(:checked) ~ label {
      .variant-picker-cl-dual__pill {
        left: 0;
        right: unset;
      }
    }

    &:not(:has(:checked)):has(~ label > :checked) {
      --pill-offset: calc(100% + 1px);
    }

    &:has(:checked) ~ label {
      --pill-offset: calc(-100% - 1px);
    }

    &:has([data-current-checked='true']):first-of-type
      ~ label:last-of-type:not(.variant-picker-cl-dual__label--has-swatch),
    &:not(:has(:checked)):has(~ label > :checked):not(.variant-picker-cl-dual__label--has-swatch) {
      --clip: 0 0 0 100%;
    }

    &:not(:has([data-current-checked='true'])):first-of-type:has(~ label:last-of-type > :checked):not(
        .variant-picker-cl-dual__label--has-swatch
      ),
    &:has(:checked) ~ label:not(.variant-picker-cl-dual__label--has-swatch) {
      --clip: 0 100% 0 0;
    }

    &:has([data-previous-checked='true'], [data-current-checked='true']) .variant-picker-cl-dual__pill {
      width: max(var(--pill-width-current, 100%), var(--pill-width-previous, 100%));
    }
    @media screen and (min-width: 750px) {
      padding: var(--padding-xs) var(--variant-option-padding-inline);
    }
  }

  /* wrap around only for 3 or more variants in a row */
  /* the more complex selector rules here produce the wrap around effect for first/last variants */
  .variant-picker-cl-dual__options:has(label:nth-of-type(3)) {
    .variant-picker-cl-dual__label:has([data-current-checked='true']):first-of-type ~ label:last-of-type {
      --pill-offset: calc(100% + 1px);
    }
    .variant-picker-cl-dual__label:not(:has([data-current-checked='true'])):first-of-type:has(
        ~ label:last-of-type > :checked
      ) {
      --pill-offset: calc(-100% - 1px);
    }
  }

  .variant-picker-cl-dual__pill {
    background: var(--color-selected-variant-background);
    position: absolute;
    top: calc(var(--options-border-width) * -1);
    bottom: calc(var(--options-border-width) * -1);
    border-radius: inherit;
    pointer-events: none;
    width: 100%;
    transform: translateX(var(--pill-offset, 0));
  }

  /* Hide pill for unavailable variants */
  .variant-picker-cl-dual__label:has([data-option-available='false']) .variant-picker-cl-dual__pill {
    display: none;
  }

  .variant-picker-cl-dual__text {
    pointer-events: none;
    text-align: start;
    text-wrap: auto;
    z-index: 2;
  }

  .variant-picker-cl-dual__label:has(:focus-visible) {
    --variant-picker-stroke-color: var(--color-foreground);

    border-color: var(--color-foreground);
    outline: var(--focus-outline-width) solid var(--color-foreground);
    outline-offset: var(--focus-outline-offset);
  }

  .variant-picker-cl-dual__label--has-swatch {
    --focus-outline-radius: var(--variant-picker-swatch-radius);

    padding: 0;
    border: none;
    display: block;
    flex-basis: auto;
    min-height: auto;
  }

  .variant-picker-cl-dual__label:has(:checked) {
    color: var(--color-selected-variant-text);
    border-color: var(--color-selected-variant-border);
  }

  .variant-picker-cl-dual__label:has(:checked):hover {
    border-color: var(--color-selected-variant-hover-border);
    color: var(--color-selected-variant-hover-text);

    .variant-picker-cl-dual__pill {
      background-color: var(--color-selected-variant-hover-background);
    }
  }

  .variant-picker-cl-dual__label[data-option-available='false'],
  .variant-picker-cl-dual__label:has([data-option-available='false']) {
    color: rgb(var(--color-variant-text-rgb) / var(--opacity-60));
    cursor: not-allowed;
  }

  /* Disabled swatch styling */
  .variant-picker-cl-dual__label--has-swatch[data-option-available='false'],
  .variant-picker-cl-dual__label--has-swatch:has([data-option-available='false']) {
    opacity: var(--opacity-60);
    cursor: not-allowed;
  }

  .variant-picker-cl-dual__label--has-swatch[data-option-available='false'] .swatch,
  .variant-picker-cl-dual__label--has-swatch:has([data-option-available='false']) .swatch {
    opacity: var(--opacity-60);
    border-style: dashed;
  }

  /* Prevent interaction on disabled swatches while allowing cursor */
  .variant-picker-cl-dual__label--has-swatch[data-option-available='false'] input,
  .variant-picker-cl-dual__label--has-swatch:has([data-option-available='false']) input {
    pointer-events: none;
  }

  .variant-picker-cl-dual__label--has-swatch:hover {
    outline: var(--focus-outline-width) solid rgb(var(--color-foreground-rgb) / var(--opacity-35-55));
    outline-offset: var(--focus-outline-offset);
  }

  .variant-picker-cl-dual__label--has-swatch:has(:checked) {
    --focus-outline: var(--focus-outline-width) solid var(--color-foreground);

    outline: var(--focus-outline);
    outline-offset: var(--focus-outline-offset);
  }

  /* This triggers iOS < 16.4. The outline bug is not recognized as a lack of @supports */
  @supports not (background-color: rgb(from red 150 g b / alpha)) {
    /** There is a bug in safari < 16.4 that causes the outline to not follow the elements border radius. This is a workaround. **/
    .variant-picker-cl-dual__label--has-swatch:has(:checked),
    .variant-picker-cl-dual__label:has(:focus-visible) .swatch {
      outline: none;
      position: relative;
      overflow: visible;
    }

    .variant-picker-cl-dual__label--has-swatch:has(:checked)::after,
    .variant-picker-cl-dual__label:has(:focus-visible) .swatch::after {
      content: '';
      position: absolute;
      inset: calc(-1 * var(--focus-outline-offset));
      border: var(--focus-outline);
      border-radius: var(--focus-outline-radius, 50%);
      background-color: transparent;
      display: inherit;
    }
  }

  .variant-picker-cl-dual__label:has([data-option-available='false']):has(:checked) {
    background-color: inherit;
    color: rgb(var(--color-variant-text-rgb) / var(--opacity-60));
  }

  .variant-picker-cl-dual__label input,
  .variant-picker-cl-dual__label input[type="radio"] {
    /* remove the checkbox from the page flow */
    position: absolute;

    /* set the dimensions to match those of the label */
    inset: 0;

    /* hide it */
    opacity: 0;
    margin: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .variant-picker-cl-dual__label--has-swatch .swatch {
    pointer-events: none;
    z-index: 0;
  }

  .variant-picker-cl-dual__label svg {
    position: absolute;
    left: var(--options-border-width);
    top: var(--options-border-width);
    height: calc(100% - (var(--options-border-width) * 2));
    width: calc(100% - (var(--options-border-width) * 2));
    cursor: pointer;
    pointer-events: none;
    stroke-width: var(--style-border-width);
    stroke: var(--variant-picker-stroke-color);
  }

  .variant-picker-cl-dual__label:not(.variant-picker-cl-dual__label--has-swatch) svg {
    stroke: var(--color-variant-border);

    line {
      stroke-width: var(--options-border-width);
    }

    line:last-of-type {
      /* stylelint-disable-next-line plugin/no-unsupported-browser-features */
      clip-path: inset(var(--clip, 0 0 0 0));
      stroke: rgb(var(--color-variant-text-rgb) / 1);
    }
  }


  .variant-picker-cl-dual--center,
  .variant-picker-cl-dual--center .variant-picker-cl-dual__fieldset {
    text-align: center;
    align-items: center;
    justify-content: center;
    width: 100%;
  }

  .variant-picker-cl-dual--right,
  .variant-picker-cl-dual--right .variant-picker-cl-dual__fieldset {
    text-align: right;
    justify-content: right;
  }

  /* Product Image Swatch Styles for Dual Picker */
  .variant-option__button-label--product-image,
  .variant-picker-cl-dual__label--product-image {
    --swatch-size: var(--product-image-swatch-size, 60px);
    width: var(--swatch-size);
    height: var(--swatch-size);
    padding: 0;
    border: none;
    border-radius: 0;
    overflow: hidden;
    background: transparent;
  }

  .variant-option__button-label--product-image .swatch,
  .variant-picker-cl-dual__label--product-image .swatch {
    width: 100%;
    height: 100%;
    border-radius: 0;
    background-color: transparent;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
  }

  .variant-option__button-label--product-image .swatch__image,
  .variant-picker-cl-dual__label--product-image .swatch__image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Circle layout */
  .variant-option__button-label--product-image-circle,
  .variant-picker-cl-dual__label--product-image-circle {
    border-radius: 0;
  }

  .variant-option__button-label--product-image-circle .swatch,
  .variant-picker-cl-dual__label--product-image-circle .swatch {
    border-radius: 0;
  }

  /* Square layout */
  .variant-option__button-label--product-image-square,
  .variant-picker-cl-dual__label--product-image-square {
    border-radius: 0;
  }

  .variant-option__button-label--product-image-square .swatch,
  .variant-picker-cl-dual__label--product-image-square .swatch {
    border-radius: 0;
  }

  /* Selected state - thin black border only */
  .variant-option__button-label--product-image:has(:checked),
  .variant-picker-cl-dual__label--product-image:has(:checked) {
    border: 2px solid var(--color-foreground);
    border-radius: 0;
    outline: none;
    box-shadow: none;
  }

  /* Remove all outlines on focus, hover, active */
  .variant-option__button-label--product-image:hover,
  .variant-option__button-label--product-image:focus,
  .variant-option__button-label--product-image:focus-visible,
  .variant-option__button-label--product-image:active,
  .variant-picker-cl-dual__label--product-image:hover,
  .variant-picker-cl-dual__label--product-image:focus,
  .variant-picker-cl-dual__label--product-image:focus-visible,
  .variant-picker-cl-dual__label--product-image:active {
    outline: none;
    box-shadow: none;
  }

  .variant-option__button-label--product-image input:focus,
  .variant-option__button-label--product-image input:focus-visible,
  .variant-picker-cl-dual__label--product-image input:focus,
  .variant-picker-cl-dual__label--product-image input:focus-visible {
    outline: none;
    box-shadow: none;
  }

  /* Ensure circle stays round when selected */
  .variant-option__button-label--product-image-circle:has(:checked),
  .variant-picker-cl-dual__label--product-image-circle:has(:checked) {
    border-radius: 0;
  }

  /* Ensure square stays square when selected */
  .variant-option__button-label--product-image-square:has(:checked),
  .variant-picker-cl-dual__label--product-image-square:has(:checked) {
    border-radius: 0;
  }


  .variant-picker-cl-dual--horizontal-scroll .variant-option--swatches {
    gap: 8px;
    overflow: hidden;
    width: 100%;
    max-width: 100%;
    min-width: 0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    position: relative;
    padding-left: 0;
    padding-right: 0;
    padding-inline-start: 0;
    padding-inline-end: 0;
    padding-inline: 0;
  }

  /* Wrapper div for horizontal scrolling - using specific class selector */
  .swatches-scroll-wrapper--horizontal {
    display: block;
    width: 100%;
    max-width: 100%;
    min-width: 0;
    flex-shrink: 1;
    flex-basis: 100%;
    overflow-x: scroll;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 12px;
    padding-left: calc(var(--product-swatches-padding-inline-start, 0px) + var(--focus-outline-offset, 0px) + 1.5 * var(--focus-outline-width, 0px) + var(--style-border-swatch-width, 0px));
    padding-right: calc(var(--product-swatches-padding-inline-end, 0px) + var(--focus-outline-offset, 0px) + var(--focus-outline-width, 0px) + var(--style-border-swatch-width, 0px));
    box-sizing: border-box;
    position: relative;
    scrollbar-width: thin;
    scrollbar-color: rgb(var(--color-foreground-rgb) / 0.7) rgb(var(--color-border-rgb) / 0.5);
    margin-left: 0;
    margin-right: 0;
  }

  /* Ensure parent flex containers constrain properly */
  .layout-panel-flex .variant-picker-cl-dual--horizontal-scroll,
  .layout-panel-flex .variant-picker-cl-dual--horizontal-scroll .variant-picker-cl-dual__form,
  .layout-panel-flex .variant-picker-cl-dual--horizontal-scroll .variant-option--swatches {
    min-width: 0;
    max-width: 100%;
    overflow: hidden;
  }

  /* UL inside scroll wrapper - using more specific selector to override base rule */
  .swatches-scroll-wrapper--horizontal .variant-option__swatches-list--horizontal-scroll,
  .variant-option__swatches-list--horizontal-scroll {
    display: flex;
    flex-wrap: nowrap;
    width: max-content;
    min-width: 100%;
    box-sizing: border-box;
    gap: 8px;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  /* Ensure list items don't shrink and maintain their natural width */
  .swatches-scroll-wrapper--horizontal .variant-option__swatches-list--horizontal-scroll > li {
    flex-shrink: 0;
    flex-grow: 0;
    width: auto;
    min-width: fit-content;
  }

  /* Ensure swatch labels maintain their width */
  .swatches-scroll-wrapper--horizontal .variant-option__button-label--product-image {
    flex-shrink: 0;
    width: var(--product-image-swatch-size, 60px);
    min-width: var(--product-image-swatch-size, 60px);
    max-width: var(--product-image-swatch-size, 60px);
  }

  /* Scrollbar styling - using specific class selector */
  .swatches-scroll-wrapper--horizontal {
    scrollbar-width: thin;
    scrollbar-color: rgb(var(--color-foreground-rgb) / 0.8) rgb(var(--color-border-rgb) / 0.5);
  }

  .swatches-scroll-wrapper--horizontal::-webkit-scrollbar {
    height: 12px;
    -webkit-appearance: none;
    display: block;
    background: rgb(var(--color-border-rgb) / var(--opacity-30));
  }

  .swatches-scroll-wrapper--horizontal::-webkit-scrollbar-track {
    background: rgb(var(--color-border-rgb) / var(--opacity-50));
    border-radius: 9999px;
    -webkit-box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.2);
    display: block;
  }

  .swatches-scroll-wrapper--horizontal::-webkit-scrollbar-thumb {
    background: rgb(var(--color-foreground-rgb) / var(--opacity-80));
    border-radius: 9999px;
    -webkit-box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.2);
    min-width: 30px;
    display: block;
  }

  .swatches-scroll-wrapper--horizontal::-webkit-scrollbar-thumb:hover {
    background: rgb(var(--color-foreground-rgb) / var(--opacity-95));
  }

  /* Simple list wrapper for swatches - default: allows wrapping */
  .variant-option__swatches-list:not(.variant-option__swatches-list--horizontal-scroll) {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    margin: 0;
    padding: 0;
    list-style: none;
    width: 100%;
  }

  .variant-option__swatches-list > li {
    display: inline-block;
    margin: 0;
    flex-shrink: 0;
  }

  /* Prevent items from shrinking when horizontal scroll is enabled */
  .swatches-scroll-wrapper--horizontal .variant-option__swatches-list--horizontal-scroll > li,
  .variant-picker-cl-dual--horizontal-scroll .variant-option__swatches-list > li {
    flex-shrink: 0;
    flex-grow: 0;
    min-width: fit-content;
  }

  /* Ensure fieldset padding is removed for horizontal scroll - more specific selector */
  .variant-picker-cl-dual--horizontal-scroll .variant-option--swatches-horizontal-scroll,
  .variant-picker-cl-dual--horizontal-scroll .variant-option--swatches {
    padding-left: 0;
    padding-right: 0;
    padding-inline-start: 0;
    padding-inline-end: 0;
    padding-inline: 0;
  }
{% endstylesheet %}