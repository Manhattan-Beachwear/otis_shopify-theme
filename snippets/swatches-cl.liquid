{%- liquid
  assign block_settings = block.settings
  
  # Check if combined listings are enabled (from section or block settings)
  assign enable_combined = false
  if section.settings.enable_combined_listings
    assign enable_combined = true
  elsif block.settings.enable_combined_listings
    assign enable_combined = true
  endif
  
  # Check if product has combined listing metafield directly
  assign combined_listings_metafield = closest.product.metafields.custom.combined_listing
  assign has_combined_listing_metafield = false
  assign product_has_swatches = false
  
  # Check if metafield exists and has products
  # Note: enable_combined check is already done in blocks/swatches.liquid before rendering this snippet
  if combined_listings_metafield != blank and combined_listings_metafield.value != blank
    # Try to iterate to see if we have products
    for test_product in combined_listings_metafield.value
      assign has_combined_listing_metafield = true
      assign product_has_swatches = true
      break
    endfor
  endif
-%}

{%- comment -%} Use utility snippet to get swatches data if product has combined listing {%- endcomment -%}
{%- if enable_combined and has_combined_listing_metafield -%}
  {%- render 'util-combined-listing-data', product_resource: closest.product, combined_listings_metafield: combined_listings_metafield, enable_combined: enable_combined -%}
{%- endif -%}

{%- comment -%}
  Render combined listing swatches (shows all swatches from all linked products)
{%- endcomment -%}
{% if product_has_swatches %}
  {%- liquid
    # Resolve all product image swatch settings with priority: block → section → global
    assign show_product_image_swatches = false
    if block != blank and block.settings != blank and block.settings.show_product_image_swatches
      assign show_product_image_swatches = true
    elsif section != blank and section.settings != blank and section.settings.show_product_image_swatches
      assign show_product_image_swatches = true
    elsif settings.show_product_image_swatches
      assign show_product_image_swatches = true
    endif
    
    assign product_image_swatch_style = 'circle'
    if block != blank and block.settings != blank and block.settings.product_image_swatch_style != blank
      assign product_image_swatch_style = block.settings.product_image_swatch_style
    elsif section != blank and section.settings != blank and section.settings.product_image_swatch_style != blank
      assign product_image_swatch_style = section.settings.product_image_swatch_style
    elsif settings.product_image_swatch_style != blank
      assign product_image_swatch_style = settings.product_image_swatch_style
    endif
    
    assign swatch_size = blank
    if block != blank and block.settings != blank and block.settings.product_image_swatch_size != blank
      assign swatch_size = block.settings.product_image_swatch_size
    elsif section != blank and section.settings != blank and section.settings.product_image_swatch_size != blank
      assign swatch_size = section.settings.product_image_swatch_size
    elsif settings.product_image_swatch_size != blank
      assign swatch_size = settings.product_image_swatch_size
    endif
    
    assign show_horizontal_scroll = false
    if block != blank and block.settings != blank and block.settings.show_horizontal_scroll
      assign show_horizontal_scroll = true
    elsif section != blank and section.settings != blank and section.settings.show_horizontal_scroll
      assign show_horizontal_scroll = true
    elsif settings.show_horizontal_scroll
      assign show_horizontal_scroll = true
    endif
  -%}
  <product-swatches
    data-product-id="{{ closest.product.id }}"
    data-product-url="{{ closest.product.url }}"
    style="
      --overflow-list-alignment: {{ block_settings.product_swatches_alignment }};
      --overflow-list-alignment-mobile: {{ block_settings.product_swatches_alignment_mobile }};
      --product-swatches-alignment: {% if block_settings.product_swatches_alignment == 'flex-start' %}start{% elsif block_settings.product_swatches_alignment == 'flex-end' %}end{% else %}center{% endif %};
      --product-swatches-alignment-mobile: {% if block_settings.product_swatches_alignment_mobile == 'flex-start' %}start{% elsif block_settings.product_swatches_alignment_mobile == 'flex-end' %}end{% else %}center{% endif %};
      --product-swatches-padding-block-start: {{ block_settings.product_swatches_padding_top }}px;
      --product-swatches-padding-block-end: {{ block_settings.product_swatches_padding_bottom }}px;
      --product-swatches-padding-inline-start: {{ block_settings.product_swatches_padding_left }}px;
      --product-swatches-padding-inline-end: {{ block_settings.product_swatches_padding_right }}px;
      --product-image-swatch-size: {{ swatch_size }}px;
    "
    {{ block.shopify_attributes }}
  >
    {%- comment -%} Use combined listing swatches (shows all swatches from all linked products) {%- endcomment -%}
    {% render 'variant-combined-listing-swatches', product_resource: closest.product, block: block, section: section %}
  </product-swatches>
{% endif %}

{% # theme-check-disable %}
{% stylesheet %}
  product-swatches {
    width: 100%;
    display: flex;
    position: relative;
    overflow: visible;
    gap: 0;
    flex-shrink: 0;
    /* Add padding to prevent border clipping - account for max border width (10px) + focus outline */
    padding: calc(var(--style-border-swatch-width, 1px) + var(--focus-outline-width, 2px) + 1px);
    margin: calc(-1 * (var(--style-border-swatch-width, 1px) + var(--focus-outline-width, 2px) + 1px));
  }

  swatches-variant-picker-component {
    display: flex;
    width: 100%;
    flex-direction: row;
    justify-content: var(--product-swatches-alignment-mobile);

    @media (min-width: 750px) {
      justify-content: var(--product-swatches-alignment);
    }
  }

  swatches-variant-picker-component .variant-option--swatches {
    padding-block: calc(
        var(--product-swatches-padding-block-start) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px)
      )
      calc(var(--product-swatches-padding-block-end) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px));
    padding-inline: calc(
        var(--product-swatches-padding-inline-start) + var(--focus-outline-offset) + (1.5 * var(--focus-outline-width)) + var(--style-border-swatch-width, 1px)
      )
      calc(var(--product-swatches-padding-inline-end) + var(--focus-outline-offset) + var(--focus-outline-width) + var(--style-border-swatch-width, 1px));
  }

  .variant-option--swatches {
    overflow-list::part(list) {
      gap: var(--gap-sm);
    }

    overflow-list[defer]::part(list) {
      flex-wrap: nowrap;
    }
  }

  .hidden-swatches__count {
    display: flex;
    align-self: center;
    align-items: center;
    justify-content: center;
    color: rgb(var(--color-foreground-rgb) / var(--opacity-40-60));
    background-color: transparent;
    padding: 0;
    border: 0;
    border-radius: 0;

    &::before {
      /* This doesn't work in Safari without the counter-reset. https://stackoverflow.com/a/40179718 */
      counter-reset: overflow-count var(--overflow-count);
      content: '+' counter(overflow-count);
      line-height: 1;
      cursor: pointer;
    }
  }

  .hidden-swatches__count:hover {
    color: var(--color-foreground-rgb);
  }

  /* Product Image Swatch Styles */
  .variant-option__button-label--product-image {
    --swatch-size: var(--product-image-swatch-size, 60px);
    width: var(--swatch-size);
    height: var(--swatch-size);
    padding: 0;
    border: var(--focus-outline-width) solid rgb(var(--color-foreground-rgb) / 0.2);
    overflow: hidden;
    background: var(--color-background);
  }

  .variant-option__button-label--product-image .swatch {
    width: 100%;
    height: 100%;
    border-radius: 0;
    background-size: contain !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
  }

  .variant-option__button-label--product-image .swatch__image {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* Circle layout */
  .variant-option__button-label--product-image-circle {
    border-radius: 50% !important;
  }

  .variant-option__button-label--product-image-circle .swatch {
    border-radius: 50% !important;
  }

  /* Square layout */
  .variant-option__button-label--product-image-square {
    border-radius: var(--border-radius, 4px) !important;
  }

  .variant-option__button-label--product-image-square .swatch {
    border-radius: var(--border-radius, 4px) !important;
  }

  /* Selected state for product image swatches */
  .variant-option__button-label--product-image:has(:checked) {
    border-color: var(--color-foreground);
    border-width: calc(var(--focus-outline-width) * 1.5);
  }

  /* Ensure circle stays round when selected */
  .variant-option__button-label--product-image-circle:has(:checked) {
    border-radius: 50% !important;
  }

  /* Ensure square stays square when selected */
  .variant-option__button-label--product-image-square:has(:checked) {
    border-radius: var(--border-radius, 4px) !important;
  }

  /* Hover state for product image swatches */
  .variant-option__button-label--product-image:hover {
    border-color: rgb(var(--color-foreground-rgb) / 0.5);
  }

  /* Ensure circle stays round on hover */
  .variant-option__button-label--product-image-circle:hover {
    border-radius: 50% !important;
  }

  /* Ensure square stays square on hover */
  .variant-option__button-label--product-image-square:hover {
    border-radius: var(--border-radius, 4px) !important;
  }
  
  .variant-option__swatch-label {
    display: block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    text-align: center;
    color: rgb(var(--color-foreground));
    line-height: 1.2;
    width: 100%;
    max-width: var(--product-image-swatch-size, 60px);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .variant-option__swatch:has(.variant-option__swatch-label) {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .variant-option__current-variant-name {
    display: block;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-align: center;
    color: rgb(var(--color-foreground));
    line-height: 1.2;
    min-height: 1.2em;
  }

  .variant-option__button-label--product-image,
  .variant-option__button-label--product-image-circle,
  .variant-option__button-label--product-image-square {
    aspect-ratio: 1 / 1 !important;
    width: var(--product-image-swatch-size, 60px) !important;
    height: var(--product-image-swatch-size, 60px) !important;
    min-width: var(--product-image-swatch-size, 60px) !important;
    min-height: var(--product-image-swatch-size, 60px) !important;
    max-width: var(--product-image-swatch-size, 120px) !important;
    max-height: var(--product-image-swatch-size, 120px) !important;
  }
{% endstylesheet %}
{% # theme-check-enable %}
